const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooControls:doodooControls}=doodooLib;function Composition(t,e){const o=this;let n,l,a,i,s,{MIDI_NOTES:r}=t;function c(t){t.forEach((t=>{if(null===t)return o.addNote("rest",data.duration,!0);const e="string"==typeof t?t:t[0],n="string"==typeof t?data.duration:t[1];null===e?o.addNote("rest",n,!0):o.addNote(e,n,!0)}))}this.tonic=e.tonic,this.transform=e.transform||e.tonic,this.bpm=e.bpm,this.voices=[],this.scale=e.scale,this.title=e.title,this.duration=e.duration,this.parts=[],this.simultaneous=e.simultaneous,this.useMetro=!1,this.currentPart=0,this.partRows=[],this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){o.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",o.uiScale)},this.setNoteWidth=function(t){o.noteWidth=t,o.partRows[0]&&o.updateDisplay()},this.init=function(){l=t.ui.panels.composition.scaleRow,s=t.ui.panels.composition.voiceRow,o.partRows[0]=t.ui.panels.melody.addRow("part-0","break-line-up"),o.partRows[0].addClass("part"),a=t.ui.panels.melody.melodyInput.noteInput,i=t.ui.panels.melody.melodyInput.durationInput,o.setUIScale(o.uiScale)},this.updateScale=function(){l.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:o.scale[t],min:-11,max:11,callback:e=>{o.scale[t]=+e}});l.append(e,t)}},this.play=function(e){if(0===o.parts.length)return alert("Add notes to the melody.");o.update(),n&&(n.stop(),Tone.Transport.cancel());const l=o.get();n=new Doodoo({...l,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e,t.score.update(n.getLoops())},useMetro:o.useMetro,controls:t.controls.get()}),n.play(),t.fio.saveLocal(l),t.score.update(n.getLoops())},this.isRecording=function(){return!!n&&n.isRecording()},this.stop=function(){n&&n.stop()},this.mutate=function(){n&&n.mutate()},this.update=function(){function t(t){let e=!1;const o=Array.from(t).map((t=>{let o,n=t.note.value,l=t.duration.value;return["null","rest"].includes(n)?o=null:(o=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),o=t[t.length-1],n=t.includes("#")?"#":"";return!(isNaN(+o)||!"ABCDEFG".includes(e))&&e+n+o}(n),o||(e=!0)),l.length>3&&(e=!0),isNaN(+l[0])&&(e=!0),1===l.length&&(l+="n"),[o,l]}));return e?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):o}if(o.parts=[],o.partRows.length>1)for(let e=0;e<o.partRows.length;e++)o.parts.push(t(o.partRows[e].children));else o.parts=t(o.partRows[0].children)},this.addNote=function(t,e,n){let l=t||a.value.toUpperCase(),s=e||i.value,c=new UICollection({class:"note-collection"});c.addClass("d"+s.replace(/\./g,"dot"));let p=new UIListStep({value:l,class:"note-edit",list:[...r,"null","rest"]}),u=new UIListStep({value:s,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=o.duration,u.value=t),c.el.className="note-collection d"+t.replace(/\./g,"dot"),o.update(),o.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),d=new UIButton({text:"x",class:"remove-btn",callback:()=>{o.partRows[o.currentPart].remove(c),o.update(),o.updateDisplay()}});c.append(p,"note"),c.append(u,"duration"),c.append(d),o.partRows[o.currentPart].append(c),n||o.update(),n||o.updateDisplay()},this.addPart=function(){console.log("add part");let e=t.ui.panels.melody.addRow("part-"+o.partRows.length,"break-line-up");e.addClass("part"),o.partRows.push(e),o.currentPart=o.partRows.length-1,t.ui.faces.currentPart.addOption(o.currentPart,!0,"Part "+o.currentPart)},this.addVoice=function(t){if(Array.isArray(o.voices)||(o.voices=[o.voices]),o.voices.includes(t))return;o.voices.push(t);const e=new UICollection({class:"voice-collection"});e.append(new UILabel({text:t})),e.append(new UIButton({text:"X",callback:()=>{o.voices.splice(o.voices.indexOf(t),1),s.remove(e)}})),s.append(e)},this.updateDisplay=function(){o.parts.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,n=o.partRows.length>1?o.parts.flatMap((t=>t.map((t=>t[1])))):o.parts.flatMap((t=>t[1]));let l=Math.max(...n.map((t=>parseInt(t))));n.includes(l+"n."),l<0&&(l="4n");let a=4;for(;e/a>o.noteWidth;)a+=4;t.ui.panels.melody.setProp("--column-width",Math.floor(e/a)),t.ui.panels.melody.setProp("--notes-per-row",a),t.ui.panels.melody.setProp("--default-duration",l)},this.clear=function(){o.partRows.forEach((t=>t.clear()))},this.get=function(){return o.update(),{parts:o.parts,tonic:o.tonic,transform:o.transform,bpm:o.bpm,voices:o.voices,title:this.title,duration:this.duration,scale:this.scale,simultaneous:this.simultaneous}},this.load=function(n){if(n.title&&t.ui.faces.title.update(n.title),n.transform&&t.ui.faces.transform.update(n.transform),n.bpm&&t.ui.faces.bpm.update(n.bpm),n.duration&&t.ui.faces.duration.update(n.duration),n.voices){(Array.isArray(n.voices)?[...n.voices]:[n.voices]).forEach((t=>{o.addVoice(t)}))}else e.voices.forEach((t=>{o.addVoice(t)}));var l;if(n.tonic&&t.ui.faces.tonic.update("string"==typeof n.tonic?n.tonic:(l=n.tonic,r[l])),n.scale&&(o.scale=n.scale.map((t=>+t))),o.updateScale(),n.parts){if(o.clear(),o.parts=[],Array.isArray(n.parts[0]))if(Array.isArray(n.parts[0][0]))for(let e=0;e<n.parts.length;e++){if(o.currentPart=e,e>0){let n=t.ui.panels.melody.addRow("part-"+e,"break-line-up");n.addClass("part"),o.partRows.push(n)}c(n.parts[e])}else c(n.parts);o.currentPart=0}o.update(),o.updateDisplay()}}function Controls(t,e,o){let n={...e};const l={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function a(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function i(t,o){const{key:n,type:l}=t,i=a(n);o.append(new UILabel({text:i})),o.append(new UIButton({text:"Reset",callback:()=>{s(n,o)}})),"range"===l&&function(t,e,o){let{key:n,value:l,range:a,step:i}=t;o&&e.append(new UILabel({text:o}));if(c({...t,index:0},e,"Min"),c({...t,index:1},e,"Max"),l.length>2){let o=a.length<=2?[0,1]:a.slice(2);r({...t,range:o,index:2},e,"Min Update"),r({...t,range:o,index:3},e,"Max Update")}}(t,o),"list"===l&&t.value&&function(t,o,n){let{key:l,value:a}=t;n&&o.append(new UILabel({text:n}));o.append(new UINumberList({list:a,callback:t=>{e[l]=t}}))}(t,o),"chance"===l&&r(t,o),"number"===l&&c(t,o)}function s(t,l,a){const s=o.filter((e=>e.key===t))[0];void 0===a&&(a=Array.isArray(n[t])?[...n[t]]:n[t]),e[t]=a,s.value=a,l.clear(),i(s,l)}function r(t,o,n){let{key:l,value:a,index:i,range:s}=t;n&&o.append(new UILabel({text:n})),o.append(new UIChance({label:"Chance",value:void 0!==i?a[i]:a,min:s?s[0]:0,max:s?s[1]:1,step:.01,callback:t=>{void 0!==i?e[l][i]=t:e[l]=t}}))}function c(t,o,n){let{key:l,value:a,range:i,step:s,index:r}=t;n&&o.append(new UILabel({text:n})),o.append(new UINumberStep({value:void 0!==r?a[r]:a,min:i[0],max:i[1],step:t.step||1,callback:t=>{void 0!==r?e[l][r]=t:e[l]=t}}))}function p(t){const o=t.value,n=new UILabel({text:"Counts"});startLoopsRow.append(n);const l=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),startLoopsRow.removeK("count"+e.startLoops.length)}});startLoopsRow.append(l);const a=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),u(e.startLoops.length-1,t)}});startLoopsRow.append(a);for(let t=0;t<o.length;t++)u(t,o[t])}function u(t,o){const n=new UIRow({class:"break-line-up"});startLoopsRow.append(n,"count"+t);const l=new UILabel({text:"Count "+t});n.append(l);const a=new UILabel({text:"Loops"});n.append(a);const i=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),n.removeK("loop"+e.startLoops[t].length)}});n.append(i);const s=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),d(t,e.startLoops[t].length-1,{},n)}});n.append(s);for(let e=0;e<o.length;e++)d(t,e,o[e],n)}function d(t,e,o,n){const a=new UIRow;n.append(a,"loop"+e);const i=new UILabel({text:"Loop "+e});a.append(i);const s=new UISelectButton({options:Object.keys(l),class:"break",callback:o=>{f(o,l[o],t,e,a)}});a.append(s);for(const n in o)f(n,o[n],t,e,a)}function f(t,o,n,l,i){let s=a(t);switch(typeof o){case"boolean":let a=new UIToggleCheck({label:s,value:o,callback:o=>{e.startLoops[n][l][t]=o}});i.append(a);break;case"number":let r=new UILabel({text:s});i.append(r);let c=new UINumberStep({value:o,callback:o=>{e.startLoops[n][l][t]=o}});i.append(c)}i.append(new UILabel({class:"break"}))}this.resetControls=function(){let e=o.findIndex((t=>"fxLimit"===t.key));for(let n=0;n<e;n++){const{key:e,panel:l}=o[n];"loops"!==e&&s(e,t.ui.panels[l]["row-"+e])}},this.resetEffects=function(){for(let e=o.findIndex((t=>"fxLimit"===t.key));e<o.length;e++){const{key:n,panel:l}=o[e];s(n,t.ui.panels[l]["row-"+n])}},this.zeroEffects=function(){for(let e=o.findIndex((t=>"fxLimit"===t.key));e<o.length;e++){const{key:n,panel:l}=o[e];n.includes("Chance")&&s(n,t.ui.panels[l]["row-"+n],0)}},this.init=function(e){startLoopsRow=t.ui.panels.loops.startLoops},this.load=function(n){if(n)for(let t=0;t<o.length;t++){const{key:l,type:a}=o[t];if(void 0!==n[l])switch(e[l]=n[l],a){case"list":for(const e in n[l])o[t][e]=n[l][e];break;case"effect":o[t].chance=n[l+"Chance"],o[t].delay=n[l+"Delay"];break;default:o[t].value=n[l]}}const l=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let e=0;e<o.length;e++){const n=o[e];let s;if(n.panel){const e=n.panel;if(t.ui.panels[e]||t.ui.createPanel(e,{label:a(e)+" Control"}),s=t.ui.panels[e].addRow("row-"+n.key),s.addClass("break-line-up"),l[e]){const{gridArea:o}=l[e],n=t.ui.panels[e];n.setup(l[e]),t.ui.layout[o].panels.append(n)}}"loops"===n.type?p(n):i(n,s)}},this.get=function(){return{...e}}}function FilesIO(t){this.load=function(e){t.composition.load(e),t.controls.load(e.controls)},this.saveLocal=function(e,o){e||(e=t.composition.get()),o||(o=t.controls.get()),localStorage.setItem("comp",JSON.stringify({...e,controls:o}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){if(t.composition.isRecording())return;t.composition.update();const e=localStorage.getItem("comp"),o=new Blob([e],{type:"application/x-download;charset=utf-8"}),n=prompt("Name composition",t.composition.title);n&&(saveAs(o,n+".json"),t.ui.faces.title.update(n))},this.loadMidi=function(e,o,n){new Midi.fromUrl(n).then((e=>{e.tracks.forEach((e=>{const o=e.notes;for(let e=0;e<o.length;e++){const{name:n,duration:l,time:a}=o[e];let i=n,s=e===o.length-1;if(e>0){const n=o[e-1];let l=a-(n.time+n.duration);l>0&&t.composition.addNote("rest",Tone.Time(l).toNotation(),s)}t.composition.addNote(i,Tone.Time(l).toNotation(),s)}}))}))}}function Score(t){const{MIDI_NOTES:e}=t,o=document.createElement("canvas");let n,l;if(!o.getContext("2d"))return;l=o.getContext("2d");let a=20,i=12,s="CDEFGAB".split(""),r=["F","C","G","D","A","E","B"],c=["B","E","A","D","G","C","F"],p={G:["#",1],D:["#",2],A:["#",3],E:["#",4],B:["#",5],"F#":["#",6],"C#":["#",7],F:["b",1],Bb:["b",2],Eb:["b",3],Ab:["b",4],Db:["b",5],Gb:["b",6],Cb:["b",7]},u={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B",Eb:"Gb","D#":"F#",Bb:"Db",F:"Ab",C:"Eb",G:"Bb",D:"F"},d=["G","F","E","D","C","B","A"],f=new FontFace("Noto","url(https://fonts.gstatic.com/s/notomusic/v14/pe0rMIiSN5pO63htf1sxEkW7I9tAcVwo.woff2)"),h=!1;function m(t,e,o,n){l.beginPath(),l.moveTo(t,e),l.lineTo(o,n),l.stroke()}function g(t,e){let o=t[0],n=+t[t.length-1],l=e[0],a=+e[e.length-1];return s.indexOf(o)-s.indexOf(l)+7*(n-a)}function b(s){console.log("loops",s);let{width:f,height:h}=n.el.getBoundingClientRect();const{tonic:b,scale:w}=t.composition,y=e.indexOf(b),I=w.map((t=>{let o=e[y+t];return o.substring(0,o.length-1)}));let v=b.substring(0,b.length-1);w.includes(3)&&!w.includes(4)&&(v=u[v]);let x=p[v],k="#"===x[0]?r.slice(0,x[1]):c.slice(0,x[1]),C=16,L=32+k.length*C,R=L,S=a,M=f-8-L-20,U=0===s.length?4:Math.max(...s.flatMap((t=>t.melody.map((t=>+t[1][0]))))),D=Math.max(...s.map((t=>t.len))),E=Math.ceil(D/U),N=s.flatMap((t=>t.melody)).map(((t,e)=>[t[0]?t[0].substring(0,t[0].length-1):null,Math.floor(e%D/U)])).filter((t=>null!==t[0])).filter((t=>!I.includes(t[0]))),P=N.length,A=[];for(let t=0;t<E;t++)A[t]=N.filter((e=>e[1]===t)).length;let T=1,B=1+E+E*U+P,O=[B];if(M>D*C+E*C+P*C)C=Math.floor(M/B);else{O=[0];for(let t=0;t<E;t++){let e=U+A[t]+1,o=e*C;O[T-1]*C+o<M?O[T-1]+=e:(T++,O.push(e))}}o.width=f-8,o.height=144*T+40,l.fillStyle="lightgray",l.fillRect(0,0,o.width,o.height),l.fillStyle="black",l.strokeStyle="black";for(let t=0;t<T;t++){let e=a+144*t,o=32;l.strokeStyle="gray";for(let t=0;t<11;t++){let o=a+t*i+i;5!==t&&m(10,e+o,f-10-8,e+o)}l.fillStyle="black",l.font="60px serif",l.fillText("𝄞",10,e+a+54),l.font="36px serif",l.fillText("𝄢",10,e+a+114),l.font="18px serif",k.forEach((t=>{let n=32+e+6*d.indexOf(t);l.fillText("♯",o,n),l.fillText("♯",o,n+84),o+=16}))}if(0===s.length)return;let F=R+C,G=0,_=0,W=0,V=O[W];for(let t=0;t<=D;t++){let e=C;if(W<T-1&&(e=Math.floor(M/O[W])),t===D){l.fillStyle="black",l.fillRect(F-e/2,S+a+i,6,48),l.fillRect(F-e/2,S+a+84,6,48);continue}if(t>0&&t+_>V-1&&(W++,S+=144,F=R+C,V+=O[W]),t===D){l.fillStyle="black",l.fillRect(F,S+a+i,6,48),l.fillRect(F,S+a+84,6,48);continue}let o=[],n=[];for(let e=0;e<s.length;e++){let{startDelay:l,startIndex:a,doubler:i,repeat:r,melody:c}=s[e],p=(t-l+a)%c.length;c[p]&&(o.push(c[p]),n.push(c.slice(p-G,p+(U-G))))}if(o.every((t=>null===t[0]))){let t=!1;if(l.font="26px Noto",n.flatMap((t=>t)).every((t=>null===t[0]))&&0===tempCount&&(l.fillText("𝄻",F+e,S+132),t=!0),n.forEach((e=>{e.forEach(((e,o)=>{o<G&&o+U/parseInt(e[1])>G&&(t=!0)}))})),!t){let t=U/4*2,o=G%t,a=G>=t?1:0,i=n.map((e=>e.slice(t*a,t+t*a)));i.flatMap((t=>t)).every((t=>null===t[0]))?0===o&&l.fillText("𝄼",F+e,S+132):o%2==0?i.filter((t=>t[o+1])).every((t=>null===t[o+1][0]))?l.fillText("𝄽",F+e/2,S+138):l.fillText("𝄾",F,S+138):i.filter((t=>t[o-1])).every((t=>null!==t[o-1][0]))&&l.fillText("𝄾",F,S+138)}G++}else l.strokeStyle="black",o.forEach((t=>{let[o,i]=t;if(null===o)return;let s=a+S+72+6*g("C4",o),r=o.substring(0,o.length-1);if(I.includes(r)||(l.font="18px sans-serif",o.includes("#")?l.fillText("♯",F-e/2,s+8):l.fillText("♮",F-e/2,s+8),F+=e,_++),"1n"===i&&(l.beginPath(),l.ellipse(F,s,5,3,-Math.PI/6,0,2*Math.PI),l.stroke()),"2n"===i&&(l.beginPath(),l.ellipse(F,s,5,3,-Math.PI/6,0,2*Math.PI),l.stroke(),m(F+5,s-1,F+5,s-24)),"4n"===i&&(l.beginPath(),l.ellipse(F,s,6,4,-Math.PI/6,0,2*Math.PI),l.fill(),m(F+5,s-1,F+5,s-24)),"8n"===i){let t=U/4*2,a=G%t,i=G>=t?1:0,r=n.map((e=>e.slice(t*i,t+t*i))),c=72+6*g("C4",o),p=0;for(let o=0;o<t;o++){let t=r.filter((t=>t[o])).map((t=>t[o]));if(o>a&&(t.every((t=>null===t[0]))||t.every((t=>"8n"!==t[1]))))break;t.every((t=>null===t[0]))||(o>a&&(p+=e),t.forEach((t=>{if(null===t[0])return;let e=72+6*g("C4",t[0]);e<c&&(c=e)})))}let u=!1;p>0?l.fillRect(F+5,S+c-6,p,4):u=r.filter((t=>t[a-1])).every((t=>null===t[a-1][0])),m(F+5,s-1,F+5,S+c-6),l.beginPath(),l.ellipse(F,s,6,4,-Math.PI/6,0,2*Math.PI),l.fill(),u&&m(F+5,S+c-6,F+10,S+c+6)}S>80&&S<104&&m(F-12,S+a+72,F+12,S+a+72)})),G++;if(G===U){F+=e,_++;let t=F;l.strokeStyle="black",m(t+e/2,S+a+i,t+e/2,S+a+60),m(t+e/2,S+a+84,t+e/2,S+a+132),G=0}F+=e}}f.load().then((t=>{document.fonts.add(t),console.log("Font loaded"),h=!0})),this.update=function(t){b(t)},this.init=function(){n=t.ui.panels.score,n.el.appendChild(o),b([])}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],duration:"4n",bpm:120,voices:["choir","toms"]};t.controls=new Controls(t,doodooDefaults,doodooControls),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0});t.ui.settings=new Settings(t,"doodoo",void 0,["noteWidth"]),t.fio=new FilesIO(t),t.score=new Score(t),t.ui.load("./interface/panels.json",(()=>{t.ui.settings.load(),t.composition.init(),t.controls.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const o=JSON.parse(e);t.composition.load(o),t.controls.load(o.controls)}else t.composition.load({}),t.controls.load();t.score.init()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
