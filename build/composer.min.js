const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooControls:doodooControls}=doodooLib;function Composition(t,e){const o=this;let n,a,s,l,{MIDI_NOTES:i}=t;function r(t){t.forEach((t=>{if(null===t)return o.addNote("rest",data.duration,!0);const e="string"==typeof t?t:t[0],n="string"==typeof t?data.duration:t[1];null===e?o.addNote("rest",n,!0):o.addNote(e,n,!0)}))}this.tonic=e.tonic,this.transform=e.transform||e.tonic,this.bpm=e.bpm,this.voices=e.voices,this.scale=e.scale,this.title=e.title,this.duration=e.duration,this.parts=[],this.simultaneous=e.simultaneous,this.useMetro=!1,this.currentPart=0,this.partRows=[],this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){o.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",o.uiScale)},this.setNoteWidth=function(t){o.noteWidth=t,o.partRows[0]&&o.updateDisplay()},this.init=function(){a=o.panel.scaleRow,o.partRows[0]=t.ui.panels.melody.addRow("part-0","break-line-up"),o.partRows[0].addClass("part"),s=t.ui.panels.melody.melodyInput.noteInput,l=t.ui.panels.melody.melodyInput.durationInput,o.setUIScale(o.uiScale)},this.updateScale=function(){a.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:o.scale[t],min:-11,max:11,callback:e=>{o.scale[t]=+e}});a.append(e,t)}},this.play=function(e){if(0===o.parts.length)return alert("Add notes to the melody.");o.update(),n&&(n.stop(),Tone.Transport.cancel());const a=o.get();n=new Doodoo({...a,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:o.useMetro,params:t.controls.get()}),n.play(),t.fio.saveLocal(a)},this.isRecording=function(){return n.isRecording()},this.stop=function(){n&&n.stop()},this.mutate=function(){n&&n.mutate()},this.update=function(){function t(t){let e=!1;const o=Array.from(t).map((t=>{let o,n=t.note.value,a=t.duration.value;return["null","rest"].includes(n)?o=null:(o=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),o=t[t.length-1],n=t.includes("#")?"#":"";return!(isNaN(+o)||!"ABCDEFG".includes(e))&&e+n+o}(n),o||(e=!0)),a.length>3&&(e=!0),isNaN(+a[0])&&(e=!0),1===a.length&&(a+="n"),[o,a]}));return e?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):o}if(o.parts=[],o.partRows.length>1)for(let e=0;e<o.partRows.length;e++)o.parts.push(t(o.partRows[e].children));else o.parts=t(o.partRows[0].children)},this.addNote=function(t,e,n){let a=t||s.value.toUpperCase(),r=e||l.value,p=new UICollection({class:"note-collection"});p.addClass("d"+r.replace(/\./g,"dot"));let c=new UIListStep({value:a,class:"note-edit",list:[...i,"null","rest"]}),u=new UIListStep({value:r,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=o.duration,u.value=t),p.el.className="note-collection d"+t.replace(/\./g,"dot"),o.update(),o.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),d=new UIButton({text:"X",class:"remove-btn",callback:()=>{o.partRows[o.currentPart].remove(p),o.update(),o.updateDisplay()}});p.append(c,"note"),p.append(u,"duration"),p.append(d),o.partRows[o.currentPart].append(p),n||o.update(),n||o.updateDisplay()},this.addPart=function(){console.log("add part");let e=t.ui.panels.melody.addRow("part-"+o.partRows.length,"break-line-up");e.addClass("part"),o.partRows.push(e),o.currentPart=o.partRows.length-1,t.ui.faces.currentPart.addOption(o.currentPart,!0,"Part "+o.currentPart)},this.updateDisplay=function(){o.parts.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,n=o.partRows.length>1?o.parts.flatMap((t=>t.map((t=>t[1])))):o.parts.flatMap((t=>t[1]));let a=Math.max(...n.map((t=>parseInt(t))));n.includes(a+"n."),a<0&&(a="4n");let s=4;for(;e/s>o.noteWidth;)s+=4;t.ui.panels.melody.setProp("--column-width",Math.floor(e/s)),t.ui.panels.melody.setProp("--notes-per-row",s),t.ui.panels.melody.setProp("--default-duration",a)},this.clear=function(){o.partRows.forEach((t=>t.clear()))},this.get=function(){return o.update(),{parts:o.parts,tonic:o.tonic,transform:o.transform,bpm:o.bpm,voices:o.voices,title:this.title,duration:this.duration,scale:this.scale,simultaneous:this.simultaneous}},this.load=function(e){var n;if(e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(n=e.tonic,i[n])),e.duration&&t.ui.faces.duration.update(e.duration),e.scale&&(o.scale=e.scale.map((t=>+t))),o.updateScale(),e.parts){if(o.clear(),o.parts=[],Array.isArray(e.parts[0]))if(Array.isArray(e.parts[0][0]))for(let n=0;n<e.parts.length;n++){if(o.currentPart=n,n>0){let e=t.ui.panels.melody.addRow("part-"+n,"break-line-up");e.addClass("part"),o.partRows.push(e)}r(e.parts[n])}else r(e.parts);o.currentPart=0}o.update(),o.updateDisplay()}}function Controls(t,e,o){let n={...e};const a={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function s(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function l(t,o){const{key:n,type:a}=t,l=s(n);o.append(new UILabel({text:l})),o.append(new UIButton({text:"Reset",callback:()=>{i(n,o)}})),"range"===a&&function(t,e,o){let{key:n,value:a,range:s,step:l}=t;o&&e.append(new UILabel({text:o}));if(p({...t,index:0},e,"Min"),p({...t,index:1},e,"Max"),a.length>2){let o=s.length<=2?[0,1]:s.slice(2);r({...t,range:o,index:2},e,"Min Update"),r({...t,range:o,index:3},e,"Max Update")}}(t,o),"list"===a&&t.value&&function(t,o,n){let{key:a,value:s}=t;n&&o.append(new UILabel({text:n}));o.append(new UINumberList({list:s,callback:t=>{e[a]=t}}))}(t,o),"chance"===a&&r(t,o),"number"===a&&p(t,o)}function i(t,a){const s=o.filter((e=>e.key===t))[0],i=Array.isArray(n[t])?[...n[t]]:n[t];e[t]=i,s.value=i,a.clear(),l(s,a)}function r(t,o,n){let{key:a,value:s,index:l,range:i}=t;n&&o.append(new UILabel({text:n})),o.append(new UIChance({label:"Chance",value:void 0!==l?s[l]:s,min:i?i[0]:0,max:i?i[1]:1,step:.01,callback:t=>{void 0!==l?e[a][l]=t:e[a]=t}}))}function p(t,o,n){let{key:a,value:s,range:l,step:i,index:r}=t;n&&o.append(new UILabel({text:n})),o.append(new UINumberStep({value:void 0!==r?s[r]:s,min:l[0],max:l[1],step:t.step||1,callback:t=>{void 0!==r?e[a][r]=t:e[a]=t}}))}function c(t){const o=t.value,n=new UILabel({text:"Counts"});startLoopsRow.append(n);const a=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),startLoopsRow.removeK("count"+e.startLoops.length)}});startLoopsRow.append(a);const s=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),u(e.startLoops.length-1,t)}});startLoopsRow.append(s);for(let t=0;t<o.length;t++)u(t,o[t])}function u(t,o){const n=new UIRow({class:"break-line-up"});startLoopsRow.append(n,"count"+t);const a=new UILabel({text:"Count "+t});n.append(a);const s=new UILabel({text:"Loops"});n.append(s);const l=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),n.removeK("loop"+e.startLoops[t].length)}});n.append(l);const i=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),d(t,e.startLoops[t].length-1,{},n)}});n.append(i);for(let e=0;e<o.length;e++)d(t,e,o[e],n)}function d(t,e,o,n){const s=new UIRow;n.append(s,"loop"+e);const l=new UILabel({text:"Loop "+e});s.append(l);const i=new UISelectButton({options:Object.keys(a),class:"break",callback:o=>{f(o,a[o],t,e,s)}});s.append(i);for(const n in o)f(n,o[n],t,e,s)}function f(t,o,n,a,l){let i=s(t);switch(typeof o){case"boolean":let s=new UIToggleCheck({label:i,value:o,callback:o=>{e.startLoops[n][a][t]=o}});l.append(s);break;case"number":let r=new UILabel({text:i});l.append(r);let p=new UINumberStep({value:o,callback:o=>{e.startLoops[n][a][t]=o}});l.append(p)}l.append(new UILabel({class:"break"}))}this.resetParams=function(){let e=0;for(let t=0;t<o.length;t++)if("fxLimit"===o[t].key){e=t;break}for(let n=0;n<e;n++){const{key:e,panel:a}=o[n];"loops"!==e&&i(e,t.ui.panels[a]["row-"+e])}},this.resetEffects=function(){let e=0;for(let t=0;t<o.length;t++)if("fxLimit"===o[t].key){e=t;break}for(let n=e;n<o.length;n++){const{key:e,panel:a}=o[n];i(e,t.ui.panels[a]["row-"+e])}},this.init=function(e){startLoopsRow=t.ui.panels.loops.startLoops},this.load=function(n){n&&o.forEach((t=>{if(void 0!==n[t.key])if(e[t.key]=n[t.key],"list"===t.type)for(const e in n[t.key])t[e]=n[t.key][e];else t.value=n[t.key]}));const a=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let e=0;e<o.length;e++){const n=o[e];let i;if(n.panel){const e=n.panel;if(t.ui.panels[e]||t.ui.createPanel(e,{label:"Param "+s(e)}),i=t.ui.panels[e].addRow("row-"+n.key),i.addClass("break-line-up"),a[e]){const{gridArea:o}=a[e],n=t.ui.panels[e];n.setup(a[e]),t.ui.layout[o].panels.append(n)}}"loops"===n.type?c(n):l(n,i)}},this.get=function(){return{...e}}}function FilesIO(t){this.load=function(e){t.composition.load(e),t.controls.load(e.controls)},this.saveLocal=function(e,o){e||(e=t.composition.get()),o||(o=t.controls.get()),localStorage.setItem("comp",JSON.stringify({...e,controls:o}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){if(t.composition.isRecording())return;t.composition.update();const e=localStorage.getItem("comp"),o=new Blob([e],{type:"application/x-download;charset=utf-8"}),n=prompt("Name composition",t.composition.title);n&&(saveAs(o,n+".json"),t.ui.faces.title.update(n))},this.loadMidi=function(e,o,n){new Midi.fromUrl(n).then((e=>{e.tracks.forEach((e=>{const o=e.notes;for(let e=0;e<o.length;e++){const{name:n,duration:a,time:s}=o[e];let l=n,i=e===o.length-1;if(e>0){const n=o[e-1];let a=s-(n.time+n.duration);a>0&&t.composition.addNote("rest",Tone.Time(a).toNotation(),i)}t.composition.addNote(l,Tone.Time(a).toNotation(),i)}}))}))}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],duration:"4n",bpm:120,voices:["choir"]};t.controls=new Controls(t,doodooDefaults,doodooControls),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0});t.ui.settings=new Settings(t,"doodoo",void 0,["noteWidth"]),t.fio=new FilesIO(t),t.ui.load("./interface/interface.json",(()=>{t.ui.settings.load(),t.composition.init(),t.controls.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const o=JSON.parse(e);t.composition.load(o),t.controls.load(o.controls)}else t.composition.load({}),t.controls.load()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
