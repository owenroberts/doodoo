!function(){"use strict";const{MIDI_NOTES:e}=DoodooMidi,{defaults:t,controls:n}=DoodooControls,{props:a}=DoodooProps,{Interface:l,Settings:o}=UI,{UIElement:c,UICollection:s,UIButton:i,UILabel:r,UINumberStep:d,UIListStep:u,UIChance:p,UINumberList:f,UISelectButton:k,UIText:b,UIRow:h,UIToggleCheck:g,UIFile:m,UIInput:w,UIInputList:x,UITree:y,UIToggleGrid:v,UISelect:I,UIList:C,UIListAdd:P}=UI.Elements,S={},L={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],beat:"4n",bpm:120,instruments:["choir"]};S.controls=new function(e,t,n){let a,l,o,c={},s=JSON.parse(JSON.stringify(t));const u={noteDuration:4,count:0,beatCount:1,repeat:1,startIndex:0,startDelay:0,harmony:0,voice:"choir",voiceAttack:.1,voiceRelease:1,voiceCurve:"linear"};function m(e){let t=e[0].toUpperCase()+e.substring(1);return t=t.replace(/(?<=[a-z])(?=[A-Z])/g," "),t}function w(e,n){const{key:a,type:l}=e;n.add(new i({text:"Reset",callback:()=>{v(a,n)}})),n.addBreak(),"range"===l&&function(e,t,n){let{key:a,value:l,range:o,step:c}=e;n&&t.add(new r({text:n}));if(C({...e,index:0},t,"Min"),C({...e,index:1},t,"Max"),l.length>2){let n=o.length<=2?[0,1]:o.slice(2);I({...e,range:n,index:2},t,"Min"),I({...e,range:n,index:3},t,"Max")}}(e,n),"list"===l&&e.value&&function(e,n,a){let{key:l,value:o}=e;a&&n.add(new r({text:a}));"number"==typeof o[0]?n.add(new f({list:o,callback:e=>{t[l]=e}})):n.add(new x({list:o,callback:e=>{t[l]=e}}))}(e,n),"chance"===l&&I(e,n),"number"===l&&C(e,n),"walker"===l&&function(e,t,n){let{key:a,value:l}=e;n&&t.add(new r({text:n}));C({...e,index:0},t),t.add(new r({text:"Walker",class:"break"})),C({...e,index:1},t,"Step"),I({...e,index:2},t),C({...e,index:3},t,"Min"),C({...e,index:4},t,"Max"),C({...e,index:5,range:[-1,1],step:.1},t,"Dir")}(e,n),n.addBreak()}function v(e,a,l){const o=n.filter((t=>t.key===e))[0];o&&(void 0===l&&(l=Array.isArray(s[e])?[...s[e]]:s[e]),t[e]=l,o.value=l,a||(a=c[e]),a.clear(),w(o,a))}function I(e,n,a){let{key:l,value:o,index:c,range:s}=e;a&&n.add(new r({text:a})),n.add(new p({label:"Chance",value:void 0!==c?o[c]:o,min:s?s[0]:0,max:s?s[1]:1,step:.01,callback:e=>{void 0!==c?t[l][c]=e:t[l]=e}}))}function C(e,n,a){let{key:l,value:o,range:c,step:s,index:i}=e;a&&n.add(new r({text:a})),n.add(new d({value:void 0!==i?o[i]:o,min:c?c[0]:0,max:c?c[1]:100,step:e.step||1,callback:e=>{void 0!==i?t[l][i]=e:t[l]=e}}))}function P(e,n){const a=e.value,l=new r({text:"Counts"});n.add(l);const o=new i({text:"–",class:"left-end",callback:()=>{t.startLoops.pop(),n.removeK("count"+t.startLoops.length)}});n.add(o);const c=new i({text:"+",class:"right-end",callback:()=>{const e=[{}];t.startLoops.push(e),S(t.startLoops.length-1,e,n)}});n.add(c);for(let e=0;e<a.length;e++)S(e,a[e],n)}function S(e,n,a){const l=new h({class:"break-line-up"});a.add(l,"count"+e);const o=new r({text:"Count "+e});l.add(o);const c=new r({text:"Loops"});l.add(c);const s=new i({text:"–",class:"left-end",callback:()=>{t.startLoops[e].pop(),l.removeK("loop"+t.startLoops[e].length)}});l.add(s);const d=new i({text:"+",class:"right-end",callback:()=>{t.startLoops[e].push({}),L(e,t.startLoops[e].length-1,{},l)}});l.add(d);for(let t=0;t<n.length;t++)L(e,t,n[t],l)}function L(e,t,n,a){const l=new h;a.append(l,"loop"+t);const o=new r({text:"Loop "+t});l.append(o);const c=new k({options:Object.keys(u),callback:n=>{U(n,u[n],e,t,l)}});l.append(c);for(const a in n)U(a,n[a],e,t,l)}function U(e,n,a,l,o){let c=m(e);switch(typeof n){case"boolean":let s=new g({value:n,callback:n=>{t.startLoops[a][l][e]=n}});o.append(new r({text:c})),o.append(s),t.startLoops[a][l][e]=n;break;case"number":let i=new d({value:n,callback:n=>{t.startLoops[a][l][e]=n}});o.append(new r({text:c})),o.append(i),t.startLoops[a][l][e]=n;break;case"string":let u=new b({value:n,callback:n=>{t.startLoops[a][l][e]=n}});o.append(new r({text:c})),o.append(u),t.startLoops[a][l][e]=n}o.append(new r({class:"break"}))}function M(){let e=n.findIndex((e=>"fxLimit"===e.key));for(let t=0;t<e;t++){const{key:e,panel:a}=n[t];"loops"!==e&&v(e)}}function O(){for(let e=n.findIndex((e=>"fxLimit"===e.key));e<n.length;e++){const{key:t,panel:a}=n[e];v(t)}}function T(){for(let e=n.findIndex((e=>"fxLimit"===e.key));e<n.length;e++){const{key:t,panel:a}=n[e];t.includes("Chance")&&v(t,void 0,0)}}return{get:function(){return{...t}},load:function(e){if(e)for(const n in e){e[n];"startLoops"===n?(a.clear(),t.startLoops=e[n],P({value:e[n]},a)):v(n,void 0,e[n])}else{let e=!1;for(let t=0;t<n.length;t++){const s=n[t],{key:i,type:r}=s;if("loops"===r)P(s,a);else{"fxLimit"===i&&(e=!0);const t=new y({title:m(i)});c[i]=t,e?o.append(t):l.append(t),w(s,t)}}}},connect:function(){l=e.ui.getPanel("controls"),o=e.ui.getPanel("Effects");const t=e.ui.getPanel("loops",{label:"Start Loops"});e.ui.addCallbacks([{callback:M,text:"Reset Controls"}],l),e.ui.addCallbacks([{callback:O,text:"Reset Effects"},{callback:T,text:"Zero Effects"}],o),a=t.addRow("start-loops-row")}}}(S,t,n),S.composition=new function(t,n){let a,l,o,c,u=n.title,p=n.tonic,b=n.duration,g=n.bpm,m=n.transpose||n.tonic,w=n.scale,x=n.useOctave||!1,y=[],v=[[]];function I(e){if(!e)return;if(Array.isArray(y)||(y=[y]),y.includes(e))return;y.push(e);const t=new s({class:"instrument-collection"});t.append(new r({text:e})),t.append(new i({text:"X",callback:()=>{y.splice(y.indexOf(e),1),o.remove(t)}})),o.append(t,e)}return{connect:function(){const n=t.ui.getPanel("composition");t.ui.addUIs({title:{id:"title",value:u,callback:e=>{u=e}},tonic:{type:"UIListStep",value:p,label:"Tonic",class:"note-edit",list:[...e,"null","rest"],callback:e=>{p=e}},transpose:{type:"UIListStep",value:m,label:"Tonic transpose",class:"note-edit",list:[...e,"null","rest"],callback:e=>{m=e}},bpm:{value:g,label:"BPM",type:"UINumberStep",range:[60,250],callback:e=>{g=e}},duration:{value:b,type:"UISelect",label:"Default Duration",selected:"4n",options:[{value:"1n",text:"Whole 1n"},{value:"2n",text:"Half 2n"},{value:"4n",text:"Quarter 4n"},{value:"8n",text:"Eighth 8n"},{value:"16n",text:"Sixteenth 16n"}],callback:e=>{b=e}},useOctave:{type:"UIToggleCheck",label:"Use Octave",value:x,callback:e=>{x=e}}},n),n.addRow(void 0,"break"),n.add(new r({text:"Scale Intervals"})),a=n.addRow(void 0,"break"),l=new f({list:w,callback:e=>{w=e}}),n.add(l);const y=[{value:"choir",text:"Choir"},{value:"fmSynth",text:"FMSynth"},{value:"toms",text:"Toms"},{value:"bamboo",text:"Bamboo"},{value:"strings",text:"Strings"},{value:"flute",text:"Flute"},{value:"guitar",text:"Guitar"},{value:"piano",text:"Piano"}],C=new k({label:"Instruments",callback:I,selected:"synth",options:y});n.add(new r({class:"break"})),n.add(C),o=n.addRow();const P=n.addRow();P.add(new r({text:"Stacking"})),c=new h({class:"break"});const S=new d({min:0,max:v.length-1,value:v.length-1}),L=new k({label:"Stacking Instruments",selected:"synth",options:y,callback:e=>{let t,n=S.value;0===c.children.length?(t=c.add(new h({class:"break"})),t.add(new r({text:"Stack 0"}))):t=c.children[n],v[n].push(e);const a=new s;a.add(new r({text:e})),a.add(new i({text:"x",callback:()=>{t.remove(a);let l=v[n].indexOf(e);v[n].splice(l,1)}})),t.add(a)}}),U=new i({text:"–",class:"left-end",callback:()=>{0!==c.children.length&&(c.pop(),v.pop(),0!==c.children.length&&(S.max=c.children.length-1,S.update(c.children.length-1)))}}),M=new i({text:"+",class:"right-end",callback:()=>{c.add(new h({class:"break"})).add(new r({text:"Stack "+(c.children.length-1)})),S.max=c.children.length-1,S.update(c.children.length-1),v.push([])}});P.add(S),P.add(U),P.add(M),P.add(L),P.add(c)},load:function(a){if(a.title&&t.ui.faces.title.update(a.title),a.transpose&&t.ui.faces.transpose.update(a.transpose),a.bpm&&t.ui.faces.bpm.update(a.bpm),a.duration&&t.ui.faces.duration.update(a.duration),a.useOctave&&t.ui.faces.useOctave.update(a.useOctave),a.instruments){y=[],o.clear(),(Array.isArray(a.instruments)?[...a.instruments]:[a.instruments]).forEach((e=>{I(e)}))}else n.instruments.forEach((e=>{I(e)}));var d;if(a.tonic&&t.ui.faces.tonic.update("string"==typeof a.tonic?a.tonic:(d=a.tonic,e[d])),a.scale&&(w=a.scale.map((e=>+e)),l.set(w)),a.stacking){v=a.stacking,c.clear();for(let e=0;e<a.stacking.length;e++){const t=a.stacking[e],n=c.add(new h({class:"break"}));n.add(new r({text:"Stack "+e}));for(let a=0;a<t.length;a++){const l=t[a],o=new s;o.add(new r({text:l})),o.add(new i({text:"x",callback:()=>{n.remove(o);let t=v[e].indexOf(l);v[e].splice(t,1)}})),n.add(o)}}}},get:function(){t.melody.update();const e=t.melody.getParts(),n=t.melody.getSequence();return{tonic:p,transpose:m,bpm:g,instruments:y,title:u,duration:b,scale:w,useOctave:x,sequence:n,parts:e,stacking:v}}}}(S,L),S.playback=new function(e){let t,n,a=!1;function l(l,o){const c=e.composition.get();if(c.parts.every((e=>0===e.length)))return alert("Add notes to the melody.");t&&(t.stop(),Tone.Transport.cancel()),t=new NewDoo({...c,withRecording:l,withCount:o,onMutate:a=>{n.text="Mutation: "+a,e.score.update(t.getLoops())},useMetro:a,controls:e.controls.get(),useMeter:e.meter.isOpen(),setMeter:e.meter.setMeter,props:e.modulators.get(),startLoops:e.startLoops.get(),useDefaultProps:!0}),e.fio.saveLocal(c),e.score.update(t.getLoops())}return{connect:function(){const o=e.ui.getPanel("playback",{label:"Play Back"});e.ui.addCallbacks([{callback:l,key:"/",text:"Play",args:[!1]},{key:".",text:"Play Once",callback:()=>{l(!1,1)}},{key:",",text:"Stop",callback:()=>{t&&t.stop()}},{callback:l,key:"r",text:"Record",args:[!0]},{key:"d",text:"Mutate",callback:()=>{t&&t.mutate()}}],o),n=new r({id:"mutation-count",text:"Mutation 0"}),o.add(n),e.ui.addProps({useMetro:{type:"UIToggleCheck",value:a,label:"Metro",key:"m",callback:e=>{a=e}}},o),e.ui.addCallback({row:!0,callback(){t&&t.printLoops()},text:"Print Loops",key:"p"}),e.ui.addCallback({callback(){t&&t.printParams()},text:"Print Params",key:"shift-p"})},isRecording:function(){return!!t&&t.isRecording()}}}(S),S.melody=new function(t,n){let a=0,l=[],o=60,c=[],r=[[!0]],d=n.duration??"4n";const p=["32n","16n","8n","4n","2n","1n"];let f,k;function b(n,o,c,r){let d=n||t.ui.faces.noteInput.value.toUpperCase(),f=o||t.ui.faces.durationInput.value,k=new s({class:"note-collection"});k.addClass("d"+f.replace(/\./g,"dot"));let h=new u({value:d,class:"note-edit",list:[...e,"null","rest"]}),g=new u({value:f,class:"duration-edit",callback:e=>{e.includes("n")||(["1","2","4","8","16","32"].includes(e)?e+="n":e=f,g.value=e),k.el.className="note-collection d"+e.replace(/\./g,"dot"),x(),y()},list:[...p]}),m=new i({text:"+",class:"double-btn",callback:()=>{b(h.value,g.value,!1,k)}}),w=new i({text:"x",class:"remove-btn",callback:()=>{l[a].remove(k),x(),y()}});r?l[a].insert(k,r):l[a].append(k),k.append(h,"note"),k.append(g,"duration"),k.append(m),k.append(w),c||x(),c||y()}function h(e){e.forEach((e=>{if(null===e)return b("rest",d,!0);const t="string"==typeof e?e:e[0],n="string"==typeof e?d:e[1];b(null===t?"rest":t,n,!0)}))}function g(){let e=f.addRow("part-"+l.length,"break-line-up");e.addClass("part"),l.push(e),a=l.length-1,t.ui.faces.currentPart.addOption(a,"Part "+a),t.ui.faces.currentPart.value=a,r.push(Array(r[0].length).fill(!0)),k.update(r)}function m(){const e=l.pop();a>l.length-1&&(a-=1),f.removeRow(e),t.ui.faces.currentPart.removeOption(l.length),t.ui.faces.currentPart.value=a,r.pop(),k.update(r),x()}function w(){l[a].children.forEach((e=>{b(e.note.value,e.duration.value,!0)})),x(),y()}function x(){function e(e){let t=!1;const n=Array.from(e).map((e=>{let n,a=e.note.value,l=e.duration.value;return["null","rest"].includes(a)?n=null:(n=function(e){if(1===e.length||e.length>3)return!1;let t=e[0].toUpperCase(),n=e[e.length-1],a=e.includes("#")?"#":"";return!(isNaN(+n)||!"ABCDEFG".includes(t))&&t+a+n}(a),n||(t=!0)),l.length>3&&(t=!0),isNaN(+l[0])&&(t=!0),1===l.length&&(l+="n"),[n,l]}));return t?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):n}c=[];for(let t=0;t<l.length;t++)c.push(e(l[t].children));return c}function y(){c.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,n=c.flatMap((e=>e.map((e=>e[1]))));let a=Math.max(...n.map((e=>parseInt(e))));n.includes(a+"n."),a<0&&(a="4n");let l=4;for(;e/(l+4)>o;)l+=4;t.ui.panels.melody.setProp("--column-width",Math.floor((e-3*l)/l)),t.ui.panels.melody.setProp("--notes-per-row",l),t.ui.panels.melody.setProp("--default-duration",a)}function v(){l.forEach((e=>e.clear()))}return{connect:function(){f=t.ui.getPanel("melody"),f.addRow(void 0,"break"),t.ui.addProps({melodyScale:{type:"UINumberStep",value:12,label:"Scale",callback:e=>{f.setProp("--ui-scale",e),y()},reset:!0},noteWidth:{type:"UINumberStep",label:"Note Width",value:80,callback:e=>{o=e,l[0]&&y()},range:[40,200],reset:!0}},f),f.addRow(void 0,"break"),t.ui.addProp("currentPart",{type:"UISelect",options:[{value:0,text:"Part 0"}],callback:e=>{a=+e}},f),t.ui.addCallbacks([{callback:g,text:"+"},{callback:m,text:"–"},{callback:v,text:"Clear",key:"0"}],f),k=t.ui.addUI({type:"UIToggleGrid",text:"Part Sequencer",value:r,callback:e=>{r=e}},f),f.addRow("melody","break"),t.ui.addProps({noteInput:{type:"UIListStep",value:"C4",class:"note-edit",list:[...e,"null","rest"]},durationInput:{type:"UIListStep",value:"4n",list:[...p],callback:e=>{e.includes("n")&&(d=e)}}},f),t.ui.addUI({type:"UIButton",callback:b,text:"+",key:"+"},f),t.ui.addUI({type:"UIButton",callback:w,text:"Double It"},f),f.addRow(void 0,"break"),l[0]=f.addRow("part-0","break-line-up"),l[0].addClass("part")},clear:v,update:x,load:function(e){if(e.sequence&&(r=e.sequence,k.update(e.sequence)),e.parts){if(v(),c=[],Array.isArray(e.parts[0]))if(Array.isArray(e.parts[0][0]))for(let n=0;n<e.parts.length;n++)a=n,n>0&&(l[n]=f.addRow("part-"+n,"break-line-up"),l[n].addClass("part"),t.ui.faces.currentPart.addOption(n,"Part "+n)),h(e.parts[n]);else h(e.parts);else h(e.parts);if(x(),a=0,e.sequence){if(r.length<c.length){for(let e=r.length;e<c.length;e++)r.push(Array(r[0].length).fill(!0));k.update(r)}}else r.push(Array(c.length).fill(!0)),k.update(r)}x(),y()},getParts:()=>c,getSequence:()=>r}}(S,L),S.fio=new function(e){function t(t){e.composition.load(t),e.melody.load(t),t.controls&&e.controls.load(t.controls)}function n(t,n){if(t||(t=e.composition.get()),0===t.parts.length){if(!confirm("No melody, continue save?"))return}n||(n=e.controls.get());const a=e.modulators.get(),l=e.startLoops.get();localStorage.setItem("comp",JSON.stringify({...t,controls:n,mods:a,startLoops:l}))}function a(){const t=localStorage.getItem("comp");if(t&&"undefined"!==t){const n=JSON.parse(t);e.composition.load(n),e.melody.load(n),e.controls.load(n.controls),e.modulators.load(n.mods),e.startLoops.load(n.startLoops)}}function l(){e.melody.clear(),localStorage.setItem("comp","")}function o(){if(e.playback.isRecording())return;const t=localStorage.getItem("comp"),n=new Blob([t],{type:"application/x-download;charset=utf-8"}),a=prompt("Name composition",e.composition.get().title);a&&(saveAs(n,a+".json"),e.ui.faces.title.update(a))}function c(t,n,a){new Midi.fromUrl(a).then((t=>{t.tracks.forEach((t=>{const n=t.notes;for(let t=0;t<n.length;t++){const{name:a,duration:l,time:o}=n[t];let c=a,s=t===n.length-1;if(t>0){const a=n[t-1];let l=o-(a.time+a.duration);l>0&&e.composition.addNote("rest",Tone.Time(l).toNotation(),s)}e.composition.addNote(c,Tone.Time(l).toNotation(),s)}}))}))}return{connect:function(){e.ui.getPanel("fio",{label:"Files IO"}),e.ui.addCallbacks([{callback:n,key:"s",text:"Save Local"},{callback:o,key:"alt-s",text:"Save File"},{callback:a,key:"l",text:"Load Local"},{type:"UIFile",callback:t,key:"o",text:"Load File",promptDefault:"compositions"},{callback:l,text:"Clear Local"},{type:"UIFile",callback:c,text:"Load Midi",promptDefault:"compositions",fileType:"audio/midi"}])},saveLocal:n}}(S),S.score=new function(t){let n;const a=document.createElement("canvas");let l;if(!a.getContext("2d"))return;l=a.getContext("2d");let o=20,c=12,s="CDEFGAB".split(""),i=["F","C","G","D","A","E","B"],r=["B","E","A","D","G","C","F"],d={G:["#",1],D:["#",2],A:["#",3],E:["#",4],B:["#",5],"F#":["#",6],"C#":["#",7],F:["b",1],Bb:["b",2],Eb:["b",3],Ab:["b",4],Db:["b",5],Gb:["b",6],Cb:["b",7]},u={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B",Eb:"Gb","D#":"F#",Bb:"Db",F:"Ab",C:"Eb",G:"Bb",D:"F"},p=["G","F","E","D","C","B","A"],f=!1;function k(e,t,n,a){l.beginPath(),l.moveTo(e,t),l.lineTo(n,a),l.stroke()}function b(e,t){let n=e[0],a=+e[e.length-1],l=t[0],o=+t[t.length-1];return s.indexOf(n)-s.indexOf(l)+7*(a-o)}function h(s){let{width:f,height:h}=n.el.getBoundingClientRect();const{tonic:g,scale:m}=t.composition.get(),w=e.indexOf(g),x=m.map((t=>{let n=e[w+t];return n.substring(0,n.length-1)}));let y=g.substring(0,g.length-1);m.includes(3)&&!m.includes(4)&&(y=u[y]);let v=[];if(d[y]){let e=d[y];v="#"===e[0]?i.slice(0,e[1]):r.slice(0,e[1])}let I=16,C=32+v.length*I,P=C,S=o,L=f-8-C-20,U=0===s.length?4:Math.max(...s.flatMap((e=>e.melody.map((e=>+e[1][0]))))),M=Math.max(...s.map((e=>e.melody.length))),O=Math.ceil(M/U),T=s.flatMap((e=>e.melody)).map(((e,t)=>[e[0]?e[0].substring(0,e[0].length-1):null,Math.floor(t%M/U)])).filter((e=>null!==e[0])).filter((e=>!x.includes(e[0]))),R=T.length,A=[];for(let e=0;e<O;e++)A[e]=T.filter((t=>t[1]===e)).length;let D=1,E=1+O+O*U+R,B=[E];if(L>M*I+O*I+R*I)I=Math.floor(L/E);else{B=[0];for(let e=0;e<O;e++){let t=U+A[e]+1,n=t*I;B[D-1]*I+n<L?B[D-1]+=t:(D++,B.push(t))}}a.width=f-8,a.height=144*D+40,l.fillStyle="lightgray",l.fillRect(0,0,a.width,a.height),l.fillStyle="black",l.strokeStyle="black";for(let e=0;e<D;e++){let t=o+144*e,n=32;l.strokeStyle="gray";for(let e=0;e<11;e++){let n=o+e*c+c;5!==e&&k(10,t+n,f-10-8,t+n)}l.fillStyle="black",l.font="60px serif",l.fillText("𝄞",10,t+o+54),l.font="36px serif",l.fillText("𝄢",10,t+o+114),l.font="18px serif",v.forEach((e=>{let a=32+t+6*p.indexOf(e);l.fillText("♯",n,a),l.fillText("♯",n,a+84),n+=16}))}if(0===s.length)return;let N=P+I,F=0,G=0,q=0,K=B[q];for(let e=0;e<=M;e++){let t=I;if(q<D-1&&(t=Math.floor(L/B[q])),e===M){l.fillStyle="black",l.fillRect(N-t/2,S+o+c,6,48),l.fillRect(N-t/2,S+o+84,6,48);continue}if(e>0&&e+G>K-1&&(q++,S+=144,N=P+I,K+=B[q]),e===M){l.fillStyle="black",l.fillRect(N,S+o+c,6,48),l.fillRect(N,S+o+84,6,48);continue}let n=[],a=[];for(let t=0;t<s.length;t++){let{startDelay:l,startIndex:o,doubler:c,repeat:i,melody:r}=s[t],d=(e-l+o)%r.length;r[d]&&(n.push(r[d]),a.push(r.slice(d-F,d+(U-F))))}if(n.every((e=>null===e[0]))){let e=!1;if(l.font="26px Noto",a.flatMap((e=>e)).every((e=>null===e[0]))&&(l.fillText("𝄻",N+t,S+132),e=!0),a.forEach((t=>{t.forEach(((t,n)=>{n<F&&n+U/parseInt(t[1])>F&&(e=!0)}))})),!e){let e=U/4*2,n=F%e,o=F>=e?1:0,c=a.map((t=>t.slice(e*o,e+e*o)));c.flatMap((e=>e)).every((e=>null===e[0]))?0===n&&l.fillText("𝄼",N+t,S+132):n%2==0?c.filter((e=>e[n+1])).every((e=>null===e[n+1][0]))?l.fillText("𝄽",N+t/2,S+138):l.fillText("𝄾",N,S+138):c.filter((e=>e[n-1])).every((e=>null!==e[n-1][0]))&&l.fillText("𝄾",N,S+138)}F++}else l.strokeStyle="black",n.forEach((e=>{let[n,c]=e;if(null===n)return;let s=o+S+72+6*b("C4",n),i=n.substring(0,n.length-1);if(x.includes(i)||(l.font="18px sans-serif",n.includes("#")?l.fillText("♯",N-t/2,s+8):l.fillText("♮",N-t/2,s+8),N+=t,G++),"1n"===c&&(l.beginPath(),l.ellipse(N,s,5,3,-Math.PI/6,0,2*Math.PI),l.stroke()),"2n"===c&&(l.beginPath(),l.ellipse(N,s,5,3,-Math.PI/6,0,2*Math.PI),l.stroke(),k(N+5,s-1,N+5,s-24)),"4n"===c&&(l.beginPath(),l.ellipse(N,s,6,4,-Math.PI/6,0,2*Math.PI),l.fill(),k(N+5,s-1,N+5,s-24)),"8n"===c){let e=U/4*2,o=F%e,c=F>=e?1:0,i=a.map((t=>t.slice(e*c,e+e*c))),r=72+6*b("C4",n),d=0;for(let n=0;n<e;n++){let e=i.filter((e=>e[n])).map((e=>e[n]));if(n>o&&(e.every((e=>null===e[0]))||e.every((e=>"8n"!==e[1]))))break;e.every((e=>null===e[0]))||(n>o&&(d+=t),e.forEach((e=>{if(null===e[0])return;let t=72+6*b("C4",e[0]);t<r&&(r=t)})))}let u=!1;d>0?l.fillRect(N+5,S+r-6,d,4):u=i.filter((e=>e[o-1])).every((e=>null===e[o-1][0])),k(N+5,s-1,N+5,S+r-6),l.beginPath(),l.ellipse(N,s,6,4,-Math.PI/6,0,2*Math.PI),l.fill(),u&&k(N+5,S+r-6,N+10,S+r+6)}S>80&&S<104&&k(N-12,S+o+72,N+12,S+o+72)})),F++;if(F===U){N+=t,G++;let e=N;l.strokeStyle="black",k(e+t/2,S+o+c,e+t/2,S+o+60),k(e+t/2,S+o+84,e+t/2,S+o+132),F=0}N+=t}}return new FontFace("Noto","url(https://fonts.gstatic.com/s/notomusic/v14/pe0rMIiSN5pO63htf1sxEkW7I9tAcVwo.woff2)").load().then((e=>{document.fonts.add(e),console.log("Font loaded"),f=!0})),{connect:function(){n=t.ui.getPanel("score"),n.el.appendChild(a)},update:function(e){h(e)},draw:h}}(S),S.meter=new function(e){let t,n,a=0;const l=document.createElement("canvas");let o;if(!l.getContext("2d"))return;o=l.getContext("2d");const c=320;return l.width=c,l.height=28,o.fillStyle="black",o.fillRect(0,0,c,28),a=performance.now(),requestAnimationFrame((function e(){if(requestAnimationFrame(e),!n)return;const t=performance.now();if(t+33.333333333333336>a){a=t,o.fillStyle="black",o.fillRect(0,0,c,28);const e=n.getValue(),l=Cool.map(e[0],-266,0,1,288,!0),s=Cool.map(e[1],-266,0,1,288,!0);o.fillStyle="LawnGreen",o.fillRect(4,4,l,8),o.fillRect(4,16,s,8),l>2&&o.fillText(Math.round(e[0]),288,12),s>2&&o.fillText(Math.round(e[1]),288,24)}})),{connect:function(){t=e.ui.getPanel("meter"),t.el.appendChild(l),t.el.style.textAlign="left"},setMeter:function(e){n=e},isOpen:function(){return t.isOpen}}}(S),S.modulators=new function(e,t){let n,a,l={},o={min:{value:0,step:1},max:{value:1,step:1},step:{value:1,step:.01},kick:{value:0,step:1},chance:{value:.5,step:5e-4},type:{value:"value",options:["value","range","walk","walkUp","walkDown"]}};function c(e){let t=e[0].toUpperCase()+e.substring(1);return t=t.replace(/(?<=[a-z])(?=[A-Z])/g," "),t}function s(){const n=e.ui.faces.propSelect.value;e.ui.faces.propSelect.value="",n&&(l[n]||(l[n]||(l[n]=structuredClone(t[n])),u(n,!0)))}function u(e,t){const n=new y({title:c(e)});t&&n.open();const o=a.add(new i({text:"X",callback:()=>{delete l[e],a.remove(n),a.remove(o)}}));a.add(n),a.addBreak();const s=new h({class:"break"}),d=new h({class:"break"});s.add(new r({text:"Prop Type"}));let u="number";l[e].hasOwnProperty("type")?u=l[e].type:l[e].hasOwnProperty("list")?u="number-list":l[e].hasOwnProperty("stack")&&(u="stack");const p=new I({value:u,options:["number","number-list","string-list","note-list","stack"],callback:t=>{d.clear(),delete l[e].mod,b(d,t,e)}});s.add(p),n.add(s),b(d,u,e),s.add(d)}function b(e,n,a){switch(n){case"number":if(!l[a].hasOwnProperty("value")){const e=+prompt("Step?",1);l[a]={value:0,step:e,type:n,...t[a]}}v(e,a,"Value");break;case"number-list":l[a].hasOwnProperty("index")||(l[a]={index:0,list:[],type:n,...t[a]}),function(e,t,n=0){const a=m(t);e.add(new r({text:"List"}));let l=f;a.list?"string"==typeof a.list[0]&&(l=x):"string"===prompt("Type? string or number","string")&&(l=x);e.add(new l({list:a.list??[],callback:e=>{w(t,e,"list")}})),e.addBreak(),e.add(new r({text:"Index"})),e.add(new d({value:a.index??0,min:0,step:1,callback:e=>{w(t,e,"index")}})),C(e,t,"Index",n)}(e,a);break;case"stack":l[a].hasOwnProperty("stack")||(l[a]={stack:[[]],options:[],...t[a]}),function(e,t,n=0){const a=m(t),l=[];e.add(new k({selected:"choir",options:a.options??[],callback:e=>{l[o.value]&&(l[o.value].stack.pushItem(e),s())}}));e.addBreak(),e.add(new r({text:"Index"}));const o=e.add(new d({min:0,max:a.stack.length-1,value:0}));function c(t,n){const a=e.add(new h);a.add(new r({text:"Stack "+t}));a.add(new x({list:n??[],callback:()=>{s()}}),"stack");e.addBreak(),l.push(a)}function s(){const e=[];for(let t=0;t<l.length;t++)e[t]={list:l[t].stack.list};w(t,e,"stack")}e.add(new i({text:"–",class:"left-end",callback:()=>{if(0===l.length)return;const t=l.pop();e.remove(t),0!==l.length&&(o.max=l.length-1,o.update(l.length-1),s())}})),e.add(new i({text:"+",class:"right-end",callback:()=>{c(l.length),o.max=l.length-1,o.update(l.length-1),s()}})),e.addBreak();for(let e=0;e<a.stack.length;e++){c(e,a.stack[e].list)}}(e,a)}}function g(e){let t;if(e.includes("-")){t=l;const n=e.split("-");for(let e=0;e<n.length;e++)t=t[n[e]]}else t=l[e];return t}function m(e){let n,a;if(e.includes("-")){n=l;const t=e.split("-");for(let e=0;e<t.length;e++)n=n[t[e]];a=t[t.length-1]}else n=l[e],a=e;return{...t[a],...o[a],...structuredClone(n)}}function w(e,t,n="value"){let a;if(e.includes("-")){a=l;const o=e.split("-");for(let e=0;e<o.length;e++)a=a[o[e]];a[n]=t}else l[e][n]=t}function v(e,t,n,a=0){const l=m(t);e.add(new r({text:n})),e.add(new d({...l,value:l.value??0,callback:e=>{w(t,e)}})),C(e,t,n,a)}function C(e,t,n,a){let l=g(t);if(l||(l=o[t.split("-").pop()]),l.mod)for(const e in o)l.mod.hasOwnProperty(e)||(l.mod[e]=o[e]);a<2&&e.add(new i({text:"+Mod",callback:()=>{l.mod||(l.mod=structuredClone(o),P(e,t,n,a))}})),l.mod&&(e.addBreak(),P(e,t,n,a))}function P(e,t,n,a){const l=g(t),o=function(e,t,n){g(t);const a=m(t),l=new y({title:e});v(l.add(new h({class:"break"})),t+"-min","Min",n);v(l.add(new h({class:"break"})),t+"-max","Max",n);return v(l.add(new h({class:"break"})),t+"-step","Step",n),l.add(new r({text:"Update"})),l.add(new p({value:a.chance?.value??0,label:"Chance",step:.005,callback:e=>{w(t+"-chance",e)}})),l.addBreak(),l.add(new r({text:"Type"})),l.add(new I({value:a.type?.value??"value",options:["value","range","walk","walkUp","walkDown"],callback:e=>{w(t+"-type",e)}})),l.addBreak(),l.add(new r({text:"Kick In"})),l.add(new d({value:a.kick?.value??0,callback:e=>{w(t+"-kick",e)}})),l.addBreak(),l}(c(n+"Mod"),t+"-mod",a+1);e.add(o);const s=e.add(new i({text:"X",callback:()=>{delete l.mod,e.remove(o),e.remove(s)}}))}return{connect:function(){n=e.ui.getPanel("modulators",{label:"Modulators"}),e.ui.addUIs({propSelect:{type:"UIInputSearch",listName:"prop-list",label:"Add mod:",options:Object.keys(t)}}),e.ui.addCallbacks([{callback:s,key:"m",text:"+"},{text:"Collapse",callback:()=>{a.uiChildren.filter((e=>"UITree"===e.constructor.name)).forEach((e=>{e.close()}))}},{key:"shift-p",text:"Print Props",callback:()=>{console.log("props",l)}},{text:"Clear Props",callback:()=>{l={},a.clear()}}]),a=n.add(new h({class:"break"}))},get:function(){return l},load:function(e){a.clear(),l={};for(const t in e)l[t]=structuredClone(e[t]),u(t,!1)}}}(S,a),S.startLoops=new function(e){let t,n=[],a={instrument:"choir",harmony:0,double:!1,attack:0,release:1};function l(e,a){t.addBreak();const l=t.add(new y({title:"Count "+e}),"count"+e);l.add(new r({text:"Loops"})),l.add(new i({text:"–",class:"left-end",callback:()=>{n[e].pop(),l.removeK("loop"+n[e].length)}})),l.add(new i({text:"+",class:"right-end",callback:()=>{n[e].push({}),o(e,n[e].length-1,{},l)}}));for(let t=0;t<a.length;t++)o(e,t,a[t],l)}function o(e,t,n,l){const o=l.add(new h,"loop"+t);o.add(new r({text:"Loop "+t})),o.add(new k({options:Object.keys(a),callback:n=>{c(n,a[n],e,t,o)}}));for(const a in n)c(a,n[a],e,t,o)}function c(t,a,l,o,c){let s=e.ui.labelFromKey(t);switch(typeof a){case"boolean":c.add(new r({text:s})),c.add(new g({value:a,callback:e=>{n[l][o][t]=e}})),n[l][o][t]=a;break;case"number":c.add(new r({text:s})),c.add(new d({value:a,callback:e=>{n[l][o][t]=e}})),n[l][o][t]=a;break;case"string":c.add(new r({text:s})),c.add(new b({value:a,callback:e=>{n[l][o][t]=e}})),n[l][o][t]=a}c.append(new r({class:"break"}))}return{get:function(){return n},load:function(e){if(e){n=structuredClone(e),t.clear();for(let e=0;e<n.length;e++)l(e,n[e])}},connect:function(){const a=e.ui.getPanel("start-loops",{label:"Start Loops"});e.ui.addCallbacks([{text:"Collapse",callback:()=>{t.uiChildren.filter((e=>"UITree"===e.constructor.name)).forEach((e=>{e.close()}))}},{text:"Print",callback:()=>{console.log("start loops",n)}}]);const o=a.addRow("ui-row");o.add(new r({text:"Counts"})),o.add(new i({text:"–",class:"left-end",callback:()=>{n.pop(),t.removeK("count"+n.length)}})),o.add(new i({text:"+",class:"right-end",callback:()=>{const e=[{}];n.push(e),l(n.length-1,e)}})),t=a.addRow("start-loops-row")}}}(S,a),S.ui=l(S,{useMain:!0}),S.ui.setup(),S.fio.connect(),S.composition.connect(),S.melody.connect(),S.playback.connect(),S.score.connect(),S.controls.connect(),S.meter.connect(),S.modulators.connect(),S.startLoops.connect(),S.ui.settings=o(S,{name:"doodoo",workspaceFields:["noteWidth"],workspaces:[{text:"Default",url:"workspaces/Default.json"}]}),S.ui.settings.load(),S.composition.load({}),S.controls.load(),S.score.draw([])}();
//# sourceMappingURL=src_maps/composer.min.js.map
