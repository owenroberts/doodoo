!function(){"use strict";const{MIDI_NOTES:e}=DoodooMidi,{props:t}=DoodooProps,{Interface:l,Settings:a}=UI,{UIElement:n,UICollection:o,UIButton:c,UILabel:s,UINumberStep:r,UIListStep:i,UIChance:d,UINumberList:u,UISelectButton:p,UIText:f,UIRow:b,UIToggleCheck:g,UIFile:k,UIInput:m,UIInputList:h,UITree:w,UIToggleGrid:y,UISelect:v,UIList:x,UIListAdd:I,UIModal:P}=UI.Elements,C={},S={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],beat:"4n",bpm:120,instruments:["choir"]};C.composition=new function(t,l){let a,n,o=l.title,c=l.tonic,r=l.bpm,i=l.transpose??l.tonic,d=l.scale,p=l.useOctave??!1;return{connect:function(){const l=t.ui.getPanel("composition");t.ui.addUIs({title:{id:"title",value:o,callback:e=>{o=e}},tonic:{type:"UIListStep",value:c,label:"Tonic",class:"note-edit",list:[...e,"null","rest"],callback:e=>{c=e}},transpose:{type:"UIListStep",value:i,label:"Tonic transpose",class:"note-edit",list:[...e,"null","rest"],callback:e=>{i=e}},bpm:{value:r,label:"BPM",type:"UINumberStep",range:[60,250],callback:e=>{r=e}},useOctave:{type:"UIToggleCheck",label:"Use Octave",value:p,callback:e=>{p=e}}},l),l.addRow(void 0,"break"),l.add(new s({text:"Scale Intervals"})),a=l.addRow(void 0,"break"),n=new u({list:d,callback:e=>{d=e}}),l.add(n)},load:function(l){var a;l.title&&t.ui.faces.title.update(l.title),l.transpose&&t.ui.faces.transpose.update(l.transpose),l.bpm&&t.ui.faces.bpm.update(l.bpm),l.useOctave&&t.ui.faces.useOctave.update(l.useOctave),l.tonic&&t.ui.faces.tonic.update("string"==typeof l.tonic?l.tonic:(a=l.tonic,e[a])),l.scale&&(d=l.scale.map((e=>+e)),n.set(d))},get:function(){t.melody.update();const e=t.melody.getParts(),l=t.melody.getSequence();return{tonic:c,transpose:i,bpm:r,title:o,scale:d,useOctave:p,sequence:l,parts:e}}}}(C,S),C.playback=new function(e){let t,l,a=!1;function n(n,o,c){const s=e.composition.get();if(s.parts.every((e=>0===e.length)))return alert("Add notes to the melody.");t&&(t.stop(),Tone.Transport.cancel()),t=new Doodoo({...s,withRecording:n,withCount:o,noMods:c,onModulate:a=>{l.text="Modulation: "+a,e.score.update(t.getLoops()),e.monitor.update(t.getLoops())},useMetro:a,useMeter:e.meter.isOpen(),setMeter:e.meter.setMeter,mods:e.modulators.getMods(),partMods:e.modulators.getPartMods(),startLoops:e.startLoops.get(),useDefaultProps:!0}),e.fio.saveLocal(!1),e.score.update(t.getLoops())}return{connect:function(){const o=e.ui.getPanel("playback",{label:"Play Back"});e.ui.addCallbacks([{callback:n,key:"/",text:"Play"},{key:".",text:"Play Once",callback:()=>{n(!1,1)}},{key:",",text:"Stop",callback:()=>{t&&t.stop()}},{callback:n,key:"r",text:"Record",args:[!0]},{key:"shift-/",text:"Play wo Mods",callback:()=>{n(!1,!1,!0)}},{key:"d",text:"Mutate",callback:()=>{t&&t.modulate()}}],o),l=o.add(new s({id:"modulation-count",text:"Modulation 0"})),e.ui.addProps({useMetro:{type:"UIToggleCheck",value:a,label:"Metro",key:"m",callback:e=>{a=e}}},o),e.ui.addCallback({row:!0,callback(){t&&t.printLoops()},text:"Print Loops",key:"p"}),e.ui.addCallback({callback(){t&&t.printParams()},text:"Print Params",key:"shift-p"})},isRecording:function(){return!!t&&t.isRecording()}}}(C),C.melody=new function(t,l){let a=0,n=[],s=60,r=[],d=[[!0]],u=l.beat??"4n";const p=["32n","16n","8n","4n","2n","1n"];let f,b,g,k;function m(t,l,s,r,d){void 0===s&&(s=a);let u=t||f.value.toUpperCase(),g=l||b.value;const k=n[s];let h=new o({class:"note-collection"});h.addClass("b"+g.replace(/\./g,"dot"));let w=new i({value:u,class:"pitch-edit",list:[...e,"null","rest"]}),y=new i({value:g,class:"beat-edit",callback:e=>{e.includes("n")||(["1","2","4","8","16","32"].includes(e)?e+="n":e=g,y.value=e),h.el.className="note-collection b"+e.replace(/\./g,"dot"),x(),I()},list:[...p]}),v=new c({text:"+",class:"double-btn",callback:()=>{m(w.value,y.value,s,!1,h)}}),P=new c({text:">",class:"end-btn",callback:()=>{m(w.value,y.value,s,!1,!1)}}),C=new c({text:"ð„½",class:"rest-btn",callback:()=>{w.value="rest"}}),S=new c({text:"x",class:"remove-btn",callback:()=>{k.remove(h),x(),I()}});d?k.insert(h,d):k.append(h),h.append(w,"pitch"),h.append(y,"beat"),h.append(P),h.append(C),h.append(v),h.append(S),r||x(),r||I()}function h(e,t){const l=t??a;e.forEach((e=>{if(null===e)return m("rest",u,l,!0);const t="string"==typeof e?e:e[0],a="string"==typeof e?u:e[1];m(null===t?"rest":t,a,l,!0)}))}function w(){let e=g.addRow("part-"+n.length,"break-line-up");e.addClass("part"),n.push(e),a=n.length-1,t.ui.faces.currentPart.addOption(a,"Part "+a),t.ui.faces.currentPart.value=a,d.push(Array(d[0].length).fill(!0)),k.update(d)}function y(){const e=n.pop();a>n.length-1&&(a-=1),g.removeRow(e),t.ui.faces.currentPart.removeOption(n.length),t.ui.faces.currentPart.value=a,d.pop(),k.update(d),x()}function v(){n[a].children.forEach((e=>{m(e.pitch.value,e.beat.value,a,!0)})),x(),I()}function x(){function e(e){let t=!1;const l=Array.from(e).map((e=>{let l,a=e.pitch.value,n=e.beat.value;return["null","rest"].includes(a)?l="rest":(l=function(e){if(1===e.length||e.length>3)return!1;let t=e[0].toUpperCase(),l=e[e.length-1],a=e.includes("#")?"#":"";return!(isNaN(+l)||!"ABCDEFG".includes(t))&&t+a+l}(a),l||(t=!0)),n.length>3&&(t=!0),isNaN(+n[0])&&(t=!0),1===n.length&&(n+="n"),[l,n]}));return t?alert("use notes in MIDI format like C4 or C#4, beats like 1n, 2n, 4n, 8n, etc."):l}r=[];for(let t=0;t<n.length;t++)r.push(e(n[t].children));return r}function I(){r.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,l=r.flatMap((e=>e.map((e=>e[1]))));let a=Math.max(...l.map((e=>parseInt(e))));l.includes(a+"n."),a<0&&(a="4n");let n=4;for(;e/(n+4)>s;)n+=4;t.ui.panels.melody.setProp("--column-width",Math.floor((e-3*n)/n)),t.ui.panels.melody.setProp("--notes-per-row",n),t.ui.panels.melody.setProp("--default-beat",a)}function P(){n[a].clear()}function C(){n.forEach((e=>e.clear()))}return{connect:function(){g=t.ui.getPanel("melody"),g.addRow(void 0,"break"),t.ui.addProps({melodyScale:{type:"UINumberStep",value:12,label:"Scale",callback:e=>{g.setProp("--ui-scale",e),I()},reset:!0},noteWidth:{type:"UINumberStep",label:"Note Width",value:80,callback:e=>{s=e,n[0]&&I()},range:[40,200],reset:!0}},g),g.addRow(void 0,"break"),t.ui.addProp("currentPart",{type:"UISelect",options:[{value:0,text:"Part 0"}],callback:e=>{a=+e}},g),t.ui.addCallbacks([{callback:y,text:"â€“",class:"left-end"},{callback:w,text:"+",class:"right-end"},{callback:P,text:"Clear",key:"0"}],g),k=t.ui.addUI({type:"UIToggleGrid",text:"Part Sequencer",value:d,callback:e=>{d=e}},g),g.addRow("melody","break"),f=t.ui.addProp("pitchInput",{type:"UIListStep",value:"C4",class:"pitch-edit",list:[...e,"null","rest"]}),b=t.ui.addProp("beatInput",{type:"UIListStep",value:"4n",list:[...p],callback:e=>{e.includes("n")&&(u=e)}}),t.ui.addUI({type:"UIButton",callback:m,text:"+",key:"+"},g),t.ui.addUI({type:"UIButton",callback:v,text:"Double It"},g),g.addRow(void 0,"break"),n[0]=g.addRow("part-0","break-line-up"),n[0].addClass("part")},clearAll:C,update:x,load:function(e){if(e.sequence&&(d=structuredClone(e.sequence),k.update(d)),e.parts){if(C(),r=[],Array.isArray(e.parts[0]))if(Array.isArray(e.parts[0][0]))for(let l=0;l<e.parts.length;l++)a=l,l>0&&(n[l]=g.addRow("part-"+l,"break-line-up"),n[l].addClass("part"),t.ui.faces.currentPart.addOption(l,"Part "+l)),h(e.parts[l],l);else h(e.parts);else h(e.parts);if(x(),a=0,e.sequence){if(d.length<r.length){for(let e=d.length;e<r.length;e++)d.push(Array(d[0].length).fill(!0));k.update(d)}}else d.push(Array(r.length).fill(!0)),k.update(d)}x(),I()},getParts:()=>r,getSequence:()=>d}}(C,S),C.fio=new function(e){let t,l=[];function a(){l=[],t.clearOptions()}function n(n){if(e.composition.load(n),e.melody.load(n),e.modulators.load(n),e.startLoops.load(n),n.versions){a();for(let e=0;e<n.versions.length;e++){l[e]=n.versions[e];const a=n.versions[e].tag;t.addOption(e,`v${e}${void 0!==a?`: ${a}`:""}`)}}}function o(t=!0){const a=e.composition.get();if(0===a.parts.length){if(!confirm("No melody, continue save?"))return}let n=e.ui.faces.title.value;if(!n||t){confirm(`Confirm title: ${n}`)||(n=prompt("New title",n))}"title"===n&&(alert("No title title"),n=prompt("New title")),e.ui.faces.title.value=n;const o={...a,mods:e.modulators.getMods(),partMods:e.modulators.getPartMods(),startLoops:e.startLoops.get(),savedOn:(new Date).toDateString().replace(/ /g,"-")};l.length>0&&(o.versions=l);try{localStorage.setItem("greg-"+n,JSON.stringify(o)),localStorage.setItem("greg-title",n)}catch(e){"QuotaExceededError"===e.name?alert("Local storage full"):(console.log(e),alert(e.name))}return o}function s(t){let l=t;if(l||(l=localStorage.getItem("greg-title")),l||prompt("Search title"),!l)return alert("No title.");const a=localStorage.getItem("greg-"+l);if(!a){const e=Object.keys(localStorage).filter((e=>e.includes("greg")));return alert("No data, Locals saves: "+e)}const o=JSON.parse(a);e.ui.faces.title.update(l),n(o)}function r(){const t=new P({app:e,title:"Local Saves",position:{x:200,y:120}});Object.keys(localStorage).filter((e=>e.includes("greg")&&!e.includes("title"))).forEach((e=>{t.add(new c({text:e.replace("greg-",""),callback:()=>{s(e.replace("greg-","")),t.clear()}}))}))}function i(){e.melody.clearAll(),function(){const t=e.ui.faces.title.value;t||alert("No title"),localStorage.removeItem("greg-"+t),localStorage.removeItem("greg-title"),a()}()}function d(){if(e.playback.isRecording())return;const t=localStorage.getItem("greg-"+e.ui.faces.title.value),l=new Blob([t],{type:"application/x-download;charset=utf-8"}),a=prompt("Name composition",e.composition.get().title);a&&(saveAs(l,a+".json"),e.ui.faces.title.update(a),o())}function u(t,l,a){new Midi.fromUrl(a).then((t=>{t.tracks.forEach((t=>{const l=t.notes;for(let t=0;t<l.length;t++){const{name:a,duration:n,time:o}=l[t];let c=a,s=t===l.length-1;if(t>0){const a=l[t-1];let n=o-(a.time+a.duration);n>0&&e.composition.addNote("rest",Tone.Time(n).toNotation(),s)}e.composition.addNote(c,Tone.Time(n).toNotation(),s)}}))}))}function p(){const e=o(),a=prompt("Tag version?"),n={};void 0!==a&&(n.tag=a),n.versionedOn=(new Date).toDateString().replace(/ /g,"-");for(const t in e)"versions"!==t&&"title"!==t&&(n[t]=e[t]);l.push(n);const c=l.length-1;t.addOption(c,`v${c}${void 0!==a?`: ${a}`:""}`),o(!1)}function f(e){if("current"===e)return;confirm("Save current to new version?")&&p();n(o(!1).versions[e])}return{connect:function(){e.ui.getPanel("fio",{label:"Files IO"}),t=e.ui.addUI({type:"UISelect",label:"Version",options:["current"],callback:f}),e.ui.addCallback({callback:p,key:"v",text:"Add Version"}),e.ui.addCallbacks([{callback:o,key:"s",text:"Save Local"},{callback:d,key:"alt-s",text:"Save File"},{callback:s,key:"l",text:"Load Local"},{callback:r,key:"ctrl-l",text:"List Local"},{callback:i,text:"Clear Local"},{type:"UIFile",callback:n,key:"o",text:"Load File",promptDefault:"compositions"},{type:"UIFile",callback:u,text:"Load Midi",promptDefault:"compositions",fileType:"audio/midi"}])},saveLocal:o}}(C),C.score=new function(t){let l;const a=document.createElement("canvas");let n;if(!a.getContext("2d"))return;n=a.getContext("2d");let o=20,c=12,s="CDEFGAB".split(""),r=["F","C","G","D","A","E","B"],i=["B","E","A","D","G","C","F"],d={G:["#",1],D:["#",2],A:["#",3],E:["#",4],B:["#",5],"F#":["#",6],"C#":["#",7],F:["b",1],Bb:["b",2],Eb:["b",3],Ab:["b",4],Db:["b",5],Gb:["b",6],Cb:["b",7]},u={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B",Eb:"Gb","D#":"F#",Bb:"Db",F:"Ab",C:"Eb",G:"Bb",D:"F"},p=["G","F","E","D","C","B","A"],f=!1;function b(e,t,l,a){n.beginPath(),n.moveTo(e,t),n.lineTo(l,a),n.stroke()}function g(e,t){let l=e[0],a=+e[e.length-1],n=t[0],o=+t[t.length-1];return s.indexOf(l)-s.indexOf(n)+7*(a-o)}function k(s){let{width:f,height:k}=l.el.getBoundingClientRect();const{tonic:m,scale:h}=t.composition.get(),w=e.indexOf(m),y=h.map((t=>{let l=e[w+t];return l.substring(0,l.length-1)}));let v=m.substring(0,m.length-1);h.includes(3)&&!h.includes(4)&&(v=u[v]);let x=[];if(d[v]){let e=d[v];x="#"===e[0]?r.slice(0,e[1]):i.slice(0,e[1])}let I=16,P=32+x.length*I,C=P,S=o,M=f-8-P-20,U=0===s.length?4:Math.max(...s.flatMap((e=>e.melody.map((e=>+e[1][0]))))),O=Math.max(...s.map((e=>e.melody.length))),L=Math.ceil(O/U),B=s.flatMap((e=>e.melody)).map(((e,t)=>[e[0]?e[0].substring(0,e[0].length-1):null,Math.floor(t%O/U)])).filter((e=>null!==e[0])).filter((e=>!y.includes(e[0]))),T=B.length,E=[];for(let e=0;e<L;e++)E[e]=B.filter((t=>t[1]===e)).length;let R=1,N=1+L+L*U+T,D=[N];if(M>O*I+L*I+T*I)I=Math.floor(M/N);else{D=[0];for(let e=0;e<L;e++){let t=U+E[e]+1,l=t*I;D[R-1]*I+l<M?D[R-1]+=t:(R++,D.push(t))}}a.width=f-8,a.height=144*R+40,n.fillStyle="lightgray",n.fillRect(0,0,a.width,a.height),n.fillStyle="black",n.strokeStyle="black";for(let e=0;e<R;e++){let t=o+144*e,l=32;n.strokeStyle="gray";for(let e=0;e<11;e++){let l=o+e*c+c;5!==e&&b(10,t+l,f-10-8,t+l)}n.fillStyle="black",n.font="60px serif",n.fillText("ð„ž",10,t+o+54),n.font="36px serif",n.fillText("ð„¢",10,t+o+114),n.font="18px serif",x.forEach((e=>{let a=32+t+6*p.indexOf(e);n.fillText("â™¯",l,a),n.fillText("â™¯",l,a+84),l+=16}))}if(0===s.length)return;let A=C+I,F=0,$=0,G=0,q=D[G];for(let e=0;e<=O;e++){let t=I;if(G<R-1&&(t=Math.floor(M/D[G])),e===O){n.fillStyle="black",n.fillRect(A-t/2,S+o+c,6,48),n.fillRect(A-t/2,S+o+84,6,48);continue}if(e>0&&e+$>q-1&&(G++,S+=144,A=C+I,q+=D[G]),e===O){n.fillStyle="black",n.fillRect(A,S+o+c,6,48),n.fillRect(A,S+o+84,6,48);continue}let l=[],a=[];for(let t=0;t<s.length;t++){let{startDelay:n,startIndex:o,doubler:c,repeat:r,melody:i}=s[t],d=(e-n+o)%i.length;i[d]&&(l.push(i[d]),a.push(i.slice(d-F,d+(U-F))))}if(l.every((e=>null===e[0]))){let e=!1;if(n.font="26px Noto",a.flatMap((e=>e)).every((e=>null===e[0]))&&(n.fillText("ð„»",A+t,S+132),e=!0),a.forEach((t=>{t.forEach(((t,l)=>{l<F&&l+U/parseInt(t[1])>F&&(e=!0)}))})),!e){let e=U/4*2,l=F%e,o=F>=e?1:0,c=a.map((t=>t.slice(e*o,e+e*o)));c.flatMap((e=>e)).every((e=>null===e[0]))?0===l&&n.fillText("ð„¼",A+t,S+132):l%2==0?c.filter((e=>e[l+1])).every((e=>null===e[l+1][0]))?n.fillText("ð„½",A+t/2,S+138):n.fillText("ð„¾",A,S+138):c.filter((e=>e[l-1])).every((e=>null!==e[l-1][0]))&&n.fillText("ð„¾",A,S+138)}F++}else n.strokeStyle="black",l.forEach((e=>{let[l,c]=e;if(null===l)return;let s=o+S+72+6*g("C4",l),r=l.substring(0,l.length-1);if(y.includes(r)||(n.font="18px sans-serif",l.includes("#")?n.fillText("â™¯",A-t/2,s+8):n.fillText("â™®",A-t/2,s+8),A+=t,$++),"1n"===c&&(n.beginPath(),n.ellipse(A,s,5,3,-Math.PI/6,0,2*Math.PI),n.stroke()),"2n"===c&&(n.beginPath(),n.ellipse(A,s,5,3,-Math.PI/6,0,2*Math.PI),n.stroke(),b(A+5,s-1,A+5,s-24)),"4n"===c&&(n.beginPath(),n.ellipse(A,s,6,4,-Math.PI/6,0,2*Math.PI),n.fill(),b(A+5,s-1,A+5,s-24)),"8n"===c){let e=U/4*2,o=F%e,c=F>=e?1:0,r=a.map((t=>t.slice(e*c,e+e*c))),i=72+6*g("C4",l),d=0;for(let l=0;l<e;l++){let e=r.filter((e=>e[l])).map((e=>e[l]));if(l>o&&(e.every((e=>null===e[0]))||e.every((e=>"8n"!==e[1]))))break;e.every((e=>null===e[0]))||(l>o&&(d+=t),e.forEach((e=>{if(null===e[0])return;let t=72+6*g("C4",e[0]);t<i&&(i=t)})))}let u=!1;d>0?n.fillRect(A+5,S+i-6,d,4):u=r.filter((e=>e[o-1])).every((e=>null===e[o-1][0])),b(A+5,s-1,A+5,S+i-6),n.beginPath(),n.ellipse(A,s,6,4,-Math.PI/6,0,2*Math.PI),n.fill(),u&&b(A+5,S+i-6,A+10,S+i+6)}S>80&&S<104&&b(A-12,S+o+72,A+12,S+o+72)})),F++;if(F===U){A+=t,$++;let e=A;n.strokeStyle="black",b(e+t/2,S+o+c,e+t/2,S+o+60),b(e+t/2,S+o+84,e+t/2,S+o+132),F=0}A+=t}}return new FontFace("Noto","url(https://fonts.gstatic.com/s/notomusic/v14/pe0rMIiSN5pO63htf1sxEkW7I9tAcVwo.woff2)").load().then((e=>{document.fonts.add(e),console.log("Font loaded"),f=!0})),{connect:function(){l=t.ui.getPanel("score"),l.el.appendChild(a)},update:function(e){k(e)},draw:k}}(C),C.meter=new function(e){let t,l,a=0;const n=document.createElement("canvas");let o;if(!n.getContext("2d"))return;o=n.getContext("2d");const c=320;return n.width=c,n.height=28,o.fillStyle="black",o.fillRect(0,0,c,28),a=performance.now(),requestAnimationFrame((function e(){if(requestAnimationFrame(e),!l)return;const t=performance.now();if(t+33.333333333333336>a){a=t,o.fillStyle="black",o.fillRect(0,0,c,28);const e=l.getValue(),n=Cool.map(e[0],-266,0,1,288,!0),s=Cool.map(e[1],-266,0,1,288,!0);o.fillStyle="LawnGreen",o.fillRect(4,4,n,8),o.fillRect(4,16,s,8),n>2&&o.fillText(Math.round(e[0]),288,12),s>2&&o.fillText(Math.round(e[1]),288,24)}})),{connect:function(){t=e.ui.getPanel("meter"),t.el.appendChild(n),t.el.style.textAlign="left"},setMeter:function(e){l=e},isOpen:function(){return t.isOpen}}}(C),C.monitor=new function(e){const t={melody:!0,count:!0,countEnd:!0,harmony:!0,instrument:!0,attack:!0,curve:!0,release:!0,double:!0,fx:!0,playBeat:!0};let l;function a(e,t){return"instrument"===e?t.instrument?t.instrument:t.name:"melody"===e?t.filter((e=>null!==e[0])).map((e=>` ${e[0]}:${e[1]}`)):"fx"===e?JSON.stringify(t):t}return{connect:function(){const a=e.ui.getPanel("monitor");a.addRow();for(const l in t){e.ui.addProp(`monitor-${l}`,{type:"UIToggleCheck",label:`${l}:`,class:"monitor-prop",isOn:!0,callback:e=>{t[l]=e}})}l=a.addRow("mRow","break")},update:function(e){l.clear();for(let n=0;n<e.length;n++){const o=l.add(new b({class:"break"}));o.add(new s({text:`Loop ${n} -> `}));const c=e[n];for(const e in t)t[e]&&o.add(new s({text:`${e}: ${a(e,c[e])},`,class:"prop-value"}))}}}}(C),C.modulators=new function(e,t){let l,a,n,o=[],i=[],f=0,g={},k={},m={min:{value:0,step:1},max:{value:1,step:1},step:{value:1,step:.01},kick:{value:0,step:1},chance:{value:.5,step:.05},type:{value:"value",options:["value","range","walk","walkUp","walkDown"]}};function y(e){let t=e[0].toUpperCase()+e.substring(1);return t=t.replace(/(?<=[a-z])(?=[A-Z])/g," "),t}function x(e,t=-1){const l=P(e,t);let a="number";return l.hasOwnProperty("type")?a=l.type:l.hasOwnProperty("list")?a="number-list":l.hasOwnProperty("stack")&&(a="stack"),a}function I(e,t=-1){let l=t<0?g:i[t];if(e.includes("-")){const t=e.split("-");for(let e=0;e<t.length;e++)l=l[t[e]]}else l=l[e];return l}function P(e,t=-1){let l=t<0?g:i[t];if(e.includes("-")){const t=e.split("-");for(let e=0;e<t.length;e++)l=l[t[e]]}else l=l[e];return structuredClone(l)}function C(e,l=-1){let a=l<0?g:i[l],n=e;if(e.includes("-")){const t=e.split("-");for(let e=0;e<t.length;e++)a=a[t[e]];n=t[t.length-1]}else a=g[e],n=e;return{...t[n],...m[n]}}function S(e,l=-1){if(!e)return;if(g[e]&&l<0)return;if(l>=0&&i[l]&&i[l].hasOwnProperty(e))return;const a=structuredClone(t[e]);l<0&&!g[e]&&(g[e]=a),l>=0&&(i[l]||(i[l]={}),i[l][e]||(i[l][e]=a)),l>=0&&(o[l]||M(l,!0)),U(e,l,!0)}function M(e,t=!1){const l=new w({title:`Part ${e}`}),a=n.add(new c({text:"X",callback:()=>{i[e]=void 0,o[e]=void 0,n.remove(l),n.remove(a)}}));n.add(l),o[e]=l,t&&l.open(),n.addBreak()}function U(e,t=-1,l=!1){const n=new w({title:y(e)}),r=t<0?a:o[t],d=r.add(new c({text:"X",callback:()=>{!function(e,t=-1){t>=0?delete i[t][e]:delete g[e]}(e,t),r.remove(n),r.remove(d)}}));r.add(n),l&&n.open(),r.addBreak();const u=new b({class:"break"}),p=new b({class:"break"});u.add(new s({text:"Prop Type"}));const f=x(e,t),k=new v({value:f,options:["number","number-list","string-list","note-list","stack","chance","bundle"],callback:l=>{p.clear(),delete g[e].mod,O(p,l,e,t)}});u.add(k),n.add(u),O(p,f,e,t),u.add(p)}function O(t,l,a,n){const o=P(a,n),i=C(a,n);switch(l){case"number":case"chance":if(L(a,l,n,"type"),!o.hasOwnProperty("value")){const e=+prompt("Step?",1);L(a,0,n,"value"),L(a,e,n,"step")}B(t,a,n,"Value");break;case"number-list":L(a,l,n,"type"),o.hasOwnProperty("list")||L(a,i.list??[],n,"list"),o.hasOwnProperty("index")||L(a,i.index??0,n,"index"),function(e,t,l,a=0){const n=P(t,l);e.add(new s({text:"List"}));let o=u;"string"==typeof n.list[0]?o=h:n.list||"string"===prompt("Type? string or number","string")&&(o=h);const c=e.add(new o({list:n.list??[],callback:e=>{L(t,e,l,"list")}}));e.addBreak(),e.add(new s({text:"Index"}));const i=e.add(new r({value:n.index??0,min:0,step:1,callback:e=>{L(t,e,l,"index")}}));k[t]={list:c,index:i},T(e,t,l,"Index",a)}(t,a,n);break;case"stack":L(a,l,n,"type"),o.hasOwnProperty("stack")||L(a,i.stack??[[]],n,"stack"),o.hasOwnProperty("options")||L(a,i.options??[],n,"options"),function(e,t,l,a=0){const n=P(t,l),o=[];e.add(new p({selected:"choir",options:n.options??[],callback:e=>{o[i.value]&&(o[i.value].stack.pushItem(e),u())}}));e.addBreak(),e.add(new s({text:"Index"}));const i=e.add(new r({min:0,max:n.stack.length-1,value:0}));function d(t,l){const a=e.add(new b);a.add(new s({text:"Stack "+t}));a.add(new h({list:l??[],callback:()=>{u()}}),"stack");e.addBreak(),o.push(a)}function u(){const e=[];for(let t=0;t<o.length;t++)e[t]={list:o[t].stack.list};L(t,e,l,"stack")}e.add(new c({text:"â€“",class:"left-end",callback:()=>{if(0===o.length)return;const t=o.pop();e.remove(t),0!==o.length&&(i.max=o.length-1,i.update(o.length-1),u())}})),e.add(new c({text:"+",class:"right-end",callback:()=>{d(o.length),i.max=o.length-1,i.update(o.length-1),u()}})),e.addBreak();for(let e=0;e<n.stack.length;e++){d(e,n.stack[e].list,l)}}(t,a,n);break;case"bundle":for(const l in o){if("type"===l)continue;t.add(new s({text:e.ui.labelFromKey(l),class:"break-line"}));O(t,x(`${a}-${l}`,n),`${a}-${l}`,n),t.addBreak()}}}function L(e,t,l=-1,a="value"){let n=l<0?g:i[l];if(e.includes("-")){const l=e.split("-");for(let e=0;e<l.length;e++)n=n[l[e]];n[a]=t}else n[e][a]=t}function B(e,t,l,a,n=0){const o=P(t,l);e.add(new s({text:a}));let c=r;"chance"===o?.type&&(c=d);const i=e.add(new c({...o,value:o.value??0,label:"Chance",callback:e=>{L(t,e,l)}}));k[t]={value:i},T(e,t,l,a,n)}function T(e,t,l,a,n){let o=I(t,l);if(o||(o=m[t.split("-").pop()]),o.mod)for(const e in m)o.mod.hasOwnProperty(e)||(o.mod[e]=m[e]);n<2&&e.add(new c({text:"+Mod",callback:()=>{o.mod||(o.mod=structuredClone(m),E(e,t,l,a,n))}})),o.mod&&(e.addBreak(),E(e,t,l,a,n))}function E(e,t,l,a,n){const o=I(t,l),i=function(e,t,l,a){I(t,l);const n=P(t,l),o=new w({title:e});B(o.add(new b({class:"break"})),t+"-min",l,"Min",a);B(o.add(new b({class:"break"})),t+"-max",l,"Max",a);return B(o.add(new b({class:"break"})),t+"-step",l,"Step",a),o.add(new s({text:"Update"})),o.add(new d({value:n.chance?.value??0,label:"Chance",step:.05,callback:e=>{L(t+"-chance",e,l)}})),o.addBreak(),o.add(new s({text:"Type"})),o.add(new v({value:n.type?.value??"value",options:["value","range","walk","walkUp","walkDown"],callback:e=>{L(t+"-type",e,l)}})),o.addBreak(),o.add(new s({text:"Kick In"})),o.add(new r({value:n.kick?.value??0,callback:e=>{L(t+"-kick",e,l)}})),o.addBreak(),o}(y(a+"Mod"),t+"-mod",l,n+1);e.add(i);const u=e.add(new c({text:"X",callback:()=>{delete o.mod,e.remove(i),e.remove(u)}}))}function R(){a.uiChildren.filter((e=>"UITree"===e.constructor.name)).forEach((e=>{e.close()}))}return{connect:function(){l=e.ui.getPanel("modulators",{label:"Modulators"}),e.ui.addUIs({propSelect:{type:"UIInputSearch",listName:"prop-list",label:"Add mod:",options:Object.keys(t)}}),e.ui.addCallbacks([{key:"m",text:"+",callback:()=>{0===e.ui.faces.propSelect.value.length?e.ui.faces.propSelect.focus():(S(e.ui.faces.propSelect.value),e.ui.faces.propSelect.value="")}}]),l.addRow(),e.ui.addCallbacks([{text:"Collapse",callback:R},{key:"shift-p",text:"Print Props",callback:()=>{console.log("props",g)}},{text:"Clear Props",callback:()=>{g={},a.clear()}},{text:"Zero Effects",callback:()=>{["distortion","bitCrush","autoFilter","autoPanner","cheby","chorus","feedback","phaser","pingPong","tremolo","vibrato"].forEach((e=>{g.hasOwnProperty(e)&&(L(e+"-chance",0),k[e+"-chance"].value.update(0))}))}}]),a=l.add(new b({class:"break"})),l=e.ui.getPanel("part-mods",{label:"Part Mods"}),e.ui.addUIs({partModSelect:{type:"UIInputSearch",listName:"prop-list",label:"Add mod:",options:Object.keys(t)}}),e.ui.addCallbacks([{text:"+",callback:()=>{0===e.ui.faces.partModSelect.value.length?e.ui.faces.partModSelect.focus():(S(e.ui.faces.partModSelect.value,f),e.ui.faces.partModSelect.value="")}}]),e.ui.addProp("partModIndex",{type:"UINumberStep",value:0,callback:e=>{f=e}}),n=l.add(new b({class:"break"}))},get:function(){return{mods:g,partMods:i}},load:function(e){if(e.mods||e.partMods){a.clear(),g={};for(const t in e.mods)g[t]=structuredClone(e.mods[t]),U(t);R(),n.clear(),i=[];for(let t=0;t<e.partMods.length;t++){const l=e.partMods[t];if(l){i[t]={},M(t);for(const e in l)i[t][e]=structuredClone(l[e]),U(e,t)}}}},getMods:function(){return g},getPartMods:function(){return i}}}(C,t),C.startLoops=new function(e){let t,l=[],a={instrument:"choir",harmony:0,double:!1,attack:0,release:1,playBeat:4};function n(e){t.addBreak();const a=t.add(new w({title:"Count "+e}),"count"+e);a.add(new r({text:"Counts",value:l[e].counts,callback:t=>{l[e].counts=t}})),a.addBreak(),a.add(new s({text:"Loops"})),a.add(new c({text:"â€“",class:"left-end",callback:()=>{l[e].loops.pop(),a.removeK("loop"+l[e].loops.length)}})),a.add(new c({text:"+",class:"right-end",callback:()=>{l[e].loops.push({}),o(e,l[e].loops.length-1,{},a)}}));for(let t=0;t<l[e].loops.length;t++)o(e,t,l[e].loops[t],a)}function o(e,t,l,n){const o=n.add(new b,"loop"+t);o.add(new s({text:"Loop "+t})),o.add(new p({options:Object.keys(a),callback:l=>{i(l,a[l],e,t,o)}})),o.addBreak();for(const a in l)i(a,l[a],e,t,o)}function i(t,a,n,o,c){let i=e.ui.labelFromKey(t);switch(typeof a){case"boolean":c.add(new s({text:i})),c.add(new g({value:a,callback:e=>{l[n].loops[o][t]=e}})),c.addBreak(),l[n].loops[o][t]=a;break;case"number":c.add(new s({text:i})),c.add(new r({value:a,callback:e=>{l[n].loops[o][t]=e}})),c.addBreak(),l[n].loops[o][t]=a;break;case"string":c.add(new s({text:i})),c.add(new f({value:a,callback:e=>{l[n].loops[o][t]=e}})),c.addBreak(),l[n].loops[o][t]=a}c.append(new s({class:"break"}))}return{get:function(){return l},load:function(e){if(e.startLoops&&!(e.startLoops.length<1)){e.startLoops[0].hasOwnProperty("counts")?l=structuredClone(e.startLoops):alert("Old start loops!"),t.clear();for(let t=0;t<e.startLoops.length;t++)n(t)}},connect:function(){const a=e.ui.getPanel("start-loops",{label:"Start Loops"});e.ui.addCallbacks([{text:"Collapse",callback:()=>{t.uiChildren.filter((e=>"UITree"===e.constructor.name)).forEach((e=>{e.close()}))}},{text:"Print",callback:()=>{console.log("start loops",l)}}]);const o=a.addRow("ui-row");o.add(new s({text:"Counts"})),o.add(new c({text:"â€“",class:"left-end",callback:()=>{l.pop(),t.removeK("count"+l.length)}})),o.add(new c({text:"+",class:"right-end",callback:()=>{l.push({counts:1,loops:[]}),n(l.length-1)}})),t=a.addRow("start-loops-row")}}}(C,t),C.ui=l(C,{useMain:!0}),C.ui.setup(),C.fio.connect(),C.composition.connect(),C.melody.connect(),C.playback.connect(),C.score.connect(),C.meter.connect(),C.monitor.connect(),C.modulators.connect(),C.startLoops.connect(),C.ui.settings=a(C,{name:"doodoo",workspaceFields:["noteWidth"],workspaces:[{text:"Default",url:"workspaces/Default.json"}]}),C.ui.settings.load(),C.composition.load({}),C.score.draw([]),console.log("app",C)}();
//# sourceMappingURL=src_maps/composer.min.js.map
