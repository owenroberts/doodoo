const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooDefaultParams:doodooDefaultParams}=doodooLib;function Composition(t,e){const a=this;let n,o,s,l,i,{MIDI_NOTES:c}=t;this.tonic=e.tonic,this.transform=e.transform||e.tonic,this.bpm=e.bpm,this.samples=e.samples,this.scale=e.scale,this.title=e.title,this.startDuration=e.startDuration,this.parts=[],this.useMetro=!1,this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){a.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",a.uiScale)},this.setNoteWidth=function(t){a.noteWidth=t,o&&a.updateDisplay()},this.init=function(){s=a.panel.scaleRow,o=t.ui.panels.melody.melody,l=t.ui.panels.melody.melodyInput.noteInput,i=t.ui.panels.melody.melodyInput.durationInput,a.setUIScale(a.uiScale)},this.updateScale=function(){s.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:a.scale[t],min:-11,max:11,callback:e=>{a.scale[t]=+e}});s.append(e,t)}},this.play=function(e){if(0===a.parts.length)return alert("Add notes to the melody.");a.update(),n&&(n.stop(),Tone.Transport.cancel());const o=a.get();n=new Doodoo({...o,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:a.useMetro,params:t.params.get()}),n.play(),t.fio.saveLocal(o)},this.stop=function(){n&&n.stop()},this.mutate=function(){n&&n.mutate()},this.update=function(){a.parts=[];let t=!1;const e=o.children,n=Array.from(e).map((e=>{let a,n=e.note.value,o=e.duration.value;return["null","rest"].includes(n)?a=null:(a=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),a=t[t.length-1],n=t.includes("#")?"#":"";return!(isNaN(+a)||!"ABCDEFG".includes(e))&&e+n+a}(n),a||(t=!0)),o.length>3&&(t=!0),isNaN(+o[0])&&(t=!0),1===o.length&&(o+="n"),[a,o]}));if(t)return alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc.");a.parts=n},this.addNote=function(t,e,n){let s=t||l.value,p=e||i.value,r=new UICollection({class:"note-collection"});r.addClass("d"+p.replace(/\./g,"dot"));let u=new UIListStep({value:s,class:"note-edit",list:[...c,"null","rest"]}),d=new UIListStep({value:p,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=a.startDuration,d.value=t),r.el.className="note-collection d"+t.replace(/\./g,"dot"),a.update(),a.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),m=new UIButton({text:"X",class:"remove-btn",callback:()=>{o.remove(r),a.update(),a.updateDisplay()}});r.append(u,"note"),r.append(d,"duration"),r.append(m),o.append(r),n||a.update(),n||a.updateDisplay()},this.updateDisplay=function(){a.parts.length;const t=o.el.getBoundingClientRect().width,e=a.parts.map((t=>t[1]));let n=Math.max(...e.map((t=>parseInt(t))));e.includes(n+"n."),n<0&&(n="4n");let s=4;for(;t/s>a.noteWidth;)s+=4;o.setProp("--column-width",Math.floor(t/s)),o.setProp("--notes-per-row",s),o.setProp("--default-duration",n)},this.clear=function(){o.clear()},this.get=function(){return a.update(),{parts:a.parts,tonic:a.tonic,transform:a.transform,bpm:a.bpm,samples:a.samples,title:this.title,startDuration:this.startDuration,scale:this.scale}},this.load=function(e){var n;e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(n=e.tonic,c[n])),e.startDuration&&t.ui.faces.startDuration.update(e.startDuration),e.scale&&(a.scale=e.scale.map((t=>+t))),a.updateScale(),e.parts&&(a.clear(),a.parts=[],e.parts.forEach((t=>{if(null===t)return a.addNote("rest",e.startDuration,!0);const n="string"==typeof t?t:t[0],o="string"==typeof t?e.startDuration:t[1];null===n?a.addNote("rest",o,!0):a.addNote(n,o,!0)}))),a.update(),a.updateDisplay()}}function FilesIO(t){this.load=function(e){t.composition.load(e),t.params.load(e.params)},this.saveLocal=function(e,a){e||(e=t.composition.get()),a||(a=t.params.get()),localStorage.setItem("comp",JSON.stringify({...e,params:a}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){t.composition.update();const e=localStorage.getItem("comp"),a=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(a,prompt("Name composition",t.composition.title)+".json")},this.loadMidi=function(t,e,a){console.log(e,a);new Midi.fromUrl(a).then((t=>{t.tracks.forEach((t=>{t.notes.forEach((t=>{console.log(t.name,t.duration,t.time),console.log(Tone.Time(t.duration).toNotation());const e=Tone.Time("1m").toSeconds();console.log("1m = ",e),console.log(Math.floor(t.time/e),Tone.Time(t.time%e).toNotation())}))}))}))}}function Params(t,e,a){const n=this;let o;const s={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function l(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function i(t,a){let{key:n,value:o}=t,s=l(n);const i=new UILabel({text:s,class:"break-line-up"});a.append(i);const c=new UIChance({label:"Chance",value:o,min:0,max:1,step:.01,callback:t=>{e[n]=t}});a.append(c)}function c(t,e){}function p(t,a){let{key:n,value:o,range:s,step:i}=t,c=l(n);const p=new UILabel({text:c,class:"break-line-up"}),r=new UILabel({text:"Min"}),u=new UINumberStep({value:o[0],min:s[0],max:s[1],step:i[0],callback:t=>{e[n][0]=t}}),d=new UILabel({text:"Max"}),m=new UINumberStep({value:o[1],min:s[0],max:s[1],step:i[0],callback:t=>{e[n][1]=t}});if(a.append(p),a.append(r),a.append(u),a.append(d),a.append(m),o.length>2){const t=new UIChance({label:"Min Chance",value:o[2],min:s[2],max:s[3],step:i[1],callback:t=>{e[n][2]=t}}),l=new UIChance({label:"Max Chance",value:o[3],min:s[2],max:s[3],step:i[1],callback:t=>{e[n][3]=t}});a.append(t),a.append(l)}}function c(t,a){let{key:n,start:o,add:s,chance:i}=t,c=l(n);const p=new UILabel({text:c,class:"break-line-up"});a.append(p);const r=new UIChance({label:"Chance",value:i,min:0,max:1,step:.01,callback:t=>{e[n].chance=t}});a.append(r);const u=new UILabel({text:"Start",class:"break"}),d=new UINumberList({list:o,callback:t=>{e[n].start=t}});a.append(u),a.append(d);const m=new UILabel({text:"Add",class:"break"}),h=new UINumberList({list:s,callback:t=>{e[n].add=t}});a.append(m),a.append(h)}function r(t,a){let{key:n,value:o,range:s}=t,i=l(n);const c=new UILabel({text:i+" Value",class:"break-line-up"});a.append(c);const p=new UINumberStep({value:o,min:s[0],max:s[1],step:t.step||1,callback:t=>{e[n]=t}});a.append(p)}function u(t){const a=t.value,n=new UILabel({text:"Counts"});o.append(n);const s=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),o.removeK("count"+e.startLoops.length)}});o.append(s);const l=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),d(e.startLoops.length-1,t),console.log("add count",e.startLoops)}});o.append(l);for(let t=0;t<a.length;t++)d(t,a[t])}function d(t,a){const n=new UIRow({class:"break-line-up"});o.append(n,"count"+t);const s=new UILabel({text:"Count "+t});n.append(s);const l=new UILabel({text:"Loops"});n.append(l);const i=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),n.removeK("loop"+e.startLoops[t].length)}});n.append(i);const c=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),m(t,e.startLoops[t].length-1,{},n)}});n.append(c);for(let e=0;e<a.length;e++)m(t,e,a[e],n)}function m(t,e,a,n){const o=new UIRow;n.append(o,"loop"+e);const l=new UILabel({text:"Loop "+e});o.append(l);const i=new UISelectButton({options:Object.keys(s),class:"break",callback:a=>{h(a,s[a],t,e,o)}});o.append(i);for(const n in a)h(n,a[n],t,e,o)}function h(t,a,n,o,s){let i=l(t);switch(typeof a){case"boolean":let l=new UIToggleCheck({label:i,value:a,callback:a=>{e.startLoops[n][o][t]=a}});s.append(l);break;case"number":let c=new UILabel({text:i});s.append(c);let p=new UINumberStep({value:a,callback:a=>{e.startLoops[n][o][t]=a}});s.append(p)}s.append(new UILabel({class:"break"}))}this.init=function(e){o=t.ui.panels.loops.startLoops},this.load=function(o){o&&a.forEach((t=>{if(void 0!==o[t.key])if(e[t.key]=o[t.key],"list"===t.type)for(const e in o[t.key])t[e]=o[t.key][e];else t.value=o[t.key]}));const s=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let e=0;e<a.length;e++){const o=a[e];let d;if(o.panel){const e=o.panel;if(t.ui.panels[e]||t.ui.createPanel(e,{label:"Param "+l(e)}),d=t.ui.panels[e].lastRow,s[e]){const{gridArea:a}=s[e],n=t.ui.panels[e];n.setup(s[e]),t.ui.layout[a].panels.append(n)}}else d=n.panel.doodooParams;switch(a[e].type){case"range":p(o,d);break;case"list":c(o,d);break;case"chance":i(o,d);break;case"int":r(o,d);break;case"loops":u(o)}}},this.get=function(){return{...e}}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],startDuration:"4n",bpm:120,samples:"../samples/choir/"};t.params=new Params(t,doodooDefaults,doodooDefaultParams),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0}),t.ui.settings=new Settings(t,"doodoo"),t.fio=new FilesIO(t),t.ui.load("./interface.json",(()=>{t.ui.settings.load(),t.composition.init(),t.params.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const a=JSON.parse(e);t.composition.load(a),t.params.load(a.params)}else t.composition.load({}),t.params.load()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
