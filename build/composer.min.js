const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooParams:doodooParams}=doodooLib;function Composition(t,e){const a=this;let n,o,s,i,l,{MIDI_NOTES:p}=t;Object.defineProperty;this.tonic=e.tonic,this.bpm=e.bpm,this.samples=e.samples,this.scale=e.scale,this.title=e.title,this.startDuration=e.startDuration,this.parts=[],this.useMetro=!1,this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){a.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",a.uiScale)},this.setNoteWidth=function(t){a.noteWidth=t,o&&a.updateDisplay()},this.init=function(){s=a.panel.scaleRow,o=t.ui.panels.melody.melody,i=t.ui.panels.melody.melodyInput.noteInput,l=t.ui.panels.melody.melodyInput.durationInput,a.setUIScale(a.uiScale)},this.updateScale=function(){s.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:a.scale[t],min:-11,max:11,callback:e=>{a.scale[t]=+e}});s.append(e,t)}},this.play=function(e){if(0===a.parts.length)return alert("Add notes to the melody.");a.update(),n&&(n.stop(),Tone.Transport.cancel());const o=a.get();n=new Doodoo({...o,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:a.useMetro,params:t.params.get()}),n.play(),t.fio.saveLocal(o)},this.stop=function(){n&&n.stop()},this.mutate=function(){n&&n.mutate()},this.update=function(){a.parts=[];let t=!1;const e=o.children,n=Array.from(e).map((e=>{let a,n=e.note.value,o=e.duration.value;return["null","rest"].includes(n)?a=null:(a=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),a=t[t.length-1],n=t.includes("#")?"#":"";return!(isNaN(+a)||!"ABCDEFG".includes(e))&&e+n+a}(n),a||(t=!0)),o.length>3&&(t=!0),isNaN(+o[0])&&(t=!0),1===o.length&&(o+="n"),[a,o]}));if(t)return alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc.");a.parts=n},this.addNote=function(t,e,n){let s=t||i.value,c=e||l.value,u=new UICollection({class:"note-collection"});u.addClass("d"+c.replace(/\./g,"dot"));let r=new UIListStep({value:s,class:"note-edit",list:[...p,"null","rest"]}),d=new UIListStep({value:c,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=a.startDuration,d.value=t),u.el.className="note-collection d"+t.replace(/\./g,"dot"),a.update(),a.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),m=new UIButton({text:"X",class:"remove-btn",callback:()=>{o.remove(u),a.update(),a.updateDisplay()}});u.append(r,"note"),u.append(d,"duration"),u.append(m),o.append(u),n||a.update(),n||a.updateDisplay()},this.updateDisplay=function(){a.parts.length;const t=o.el.getBoundingClientRect().width,e=a.parts.map((t=>t[1])),n=Math.max(...e.map((t=>parseInt(t))));e.includes(n+"n.");let s=4;for(;t/s>a.noteWidth;)s+=4;o.setProp("--column-width",Math.floor(t/s)),o.setProp("--notes-per-row",s),o.setProp("--default-duration",n)},this.clear=function(){o.clear()},this.get=function(){return a.update(),{parts:a.parts,tonic:a.tonic,bpm:a.bpm,samples:a.samples,title:this.title,startDuration:this.startDuration,scale:this.scale}},this.load=function(e){var n;e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(n=e.tonic,p[n])),e.startDuration&&t.ui.faces.startDuration.update(e.startDuration),e.scale&&(a.scale=e.scale.map((t=>+t))),a.updateScale(),e.parts&&(a.clear(),a.parts=[],e.parts.forEach((t=>{if(null===t)return a.addNote("rest",e.startDuration,!0);const n="string"==typeof t?t:t[0],o="string"==typeof t?e.startDuration:t[1];null===n?a.addNote("rest",o,!0):a.addNote(n,o,!0)}))),a.update(),a.updateDisplay()}}function FilesIO(t){this.load=function(e){t.composition.load(e)},this.saveLocal=function(e){e||(e=t.composition.get()),localStorage.setItem("comp",JSON.stringify(e))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){t.composition.update();const e=localStorage.getItem("comp"),a=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(a,prompt("Name composition",t.composition.title)+".json")}}function Params(t,e,a){const n=this;let o;function s(t){let{key:a,value:n,range:s,step:i}=t,l=a[0].toUpperCase()+a.substring(1);l=l.replace(/(?=[A-Z])/g," ");const p=new UILabel({text:l+" Min"}),c=new UINumberRange({value:n[0],min:s[0],max:s[1],step:i[0],callback:t=>{e[a][0]=t}}),u=new UILabel({text:l+" Max"}),r=new UINumberRange({value:n[1],min:s[0],max:s[1],step:i[0],callback:t=>{e[a][1]=t}});if(o.append(p),o.append(c),o.append(u),o.append(r),n.length>2){const t=new UILabel({text:l+" Update Min"}),p=new UINumberRange({value:n[2],min:s[2],max:s[3],step:i[1],callback:t=>{e[a][2]=t}}),c=new UILabel({text:l+" Update Max"}),u=new UINumberRange({value:n[3],min:s[2],max:s[3],step:i[1],callback:t=>{e[a][3]=t}});o.append(t),o.append(p),o.append(c),o.append(u)}}function i(t){let{key:a,start:n,add:s,chance:i}=t,l=a[0].toUpperCase()+a.substring(1);l=l.replace(/(?=[A-Z])/g," ");const p=new UILabel({text:l+" Start"}),c=new UINumberList({list:n,callback:t=>{e[a].start=t}});o.append(p),o.append(c);const u=new UILabel({text:l+" Add"}),r=new UINumberList({list:s,callback:t=>{e[a].add=t}});o.append(u),o.append(r);const d=new UILabel({text:l+" Chance"}),m=new UINumberRange({value:i,min:0,max:1,step:.01,callback:t=>{e[a].chance=t}});o.append(d),o.append(m)}this.init=function(){o=n.panel.doodooParams;for(let t=0;t<a.length;t++)switch(a[t].type){case"range":s(a[t]);break;case"list":i(a[t])}},this.get=function(){return{...e}}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],startDuration:"4n",bpm:120,samples:"../samples/choir/"};t.params=new Params(t,doodooDefaults,doodooParams),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0}),t.ui.settings=new Settings(t,"doodoo"),t.fio=new FilesIO(t),t.ui.load("./interface.json",(()=>{t.ui.settings.load(),t.composition.init();const e=localStorage.getItem("comp");e&&"undefined"!==e?t.composition.load(JSON.parse(e)):t.composition.load({}),t.params.init()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
