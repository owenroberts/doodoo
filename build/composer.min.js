const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooDefaultParams:doodooDefaultParams}=doodooLib;function Composition(t,e){const a=this;let o,n,s,l,{MIDI_NOTES:i}=t;function p(t){t.forEach((t=>{if(null===t)return a.addNote("rest",data.startDuration,!0);const e="string"==typeof t?t:t[0],o="string"==typeof t?data.startDuration:t[1];null===e?a.addNote("rest",o,!0):a.addNote(e,o,!0)}))}this.tonic=e.tonic,this.transform=e.transform||e.tonic,this.bpm=e.bpm,this.samples=e.samples,this.scale=e.scale,this.title=e.title,this.startDuration=e.startDuration,this.parts=[],this.useMetro=!1,this.currentPart=0,this.partRows=[],this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){a.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",a.uiScale)},this.setNoteWidth=function(t){a.noteWidth=t,a.partRows[0]&&a.updateDisplay()},this.init=function(){n=a.panel.scaleRow,a.partRows[0]=t.ui.panels.melody.addRow("part-0","break-line-up"),a.partRows[0].addClass("part"),s=t.ui.panels.melody.melodyInput.noteInput,l=t.ui.panels.melody.melodyInput.durationInput,a.setUIScale(a.uiScale)},this.updateScale=function(){n.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:a.scale[t],min:-11,max:11,callback:e=>{a.scale[t]=+e}});n.append(e,t)}},this.play=function(e){if(0===a.parts.length)return alert("Add notes to the melody.");a.update(),o&&(o.stop(),Tone.Transport.cancel());const n=a.get();o=new Doodoo({...n,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:a.useMetro,params:t.params.get()}),o.play(),t.fio.saveLocal(n)},this.stop=function(){o&&o.stop()},this.mutate=function(){o&&o.mutate()},this.update=function(){function t(t){let e=!1;const a=Array.from(t).map((t=>{let a,o=t.note.value,n=t.duration.value;return["null","rest"].includes(o)?a=null:(a=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),a=t[t.length-1],o=t.includes("#")?"#":"";return!(isNaN(+a)||!"ABCDEFG".includes(e))&&e+o+a}(o),a||(e=!0)),n.length>3&&(e=!0),isNaN(+n[0])&&(e=!0),1===n.length&&(n+="n"),[a,n]}));return e?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):a}if(a.parts=[],a.partRows.length>1)for(let e=0;e<a.partRows.length;e++)a.parts.push(t(a.partRows[e].children));else a.parts=t(a.partRows[0].children)},this.addNote=function(t,e,o){let n=t||s.value,p=e||l.value,r=new UICollection({class:"note-collection"});r.addClass("d"+p.replace(/\./g,"dot"));let c=new UIListStep({value:n,class:"note-edit",list:[...i,"null","rest"]}),u=new UIListStep({value:p,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=a.startDuration,u.value=t),r.el.className="note-collection d"+t.replace(/\./g,"dot"),a.update(),a.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),d=new UIButton({text:"X",class:"remove-btn",callback:()=>{a.partRows[a.currentPart].remove(r),a.update(),a.updateDisplay()}});r.append(c,"note"),r.append(u,"duration"),r.append(d),a.partRows[a.currentPart].append(r),o||a.update(),o||a.updateDisplay()},this.updateDisplay=function(){a.parts.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,o=a.partRows.length>1?a.parts.flatMap((t=>t.map((t=>t[1])))):a.parts.flatMap((t=>t[1]));let n=Math.max(...o.map((t=>parseInt(t))));o.includes(n+"n."),n<0&&(n="4n");let s=4;for(;e/s>a.noteWidth;)s+=4;t.ui.panels.melody.setProp("--column-width",Math.floor(e/s)),t.ui.panels.melody.setProp("--notes-per-row",s),t.ui.panels.melody.setProp("--default-duration",n)},this.clear=function(){a.partRows[a.currentPart].clear()},this.get=function(){return a.update(),{parts:a.parts,tonic:a.tonic,transform:a.transform,bpm:a.bpm,samples:a.samples,title:this.title,startDuration:this.startDuration,scale:this.scale}},this.load=function(e){var o;if(e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(o=e.tonic,i[o])),e.startDuration&&t.ui.faces.startDuration.update(e.startDuration),e.scale&&(a.scale=e.scale.map((t=>+t))),a.updateScale(),e.parts){if(a.clear(),a.parts=[],Array.isArray(e.parts[0]))if(Array.isArray(e.parts[0][0]))for(let o=0;o<e.parts.length;o++){if(a.currentPart=o,o>0){let e=t.ui.panels.melody.addRow("part-"+o,"break-line-up");e.addClass("part"),a.partRows.push(e)}p(e.parts[o])}else p(e.parts);a.currentPart=0}a.update(),a.updateDisplay()}}function FilesIO(t){this.load=function(e){t.composition.load(e),t.params.load(e.params)},this.saveLocal=function(e,a){e||(e=t.composition.get()),a||(a=t.params.get()),localStorage.setItem("comp",JSON.stringify({...e,params:a}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){t.composition.update();const e=localStorage.getItem("comp"),a=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(a,prompt("Name composition",t.composition.title)+".json")},this.loadMidi=function(e,a,o){new Midi.fromUrl(o).then((e=>{e.tracks.forEach((e=>{const a=e.notes;for(let e=0;e<a.length;e++){const{name:o,duration:n,time:s}=a[e];let l=o,i=e===a.length-1;if(e>0){const o=a[e-1];let n=s-(o.time+o.duration);n>0&&t.composition.addNote("rest",Tone.Time(n).toNotation(),i)}t.composition.addNote(l,Tone.Time(n).toNotation(),i)}}))}))}}function Params(t,e,a){let o={...e};const n={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function s(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function l(t,a,o){let{key:n,value:s,index:l,range:i}=t;o&&a.append(new UILabel({text:o})),a.append(new UIChance({label:"Chance",value:void 0!==l?s[l]:s,min:i?i[0]:0,max:i?i[1]:1,step:.01,callback:t=>{void 0!==l?e[n][l]=t:e[n]=t}}))}function i(t,a,o){let{key:n,value:s,range:l,step:i,index:p}=t;o&&a.append(new UILabel({text:o})),a.append(new UINumberStep({value:void 0!==p?s[p]:s,min:l[0],max:l[1],step:t.step||1,callback:t=>{void 0!==p?e[n][p]=t:e[n]=t}}))}function p(t){const a=t.value,o=new UILabel({text:"Counts"});startLoopsRow.append(o);const n=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),startLoopsRow.removeK("count"+e.startLoops.length)}});startLoopsRow.append(n);const s=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),r(e.startLoops.length-1,t),console.log("add count",e.startLoops)}});startLoopsRow.append(s);for(let t=0;t<a.length;t++)r(t,a[t])}function r(t,a){const o=new UIRow({class:"break-line-up"});startLoopsRow.append(o,"count"+t);const n=new UILabel({text:"Count "+t});o.append(n);const s=new UILabel({text:"Loops"});o.append(s);const l=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),o.removeK("loop"+e.startLoops[t].length)}});o.append(l);const i=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),c(t,e.startLoops[t].length-1,{},o)}});o.append(i);for(let e=0;e<a.length;e++)c(t,e,a[e],o)}function c(t,e,a,o){const s=new UIRow;o.append(s,"loop"+e);const l=new UILabel({text:"Loop "+e});s.append(l);const i=new UISelectButton({options:Object.keys(n),class:"break",callback:a=>{u(a,n[a],t,e,s)}});s.append(i);for(const o in a)u(o,a[o],t,e,s)}function u(t,a,o,n,l){let i=s(t);switch(typeof a){case"boolean":let s=new UIToggleCheck({label:i,value:a,callback:a=>{e.startLoops[o][n][t]=a}});l.append(s);break;case"number":let p=new UILabel({text:i});l.append(p);let r=new UINumberStep({value:a,callback:a=>{e.startLoops[o][n][t]=a}});l.append(r)}l.append(new UILabel({class:"break"}))}function d(t,a){const{key:n,type:p}=t,r=s(n);a.append(new UILabel({text:r})),a.append(new UIButton({text:"Reset",callback:()=>{const s=Array.isArray(o[n])?[...o[n]]:o[n];e[n]=s,t.value=s,a.clear(),d(t,a)}})),"range"===p&&function(t,e,a){let{key:o,value:n,range:s,step:p}=t;if(a&&e.append(new UILabel({text:a})),i({...t,index:0},e,"Min"),i({...t,index:1},e,"Max"),n.length>2){let a=s.length<=2?[0,1]:s.slice(2);l({...t,range:a,index:2},e,"Min Update"),l({...t,range:a,index:3},e,"Max Update")}}(t,a),"list"===p&&t.value&&function(t,a,o){let{key:n,value:s}=t;o&&a.append(new UILabel({text:o})),a.append(new UINumberList({list:s,callback:t=>{e[n]=t}}))}(t,a),"chance"===p&&l(t,a),"number"===p&&i(t,a)}this.init=function(e){startLoopsRow=t.ui.panels.loops.startLoops},this.load=function(o){o&&a.forEach((t=>{if(void 0!==o[t.key])if(e[t.key]=o[t.key],"list"===t.type)for(const e in o[t.key])t[e]=o[t.key][e];else t.value=o[t.key]}));const n=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let e=0;e<a.length;e++){const o=a[e];let l;if(o.panel){const e=o.panel;if(t.ui.panels[e]?l=t.ui.panels[e].lastRow:t.ui.createPanel(e,{label:"Param "+s(e)}),l=t.ui.panels[e].addRow(),l.addClass("break-line-up"),n[e]){const{gridArea:a}=n[e],o=t.ui.panels[e];o.setup(n[e]),t.ui.layout[a].panels.append(o)}}"loops"===o.type?p(o):d(o,l)}},this.get=function(){return{...e}}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],startDuration:"4n",bpm:120,samples:"../samples/choir/"};t.params=new Params(t,doodooDefaults,doodooDefaultParams),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0}),t.ui.settings=new Settings(t,"doodoo"),t.fio=new FilesIO(t),t.ui.load("./interface.json",(()=>{t.ui.settings.load(),t.composition.init(),t.params.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const a=JSON.parse(e);t.composition.load(a),t.params.load(a.params)}else t.composition.load({}),t.params.load()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
