import{Doodoo,MIDI_NOTES,defaults,controls}from"Doodoo";import{UINumberStep,UICollection,UIListStep,UIButton,UILabel,UIChance,UINumberList,Interface,Settings}from"UI";function Composition(t,e){const n=this;let o,l,a,i,s;function r(t){t.forEach((t=>{if(null===t)return n.addNote("rest",data.duration,!0);const e="string"==typeof t?t:t[0],o="string"==typeof t?data.duration:t[1];null===e?n.addNote("rest",o,!0):n.addNote(e,o,!0)}))}this.tonic=e.tonic,this.transform=e.transform||e.tonic,this.bpm=e.bpm,this.voices=[],this.scale=e.scale,this.title=e.title,this.duration=e.duration,this.parts=[],this.simultaneous=e.simultaneous,this.useMetro=!1,this.currentPart=0,this.partRows=[],this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){n.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",n.uiScale)},this.setNoteWidth=function(t){n.noteWidth=t,n.partRows[0]&&n.updateDisplay()},this.init=function(){l=t.ui.panels.composition.scaleRow,s=t.ui.panels.composition.voiceRow,n.partRows[0]=t.ui.panels.melody.addRow("part-0","break-line-up"),n.partRows[0].addClass("part"),a=t.ui.panels.melody.melodyInput.noteInput,i=t.ui.panels.melody.melodyInput.durationInput,n.setUIScale(n.uiScale)},this.updateScale=function(){l.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:n.scale[t],min:-11,max:11,callback:e=>{n.scale[t]=+e}});l.append(e,t)}},this.play=function(e){if(0===n.parts.length)return alert("Add notes to the melody.");n.update(),o&&(o.stop(),Tone.Transport.cancel());const l=n.get();o=new Doodoo({...l,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e,t.score.update(o.getLoops())},useMetro:n.useMetro,controls:t.controls.get()}),t.fio.saveLocal(l),t.score.update(o.getLoops())},this.isRecording=function(){return!!o&&o.isRecording()},this.stop=function(){o&&o.stop()},this.mutate=function(){o&&o.mutate()},this.update=function(){function t(t){let e=!1;const n=Array.from(t).map((t=>{let n,o=t.note.value,l=t.duration.value;return["null","rest"].includes(o)?n=null:(n=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),n=t[t.length-1],o=t.includes("#")?"#":"";return!(isNaN(+n)||!"ABCDEFG".includes(e))&&e+o+n}(o),n||(e=!0)),l.length>3&&(e=!0),isNaN(+l[0])&&(e=!0),1===l.length&&(l+="n"),[n,l]}));return e?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):n}if(n.parts=[],n.partRows.length>1)for(let e=0;e<n.partRows.length;e++)n.parts.push(t(n.partRows[e].children));else n.parts=t(n.partRows[0].children)},this.addNote=function(t,e,o){let l=t||a.value.toUpperCase(),s=e||i.value,r=new UICollection({class:"note-collection"});r.addClass("d"+s.replace(/\./g,"dot"));let c=new UIListStep({value:l,class:"note-edit",list:[...MIDI_NOTES,"null","rest"]}),p=new UIListStep({value:s,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=n.duration,p.value=t),r.el.className="note-collection d"+t.replace(/\./g,"dot"),n.update(),n.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),u=new UIButton({text:"x",class:"remove-btn",callback:()=>{n.partRows[n.currentPart].remove(r),n.update(),n.updateDisplay()}});r.append(c,"note"),r.append(p,"duration"),r.append(u),n.partRows[n.currentPart].append(r),o||n.update(),o||n.updateDisplay()},this.addPart=function(){console.log("add part");let e=t.ui.panels.melody.addRow("part-"+n.partRows.length,"break-line-up");e.addClass("part"),n.partRows.push(e),n.currentPart=n.partRows.length-1,t.ui.faces.currentPart.addOption(n.currentPart,!0,"Part "+n.currentPart)},this.addVoice=function(t){if(Array.isArray(n.voices)||(n.voices=[n.voices]),n.voices.includes(t))return;n.voices.push(t);const e=new UICollection({class:"voice-collection"});e.append(new UILabel({text:t})),e.append(new UIButton({text:"X",callback:()=>{n.voices.splice(n.voices.indexOf(t),1),s.remove(e)}})),s.append(e)},this.updateDisplay=function(){n.parts.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,o=n.partRows.length>1?n.parts.flatMap((t=>t.map((t=>t[1])))):n.parts.flatMap((t=>t[1]));let l=Math.max(...o.map((t=>parseInt(t))));o.includes(l+"n."),l<0&&(l="4n");let a=4;for(;e/a>n.noteWidth;)a+=4;t.ui.panels.melody.setProp("--column-width",Math.floor(e/a)),t.ui.panels.melody.setProp("--notes-per-row",a),t.ui.panels.melody.setProp("--default-duration",l)},this.clear=function(){n.partRows.forEach((t=>t.clear()))},this.get=function(){return n.update(),{parts:n.parts,tonic:n.tonic,transform:n.transform,bpm:n.bpm,voices:n.voices,title:this.title,duration:this.duration,scale:this.scale,simultaneous:this.simultaneous}},this.load=function(o){if(o.title&&t.ui.faces.title.update(o.title),o.transform&&t.ui.faces.transform.update(o.transform),o.bpm&&t.ui.faces.bpm.update(o.bpm),o.duration&&t.ui.faces.duration.update(o.duration),o.voices){(Array.isArray(o.voices)?[...o.voices]:[o.voices]).forEach((t=>{n.addVoice(t)}))}else e.voices.forEach((t=>{n.addVoice(t)}));var l;if(o.tonic&&t.ui.faces.tonic.update("string"==typeof o.tonic?o.tonic:(l=o.tonic,MIDI_NOTES[l])),o.scale&&(n.scale=o.scale.map((t=>+t))),n.updateScale(),o.parts){if(n.clear(),n.parts=[],Array.isArray(o.parts[0]))if(Array.isArray(o.parts[0][0]))for(let e=0;e<o.parts.length;e++){if(n.currentPart=e,e>0){let o=t.ui.panels.melody.addRow("part-"+e,"break-line-up");o.addClass("part"),n.partRows.push(o)}r(o.parts[e])}else r(o.parts);n.currentPart=0}n.update(),n.updateDisplay()}}function Controls(t,e,n){let o,l={...e};const a={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function i(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function s(t,n){const{key:o,type:l}=t,a=i(o);n.append(new UILabel({text:a})),n.append(new UIButton({text:"Reset",callback:()=>{r(o,n)}})),"range"===l&&function(t,e,n){let{key:o,value:l,range:a,step:i}=t;n&&e.append(new UILabel({text:n}));if(p({...t,index:0},e,"Min"),p({...t,index:1},e,"Max"),l.length>2){let n=a.length<=2?[0,1]:a.slice(2);c({...t,range:n,index:2},e,"Min Update"),c({...t,range:n,index:3},e,"Max Update")}}(t,n),"list"===l&&t.value&&function(t,n,o){let{key:l,value:a}=t;o&&n.append(new UILabel({text:o}));n.append(new UINumberList({list:a,callback:t=>{e[l]=t}}))}(t,n),"chance"===l&&c(t,n),"number"===l&&p(t,n)}function r(t,o,a){const i=n.filter((e=>e.key===t))[0];void 0===a&&(a=Array.isArray(l[t])?[...l[t]]:l[t]),e[t]=a,i.value=a,o.clear(),s(i,o)}function c(t,n,o){let{key:l,value:a,index:i,range:s}=t;o&&n.append(new UILabel({text:o})),n.append(new UIChance({label:"Chance",value:void 0!==i?a[i]:a,min:s?s[0]:0,max:s?s[1]:1,step:.01,callback:t=>{void 0!==i?e[l][i]=t:e[l]=t}}))}function p(t,n,o){let{key:l,value:a,range:i,step:s,index:r}=t;o&&n.append(new UILabel({text:o})),n.append(new UINumberStep({value:void 0!==r?a[r]:a,min:i[0],max:i[1],step:t.step||1,callback:t=>{void 0!==r?e[l][r]=t:e[l]=t}}))}function u(t){const n=t.value,l=new UILabel({text:"Counts"});o.append(l);const a=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),o.removeK("count"+e.startLoops.length)}});o.append(a);const i=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),d(e.startLoops.length-1,t)}});o.append(i);for(let t=0;t<n.length;t++)d(t,n[t])}function d(t,n){const l=new UIRow({class:"break-line-up"});o.append(l,"count"+t);const a=new UILabel({text:"Count "+t});l.append(a);const i=new UILabel({text:"Loops"});l.append(i);const s=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),l.removeK("loop"+e.startLoops[t].length)}});l.append(s);const r=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),f(t,e.startLoops[t].length-1,{},l)}});l.append(r);for(let e=0;e<n.length;e++)f(t,e,n[e],l)}function f(t,e,n,o){const l=new UIRow;o.append(l,"loop"+e);const i=new UILabel({text:"Loop "+e});l.append(i);const s=new UISelectButton({options:Object.keys(a),class:"break",callback:n=>{h(n,a[n],t,e,l)}});l.append(s);for(const o in n)h(o,n[o],t,e,l)}function h(t,n,o,l,a){let s=i(t);switch(typeof n){case"boolean":let i=new UIToggleCheck({label:s,value:n,callback:n=>{e.startLoops[o][l][t]=n}});a.append(i);break;case"number":let r=new UILabel({text:s});a.append(r);let c=new UINumberStep({value:n,callback:n=>{e.startLoops[o][l][t]=n}});a.append(c)}a.append(new UILabel({class:"break"}))}this.resetControls=function(){let e=n.findIndex((t=>"fxLimit"===t.key));for(let o=0;o<e;o++){const{key:e,panel:l}=n[o];"loops"!==e&&r(e,t.ui.panels[l]["row-"+e])}},this.resetEffects=function(){for(let e=n.findIndex((t=>"fxLimit"===t.key));e<n.length;e++){const{key:o,panel:l}=n[e];r(o,t.ui.panels[l]["row-"+o])}},this.zeroEffects=function(){for(let e=n.findIndex((t=>"fxLimit"===t.key));e<n.length;e++){const{key:o,panel:l}=n[e];o.includes("Chance")&&r(o,t.ui.panels[l]["row-"+o],0)}},this.init=function(e){o=t.ui.panels.loops.startLoops},this.load=function(o){if(o)for(let t=0;t<n.length;t++){const{key:l,type:a}=n[t];if(void 0!==o[l])switch(e[l]=o[l],a){case"list":for(const e in o[l])n[t][e]=o[l][e];break;case"effect":n[t].chance=o[l+"Chance"],n[t].delay=o[l+"Delay"];break;default:n[t].value=o[l]}}const l=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let e=0;e<n.length;e++){const o=n[e];let a;if(o.panel){const e=o.panel;if(t.ui.panels[e]||t.ui.createPanel(e,{label:i(e)+" Control"}),a=t.ui.panels[e].addRow("row-"+o.key),a.addClass("break-line-up"),l[e]){const{gridArea:n}=l[e],o=t.ui.panels[e];o.setup(l[e]),t.ui.layout[n].panels.append(o)}}"loops"===o.type?u(o):s(o,a)}},this.get=function(){return{...e}}}function FilesIO(t){this.load=function(e){t.composition.load(e),t.controls.load(e.controls)},this.saveLocal=function(e,n){e||(e=t.composition.get()),n||(n=t.controls.get()),localStorage.setItem("comp",JSON.stringify({...e,controls:n}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){if(t.composition.isRecording())return;t.composition.update();const e=localStorage.getItem("comp"),n=new Blob([e],{type:"application/x-download;charset=utf-8"}),o=prompt("Name composition",t.composition.title);o&&(saveAs(n,o+".json"),t.ui.faces.title.update(o))},this.loadMidi=function(e,n,o){new Midi.fromUrl(o).then((e=>{e.tracks.forEach((e=>{const n=e.notes;for(let e=0;e<n.length;e++){const{name:o,duration:l,time:a}=n[e];let i=o,s=e===n.length-1;if(e>0){const o=n[e-1];let l=a-(o.time+o.duration);l>0&&t.composition.addNote("rest",Tone.Time(l).toNotation(),s)}t.composition.addNote(i,Tone.Time(l).toNotation(),s)}}))}))}}function Score(t){const e=document.createElement("canvas");let n,o;if(!e.getContext("2d"))return;o=e.getContext("2d");let l=20,a=12,i="CDEFGAB".split(""),s=["F","C","G","D","A","E","B"],r=["B","E","A","D","G","C","F"],c={G:["#",1],D:["#",2],A:["#",3],E:["#",4],B:["#",5],"F#":["#",6],"C#":["#",7],F:["b",1],Bb:["b",2],Eb:["b",3],Ab:["b",4],Db:["b",5],Gb:["b",6],Cb:["b",7]},p={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B",Eb:"Gb","D#":"F#",Bb:"Db",F:"Ab",C:"Eb",G:"Bb",D:"F"},u=["G","F","E","D","C","B","A"];function d(t,e,n,l){o.beginPath(),o.moveTo(t,e),o.lineTo(n,l),o.stroke()}function f(t,e){let n=t[0],o=+t[t.length-1],l=e[0],a=+e[e.length-1];return i.indexOf(n)-i.indexOf(l)+7*(o-a)}function h(i){let{width:h,height:m}=n.el.getBoundingClientRect();const{tonic:g,scale:b}=t.composition,w=MIDI_NOTES.indexOf(g),y=b.map((t=>{let e=MIDI_NOTES[w+t];return e.substring(0,e.length-1)}));let I=g.substring(0,g.length-1);b.includes(3)&&!b.includes(4)&&(I=p[I]);let v=[];if(c[I]){let t=c[I];v="#"===t[0]?s.slice(0,t[1]):r.slice(0,t[1])}let x=16,k=32+v.length*x,C=k,U=l,S=h-8-k-20,M=0===i.length?4:Math.max(...i.flatMap((t=>t.melody.map((t=>+t[1][0]))))),L=Math.max(...i.map((t=>t.len))),R=Math.ceil(L/M),D=i.flatMap((t=>t.melody)).map(((t,e)=>[t[0]?t[0].substring(0,t[0].length-1):null,Math.floor(e%L/M)])).filter((t=>null!==t[0])).filter((t=>!y.includes(t[0]))),N=D.length,E=[];for(let t=0;t<R;t++)E[t]=D.filter((e=>e[1]===t)).length;let P=1,A=1+R+R*M+N,T=[A];if(S>L*x+R*x+N*x)x=Math.floor(S/A);else{T=[0];for(let t=0;t<R;t++){let e=M+E[t]+1,n=e*x;T[P-1]*x+n<S?T[P-1]+=e:(P++,T.push(e))}}e.width=h-8,e.height=144*P+40,o.fillStyle="lightgray",o.fillRect(0,0,e.width,e.height),o.fillStyle="black",o.strokeStyle="black";for(let t=0;t<P;t++){let e=l+144*t,n=32;o.strokeStyle="gray";for(let t=0;t<11;t++){let n=l+t*a+a;5!==t&&d(10,e+n,h-10-8,e+n)}o.fillStyle="black",o.font="60px serif",o.fillText("𝄞",10,e+l+54),o.font="36px serif",o.fillText("𝄢",10,e+l+114),o.font="18px serif",v.forEach((t=>{let l=32+e+6*u.indexOf(t);o.fillText("♯",n,l),o.fillText("♯",n,l+84),n+=16}))}if(0===i.length)return;let B=C+x,F=0,O=0,G=0,W=T[G];for(let t=0;t<=L;t++){let e=x;if(G<P-1&&(e=Math.floor(S/T[G])),t===L){o.fillStyle="black",o.fillRect(B-e/2,U+l+a,6,48),o.fillRect(B-e/2,U+l+84,6,48);continue}if(t>0&&t+O>W-1&&(G++,U+=144,B=C+x,W+=T[G]),t===L){o.fillStyle="black",o.fillRect(B,U+l+a,6,48),o.fillRect(B,U+l+84,6,48);continue}let n=[],s=[];for(let e=0;e<i.length;e++){let{startDelay:o,startIndex:l,doubler:a,repeat:r,melody:c}=i[e],p=(t-o+l)%c.length;c[p]&&(n.push(c[p]),s.push(c.slice(p-F,p+(M-F))))}if(n.every((t=>null===t[0]))){let t=!1;if(o.font="26px Noto",s.flatMap((t=>t)).every((t=>null===t[0]))&&0===tempCount&&(o.fillText("𝄻",B+e,U+132),t=!0),s.forEach((e=>{e.forEach(((e,n)=>{n<F&&n+M/parseInt(e[1])>F&&(t=!0)}))})),!t){let t=M/4*2,n=F%t,l=F>=t?1:0,a=s.map((e=>e.slice(t*l,t+t*l)));a.flatMap((t=>t)).every((t=>null===t[0]))?0===n&&o.fillText("𝄼",B+e,U+132):n%2==0?a.filter((t=>t[n+1])).every((t=>null===t[n+1][0]))?o.fillText("𝄽",B+e/2,U+138):o.fillText("𝄾",B,U+138):a.filter((t=>t[n-1])).every((t=>null!==t[n-1][0]))&&o.fillText("𝄾",B,U+138)}F++}else o.strokeStyle="black",n.forEach((t=>{let[n,a]=t;if(null===n)return;let i=l+U+72+6*f("C4",n),r=n.substring(0,n.length-1);if(y.includes(r)||(o.font="18px sans-serif",n.includes("#")?o.fillText("♯",B-e/2,i+8):o.fillText("♮",B-e/2,i+8),B+=e,O++),"1n"===a&&(o.beginPath(),o.ellipse(B,i,5,3,-Math.PI/6,0,2*Math.PI),o.stroke()),"2n"===a&&(o.beginPath(),o.ellipse(B,i,5,3,-Math.PI/6,0,2*Math.PI),o.stroke(),d(B+5,i-1,B+5,i-24)),"4n"===a&&(o.beginPath(),o.ellipse(B,i,6,4,-Math.PI/6,0,2*Math.PI),o.fill(),d(B+5,i-1,B+5,i-24)),"8n"===a){let t=M/4*2,l=F%t,a=F>=t?1:0,r=s.map((e=>e.slice(t*a,t+t*a))),c=72+6*f("C4",n),p=0;for(let n=0;n<t;n++){let t=r.filter((t=>t[n])).map((t=>t[n]));if(n>l&&(t.every((t=>null===t[0]))||t.every((t=>"8n"!==t[1]))))break;t.every((t=>null===t[0]))||(n>l&&(p+=e),t.forEach((t=>{if(null===t[0])return;let e=72+6*f("C4",t[0]);e<c&&(c=e)})))}let u=!1;p>0?o.fillRect(B+5,U+c-6,p,4):u=r.filter((t=>t[l-1])).every((t=>null===t[l-1][0])),d(B+5,i-1,B+5,U+c-6),o.beginPath(),o.ellipse(B,i,6,4,-Math.PI/6,0,2*Math.PI),o.fill(),u&&d(B+5,U+c-6,B+10,U+c+6)}U>80&&U<104&&d(B-12,U+l+72,B+12,U+l+72)})),F++;if(F===M){B+=e,O++;let t=B;o.strokeStyle="black",d(t+e/2,U+l+a,t+e/2,U+l+60),d(t+e/2,U+l+84,t+e/2,U+l+132),F=0}B+=e}}new FontFace("Noto","url(https://fonts.gstatic.com/s/notomusic/v14/pe0rMIiSN5pO63htf1sxEkW7I9tAcVwo.woff2)").load().then((t=>{document.fonts.add(t),console.log("Font loaded")})),this.update=function(t){h(t)},this.init=function(){n=t.ui.panels.score,n.el.appendChild(e),h([])}}const app={},compDefaults={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],duration:"4n",bpm:120,voices:["choir","toms"]};app.controls=new Controls(app,defaults,controls),app.composition=new Composition(app,compDefaults),app.ui=new Interface(app,{useMain:!0});const workspaceFields=["noteWidth"];app.ui.settings=new Settings(app,"doodoo",void 0,workspaceFields),app.fio=new FilesIO(app),app.score=new Score(app),app.ui.load("./interface/panels.json",(()=>{app.ui.settings.load(),app.composition.init(),app.controls.init();const t=localStorage.getItem("comp");if(t&&"undefined"!==t){const e=JSON.parse(t);app.composition.load(e),app.controls.load(e.controls)}else app.composition.load({}),app.controls.load();app.score.init()})),console.log(app);
//# sourceMappingURL=src_maps/composer.min.js.map
