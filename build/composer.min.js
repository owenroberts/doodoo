const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,doodooDefaults:doodooDefaults,doodooDefaultParams:doodooDefaultParams}=doodooLib;function Composition(t,e){const a=this;let n,o,s,l,i,{MIDI_NOTES:c}=t;Object.defineProperty;this.tonic=e.tonic,this.bpm=e.bpm,this.samples=e.samples,this.scale=e.scale,this.title=e.title,this.startDuration=e.startDuration,this.parts=[],this.useMetro=!1,this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){a.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",a.uiScale)},this.setNoteWidth=function(t){a.noteWidth=t,o&&a.updateDisplay()},this.init=function(){s=a.panel.scaleRow,o=t.ui.panels.melody.melody,l=t.ui.panels.melody.melodyInput.noteInput,i=t.ui.panels.melody.melodyInput.durationInput,a.setUIScale(a.uiScale)},this.updateScale=function(){s.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:a.scale[t],min:-11,max:11,callback:e=>{a.scale[t]=+e}});s.append(e,t)}},this.play=function(e){if(0===a.parts.length)return alert("Add notes to the melody.");a.update(),n&&(n.stop(),Tone.Transport.cancel());const o=a.get();n=new Doodoo({...o,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:a.useMetro,params:t.params.get()}),n.play(),t.fio.saveLocal(o)},this.stop=function(){n&&n.stop()},this.mutate=function(){n&&n.mutate()},this.update=function(){a.parts=[];let t=!1;const e=o.children,n=Array.from(e).map((e=>{let a,n=e.note.value,o=e.duration.value;return["null","rest"].includes(n)?a=null:(a=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),a=t[t.length-1],n=t.includes("#")?"#":"";return!(isNaN(+a)||!"ABCDEFG".includes(e))&&e+n+a}(n),a||(t=!0)),o.length>3&&(t=!0),isNaN(+o[0])&&(t=!0),1===o.length&&(o+="n"),[a,o]}));if(t)return alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc.");a.parts=n},this.addNote=function(t,e,n){let s=t||l.value,p=e||i.value,r=new UICollection({class:"note-collection"});r.addClass("d"+p.replace(/\./g,"dot"));let u=new UIListStep({value:s,class:"note-edit",list:[...c,"null","rest"]}),d=new UIListStep({value:p,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=a.startDuration,d.value=t),r.el.className="note-collection d"+t.replace(/\./g,"dot"),a.update(),a.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),m=new UIButton({text:"X",class:"remove-btn",callback:()=>{o.remove(r),a.update(),a.updateDisplay()}});r.append(u,"note"),r.append(d,"duration"),r.append(m),o.append(r),n||a.update(),n||a.updateDisplay()},this.updateDisplay=function(){a.parts.length;const t=o.el.getBoundingClientRect().width,e=a.parts.map((t=>t[1])),n=Math.max(...e.map((t=>parseInt(t))));e.includes(n+"n.");let s=4;for(;t/s>a.noteWidth;)s+=4;o.setProp("--column-width",Math.floor(t/s)),o.setProp("--notes-per-row",s),o.setProp("--default-duration",n)},this.clear=function(){o.clear()},this.get=function(){return a.update(),{parts:a.parts,tonic:a.tonic,bpm:a.bpm,samples:a.samples,title:this.title,startDuration:this.startDuration,scale:this.scale}},this.load=function(e){var n;e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(n=e.tonic,c[n])),e.startDuration&&t.ui.faces.startDuration.update(e.startDuration),e.scale&&(a.scale=e.scale.map((t=>+t))),a.updateScale(),e.parts&&(a.clear(),a.parts=[],e.parts.forEach((t=>{if(null===t)return a.addNote("rest",e.startDuration,!0);const n="string"==typeof t?t:t[0],o="string"==typeof t?e.startDuration:t[1];null===n?a.addNote("rest",o,!0):a.addNote(n,o,!0)}))),a.update(),a.updateDisplay()}}function FilesIO(t){this.load=function(e){console.log(e),t.composition.load(e),t.params.load(e.params)},this.saveLocal=function(e,a){e||(e=t.composition.get()),a||(a=t.params.get()),console.log(a),localStorage.setItem("comp",JSON.stringify({...e,params:a}))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){t.composition.update();const e=localStorage.getItem("comp"),a=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(a,prompt("Name composition",t.composition.title)+".json")}}function Params(t,e,a){const n=this;let o,s;const l={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function i(t){let e=t[0].toUpperCase()+t.substring(1);return e=e.replace(/(?<=[a-z])(?=[A-Z])/g," "),e}function c(t){let{key:a,value:n,range:s,step:l}=t,c=i(a);const p=new UILabel({text:c,class:"break-line-up"}),r=new UILabel({text:"Min"}),u=new UINumberStep({value:n[0],min:s[0],max:s[1],step:l[0],callback:t=>{e[a][0]=t}}),d=new UILabel({text:"Max"}),m=new UINumberStep({value:n[1],min:s[0],max:s[1],step:l[0],callback:t=>{e[a][1]=t}});if(o.append(p),o.append(r),o.append(u),o.append(d),o.append(m),n.length>2){const t=new UIChance({label:"Min Chance",value:n[2],min:s[2],max:s[3],step:l[1],callback:t=>{e[a][2]=t}}),i=new UIChance({label:"Max Chance",value:n[3],min:s[2],max:s[3],step:l[1],callback:t=>{e[a][3]=t}});o.append(t),o.append(i)}}function p(t){let{key:a,start:n,add:s,chance:l}=t,c=i(a);const p=new UILabel({text:c,class:"break-line-up"});o.append(p);const r=new UIChance({label:"Chance",value:l,min:0,max:1,step:.01,callback:t=>{e[a].chance=t}});o.append(r);const u=new UILabel({text:"Start",class:"break"}),d=new UINumberList({list:n,callback:t=>{e[a].start=t}});o.append(u),o.append(d);const m=new UILabel({text:"Add",class:"break"}),h=new UINumberList({list:s,callback:t=>{e[a].add=t}});o.append(m),o.append(h)}function r(t){let{key:a,value:n}=t,s=i(a);const l=new UILabel({text:s,class:"break-line-up"});o.append(l);const c=new UIChance({label:"Chance",value:n,min:0,max:1,step:.01,callback:t=>{e[a]=t}});o.append(c)}function u(t){let{key:a,value:n,range:s}=t,l=i(a);const c=new UILabel({text:l+" Value",class:"break-line-up"});o.append(c);const p=new UINumberStep({value:n,min:s[0],max:s[1],step:1,callback:t=>{e[a][0]=t}});o.append(p)}function d(t){const a=t.value,n=new UILabel({text:"Counts"});s.append(n);const o=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops.pop(),s.removeK("count"+e.startLoops.length),console.log(e.startLoops)}});s.append(o);const l=new UIButton({text:"+",class:"right-end",callback:()=>{const t=[{}];e.startLoops.push(t),m(e.startLoops.length-1,t),console.log("add count",e.startLoops)}});s.append(l);for(let t=0;t<a.length;t++)m(t,a[t])}function m(t,a){const n=new UIRow({class:"break-line-up"});s.append(n,"count"+t);const o=new UILabel({text:"Count "+t});n.append(o);const l=new UILabel({text:"Loops"});n.append(l);const i=new UIButton({text:"–",class:"left-end",callback:()=>{e.startLoops[t].pop(),n.removeK("loop"+e.startLoops[t].length)}});n.append(i);const c=new UIButton({text:"+",class:"right-end",callback:()=>{e.startLoops[t].push({}),h(t,e.startLoops[t].length-1,{},n)}});n.append(c);for(let e=0;e<a.length;e++)h(t,e,a[e],n)}function h(t,e,a,n){const o=new UIRow;n.append(o,"loop"+e);const s=new UILabel({text:"Loop "+e});o.append(s);const i=new UISelectButton({options:Object.keys(l),class:"break",callback:a=>{f(a,l[a],t,e,o)}});o.append(i);for(const n in a)f(n,a[n],t,e,o)}function f(t,a,n,o,s){let l=i(t);switch(typeof a){case"boolean":let i=new UIToggleCheck({label:l,value:a,callback:a=>{e.startLoops[n][o][t]=a}});s.append(i);break;case"number":let c=new UILabel({text:l});s.append(c);let p=new UINumberStep({value:a,callback:a=>{e.startLoops[n][o][t]=a}});s.append(p)}s.append(new UILabel({class:"break"}))}this.init=function(e){o=n.panel.doodooParams,s=t.ui.panels.loops.startLoops},this.load=function(t){t&&a.forEach((a=>{if(t[a.key])if(e[a.key]=t[a.key],"list"===a.type)for(const e in t[a.key])a[e]=t[a.key][e];else a.value=t[a.key]}));for(let t=0;t<a.length;t++)switch(a[t].type){case"range":c(a[t]);break;case"list":p(a[t]);break;case"chance":r(a[t]);break;case"int":u(a[t]);break;case"loops":d(a[t])}},this.get=function(){return{...e}}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],startDuration:"4n",bpm:120,samples:"../samples/choir/"};t.params=new Params(t,doodooDefaults,doodooDefaultParams),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0}),t.ui.settings=new Settings(t,"doodoo"),t.fio=new FilesIO(t),t.ui.load("./interface.json",(()=>{t.ui.settings.load(),t.composition.init(),t.params.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const a=JSON.parse(e);t.composition.load(a),t.params.load(a.params)}else t.composition.load({}),t.params.load()})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
