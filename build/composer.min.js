!function(){"use strict";const{MIDI_NOTES:e}=DoodooMidi,{defaults:t,controls:l}=DoodooControls,{Interface:n,Settings:o}=UI,{UIElement:a,UICollection:i,UIButton:c,UILabel:s,UINumberStep:r,UIListStep:u,UIChance:p,UINumberList:d,UISelectButton:f,UIText:h}=UI.Elements,b={},m={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],duration:"4n",bpm:120,voices:["choir","toms"]};b.controls=new function(e,t,l){let n,o={...t};const a={noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0};function i(e){let t=e[0].toUpperCase()+e.substring(1);return t=t.replace(/(?<=[a-z])(?=[A-Z])/g," "),t}function u(e,l){const{key:n,type:o}=e,a=i(n);l.append(new s({text:a})),l.append(new c({text:"Reset",callback:()=>{h(n,l)}})),"range"===o&&function(e,t,l){let{key:n,value:o,range:a,step:i}=e;l&&t.append(new s({text:l}));if(m({...e,index:0},t,"Min"),m({...e,index:1},t,"Max"),o.length>2){let l=a.length<=2?[0,1]:a.slice(2);b({...e,range:l,index:2},t,"Min Update"),b({...e,range:l,index:3},t,"Max Update")}}(e,l),"list"===o&&e.value&&function(e,l,n){let{key:o,value:a}=e;n&&l.append(new s({text:n}));l.append(new d({list:a,callback:e=>{t[o]=e}}))}(e,l),"chance"===o&&b(e,l),"number"===o&&m(e,l)}function h(e,n,a){const i=l.filter((t=>t.key===e))[0];void 0===a&&(a=Array.isArray(o[e])?[...o[e]]:o[e]),t[e]=a,i.value=a,n.clear(),u(i,n)}function b(e,l,n){let{key:o,value:a,index:i,range:c}=e;n&&l.append(new s({text:n})),l.append(new p({label:"Chance",value:void 0!==i?a[i]:a,min:c?c[0]:0,max:c?c[1]:1,step:.01,callback:e=>{void 0!==i?t[o][i]=e:t[o]=e}}))}function m(e,l,n){let{key:o,value:a,range:i,step:c,index:u}=e;n&&l.append(new s({text:n})),l.append(new r({value:void 0!==u?a[u]:a,min:i[0],max:i[1],step:e.step||1,callback:e=>{void 0!==u?t[o][u]=e:t[o]=e}}))}function g(e){const l=e.value,o=new s({text:"Counts"});n.append(o);const a=new c({text:"–",class:"left-end",callback:()=>{t.startLoops.pop(),n.removeK("count"+t.startLoops.length)}});n.append(a);const i=new c({text:"+",class:"right-end",callback:()=>{const e=[{}];t.startLoops.push(e),k(t.startLoops.length-1,e)}});n.append(i);for(let e=0;e<l.length;e++)k(e,l[e])}function k(e,l){const o=new UIRow({class:"break-line-up"});n.append(o,"count"+e);const a=new s({text:"Count "+e});o.append(a);const i=new s({text:"Loops"});o.append(i);const r=new c({text:"–",class:"left-end",callback:()=>{t.startLoops[e].pop(),o.removeK("loop"+t.startLoops[e].length)}});o.append(r);const u=new c({text:"+",class:"right-end",callback:()=>{t.startLoops[e].push({}),y(e,t.startLoops[e].length-1,{},o)}});o.append(u);for(let t=0;t<l.length;t++)y(e,t,l[t],o)}function y(e,t,l,n){const o=new UIRow;n.append(o,"loop"+t);const i=new s({text:"Loop "+t});o.append(i);const c=new f({options:Object.keys(a),class:"break",callback:l=>{x(l,a[l],e,t,o)}});o.append(c);for(const n in l)x(n,l[n],e,t,o)}function x(e,l,n,o,a){let c=i(e);switch(typeof l){case"boolean":let i=new UIToggleCheck({label:c,value:l,callback:l=>{t.startLoops[n][o][e]=l}});a.append(i);break;case"number":let u=new s({text:c});a.append(u);let p=new r({value:l,callback:l=>{t.startLoops[n][o][e]=l}});a.append(p)}a.append(new s({class:"break"}))}this.resetControls=function(){let t=l.findIndex((e=>"fxLimit"===e.key));for(let n=0;n<t;n++){const{key:t,panel:o}=l[n];"loops"!==t&&h(t,e.ui.panels[o]["row-"+t])}},this.resetEffects=function(){for(let t=l.findIndex((e=>"fxLimit"===e.key));t<l.length;t++){const{key:n,panel:o}=l[t];h(n,e.ui.panels[o]["row-"+n])}},this.zeroEffects=function(){for(let t=l.findIndex((e=>"fxLimit"===e.key));t<l.length;t++){const{key:n,panel:o}=l[t];n.includes("Chance")&&h(n,e.ui.panels[o]["row-"+n],0)}},this.init=function(t){n=e.ui.panels.loops.startLoops},this.load=function(n){if(n)for(let e=0;e<l.length;e++){const{key:o,type:a}=l[e];if(void 0!==n[o])switch(t[o]=n[o],a){case"list":for(const t in n[o])l[e][t]=n[o][t];break;case"effect":l[e].chance=n[o+"Chance"],l[e].delay=n[o+"Delay"];break;default:l[e].value=n[o]}}const o=localStorage.getItem("settings-doodoo")?JSON.parse(localStorage.getItem("settings-doodoo")).panels:{};for(let t=0;t<l.length;t++){const n=l[t];let a;if(n.panel){const t=n.panel;if(e.ui.panels[t]||e.ui.createPanel(t,{label:i(t)+" Control"}),a=e.ui.panels[t].addRow("row-"+n.key),a.addClass("break-line-up"),o[t]){const{gridArea:l}=o[t],n=e.ui.panels[t];n.setup(o[t]),e.ui.layout[l].panels.append(n)}}"loops"===n.type?g(n):u(n,a)}},this.get=function(){return{...t}}}(b,t,l),b.composition=new function(t,l){let n,o,a,p,d,b,m=l.title,g=l.tonic,k=l.transform||l.tonic,y=l.bpm,x=[],v=l.scale,w=l.duration,I=[],C=l.simultaneous||!1,M=!1,S=0,U=[],P=60;function E(e){if(console.log("play"),0===I.length)return alert("Add notes to the melody.");D(),n&&(n.stop(),Tone.Transport.cancel());const l=G();n=new Doodoo({...l,withRecording:e,onMutate:e=>{b.text="Mutation: "+e},useMetro:M,controls:t.controls.get()})}function T(){n&&n.stop()}function A(){n&&n.mutate()}function D(){function e(e){let t=!1;const l=Array.from(e).map((e=>{let l,n=e.note.value,o=e.duration.value;return["null","rest"].includes(n)?l=null:(l=function(e){if(1===e.length||e.length>3)return!1;let t=e[0].toUpperCase(),l=e[e.length-1],n=e.includes("#")?"#":"";return!(isNaN(+l)||!"ABCDEFG".includes(t))&&t+n+l}(n),l||(t=!0)),o.length>3&&(t=!0),isNaN(+o[0])&&(t=!0),1===o.length&&(o+="n"),[l,o]}));return t?alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc."):l}if(I=[],U.length>1)for(let t=0;t<U.length;t++)I.push(e(U[t].children));else I=e(U[0].children)}function L(t,l,n){let o=t||a.value.toUpperCase(),s=l||p.value,r=new i({class:"note-collection"});r.addClass("d"+s.replace(/\./g,"dot"));let d=new u({value:o,class:"note-edit",list:[...e,"null","rest"]}),f=new u({value:s,class:"duration-edit",callback:e=>{e.includes("n")||(["1","2","4","8","16","32"].includes(e)?e+="n":e=s,f.value=e),r.el.className="note-collection d"+e.replace(/\./g,"dot"),D(),B()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),h=new c({text:"x",class:"remove-btn",callback:()=>{U[S].remove(r),D(),B()}});r.append(d,"note"),r.append(f,"duration"),r.append(h),U[S].append(r),n||D(),n||B()}function N(){let e=t.ui.panels.melody.addRow("part-"+U.length,"break-line-up");e.addClass("part"),U.push(e),S=U.length-1,t.ui.faces.currentPart.addOption(S,!0,"Part "+S)}function R(e){e.forEach((e=>{if(null===e)return L("rest",data.duration,!0);const t="string"==typeof e?e:e[0],l="string"==typeof e?data.duration:e[1];L(null===t?"rest":t,l,!0)}))}function F(e){if(Array.isArray(x)||(x=[x]),x.includes(e))return;x.push(e);const t=new i({class:"voice-collection"});t.append(new s({text:e})),t.append(new c({text:"X",callback:()=>{x.splice(x.indexOf(e),1),d.remove(t)}})),d.append(t)}function B(){I.length;const e=t.ui.panels.melody.el.getBoundingClientRect().width,l=U.length>1?I.flatMap((e=>e.map((e=>e[1])))):I.flatMap((e=>e[1]));let n=Math.max(...l.map((e=>parseInt(e))));l.includes(n+"n."),n<0&&(n="4n");let o=4;for(;e/o>P;)o+=4;t.ui.panels.melody.setProp("--column-width",Math.floor(e/o)),t.ui.panels.melody.setProp("--notes-per-row",o),t.ui.panels.melody.setProp("--default-duration",n)}function O(){U.forEach((e=>e.clear()))}function G(){return D(),{parts:I,tonic:g,transform:k,bpm:y,voices:x,title:m,duration:w,scale:v,simultaneous:C}}return{connectUI:function(){const e=t.ui.createPanel("playback",{label:"Play Back"}),l=t.ui.createPanel("composition"),n=t.ui.createPanel("melody");t.ui.addCallbacks([{callback:E,key:"space",text:"Play",args:[!1]},{callback:T,key:"alt-space",text:"Stop"},{callback:E,key:"r",text:"Record",args:[!0]},{callback:A,key:"d",text:"Mutate"},{key:"t",text:"Test",callback:()=>{console.log(M)}}],e),b=new s({type:"UIElement",id:"mutation-count",text:"Mutation 0"}),e.add(b),t.ui.addProp("useMetro",{type:"UIToggleCheck",value:M,callback:e=>{M=e},key:"m",label:"Metro"},e),t.ui.addProps({title:{id:"title",value:m,callback:e=>{m=e}},tonic:{value:g,label:"Tonic",callback:e=>{g=e}},transform:{value:k,label:"Tonic Transform",callback:e=>{k=e}},bpm:{value:y,label:"BPM",type:"UINumberStep",range:[60,250],callback:e=>{y=e}},duration:{value:w,type:"UISelect",label:"Default Duration",selected:"4n",options:[{value:"1n",text:"Whole 1n"},{value:"2n",text:"Half 2n"},{value:"4n",text:"Quarter 4n"},{value:"8n",text:"Eighth 8n"}],callback:e=>{w=e}},simultaneous:{value:C,type:"UIToggleCheck",label:"Simultaneous Parts",callback:e=>{C=e}}},l),l.addRow(void 0,"break"),l.add(new s({text:"Scale Intervals "})),o=l.addRow(void 0,"break"),d=l.addRow();const i=new f({label:"Voices",callback:F,selected:"synth",options:[{value:"choir",text:"Choir"},{value:"fmSynth",text:"FMSynth"},{value:"toms",text:"Toms"},{value:"bamboo",text:"Bamboo"},{value:"strings",text:"Strings"},{value:"flute",text:"Flute"},{value:"guitar",text:"Guitar"}]});l.add(i),n.addRow(void 0,"break"),t.ui.addProp("melodyScale",{type:"UINumberStep",value:12,label:"Scale",callback:e=>{n.setProp("--ui-scale",e)},reset:!0},n),t.ui.addProp("noteWidth",{type:"UINumberStep",label:"Note Width",value:80,callback:e=>{P=e,U[0]&&B()},range:[40,120],reset:!0},n),n.addRow(void 0,"break"),t.ui.addProp("currentPart",{type:"UISelect",label:"Part",options:[{value:0,text:"Part 0"}],callback:e=>{S=+e}},n),t.ui.addCallback({callback:N,text:"+"},n),t.ui.addCallback({callback:O,text:"Clear",key:"0"},n),a=n.add(new h({placeholder:"C4"})),p=n.add(new h({placeholder:"4n"})),t.ui.addUI({type:"UIButton",callback:L,text:"+",key:"+"},n),n.addRow("melody","break"),U[0]=n.addRow("part-0","break-line-up"),U[0].addClass("part")},load:function(n){n.title&&t.ui.faces.title.update(n.title),n.transform&&t.ui.faces.transform.update(n.transform),n.bpm&&t.ui.faces.bpm.update(n.bpm),n.duration&&t.ui.faces.duration.update(n.duration),n.voices?(Array.isArray(n.voices)?[...n.voices]:[n.voices]).forEach((e=>F)):l.voices.forEach((e=>F));var a;if(n.tonic&&t.ui.faces.tonic.update("string"==typeof n.tonic?n.tonic:(a=n.tonic,e[a])),n.scale&&(v=n.scale.map((e=>+e))),function(){o.clear();for(let e=0;e<v.length;e++){let t=new r({value:v[e],range:[-11,11],callback:t=>{v[e]=+t}});o.append(t,e)}}(),n.parts){if(O(),I=[],Array.isArray(n.parts[0]))if(Array.isArray(n.parts[0][0]))for(let e=0;e<n.parts.length;e++){if(S=e,e>0){let l=t.ui.panels.melody.addRow("part-"+e,"break-line-up");l.addClass("part"),U.push(l)}R(n.parts[e])}else R(n.parts);S=0}D(),B()},get:G}}(b,m),b.fio=new function(e){function t(t){e.composition.load(t),e.controls.load(t.controls)}function l(t,l){t||(t=e.composition.get()),l||(l=e.controls.get()),localStorage.setItem("comp",JSON.stringify({...t,controls:l})),console.log(t)}function n(){e.composition.clear(),localStorage.setItem("comp","")}function o(){if(e.composition.isRecording())return;e.composition.update();const t=localStorage.getItem("comp"),l=new Blob([t],{type:"application/x-download;charset=utf-8"}),n=prompt("Name composition",e.composition.title);n&&(saveAs(l,n+".json"),e.ui.faces.title.update(n))}function a(t,l,n){new Midi.fromUrl(n).then((t=>{t.tracks.forEach((t=>{const l=t.notes;for(let t=0;t<l.length;t++){const{name:n,duration:o,time:a}=l[t];let i=n,c=t===l.length-1;if(t>0){const n=l[t-1];let o=a-(n.time+n.duration);o>0&&e.composition.addNote("rest",Tone.Time(o).toNotation(),c)}e.composition.addNote(i,Tone.Time(o).toNotation(),c)}}))}))}return{connectUI:function(){const i=e.ui.createPanel("fio",{label:"File IO"});e.ui.addCallbacks([{callback:l,key:"s",text:"Save Local"},{callback:o,key:"alt-s",text:"Save File"},{callback:t,key:"o",text:"Load File"},{callback:n,key:"o",text:"Clear Local"}],i),e.ui.addUI({type:"UIFile",callback:a,text:"Load Midi",promptDefault:"compositions",fileType:"audio/midi"},i)},saveLocal:l}}(b),b.score=new function(t){const l=document.createElement("canvas");let n,o;if(!l.getContext("2d"))return;o=l.getContext("2d");let a=20,i=12,c="CDEFGAB".split(""),s=["F","C","G","D","A","E","B"],r=["B","E","A","D","G","C","F"],u={G:["#",1],D:["#",2],A:["#",3],E:["#",4],B:["#",5],"F#":["#",6],"C#":["#",7],F:["b",1],Bb:["b",2],Eb:["b",3],Ab:["b",4],Db:["b",5],Gb:["b",6],Cb:["b",7]},p={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B",Eb:"Gb","D#":"F#",Bb:"Db",F:"Ab",C:"Eb",G:"Bb",D:"F"},d=["G","F","E","D","C","B","A"],f=!1;function h(e,t,l,n){o.beginPath(),o.moveTo(e,t),o.lineTo(l,n),o.stroke()}function b(e,t){let l=e[0],n=+e[e.length-1],o=t[0],a=+t[t.length-1];return c.indexOf(l)-c.indexOf(o)+7*(n-a)}function m(c){let{width:f,height:m}=n.el.getBoundingClientRect();const{tonic:g,scale:k}=t.composition,y=e.indexOf(g),x=k.map((t=>{let l=e[y+t];return l.substring(0,l.length-1)}));let v=g.substring(0,g.length-1);k.includes(3)&&!k.includes(4)&&(v=p[v]);let w=[];if(u[v]){let e=u[v];w="#"===e[0]?s.slice(0,e[1]):r.slice(0,e[1])}let I=16,C=32+w.length*I,M=C,S=a,U=f-8-C-20,P=0===c.length?4:Math.max(...c.flatMap((e=>e.melody.map((e=>+e[1][0]))))),E=Math.max(...c.map((e=>e.len))),T=Math.ceil(E/P),A=c.flatMap((e=>e.melody)).map(((e,t)=>[e[0]?e[0].substring(0,e[0].length-1):null,Math.floor(t%E/P)])).filter((e=>null!==e[0])).filter((e=>!x.includes(e[0]))),D=A.length,L=[];for(let e=0;e<T;e++)L[e]=A.filter((t=>t[1]===e)).length;let N=1,R=1+T+T*P+D,F=[R];if(U>E*I+T*I+D*I)I=Math.floor(U/R);else{F=[0];for(let e=0;e<T;e++){let t=P+L[e]+1,l=t*I;F[N-1]*I+l<U?F[N-1]+=t:(N++,F.push(t))}}l.width=f-8,l.height=144*N+40,o.fillStyle="lightgray",o.fillRect(0,0,l.width,l.height),o.fillStyle="black",o.strokeStyle="black";for(let e=0;e<N;e++){let t=a+144*e,l=32;o.strokeStyle="gray";for(let e=0;e<11;e++){let l=a+e*i+i;5!==e&&h(10,t+l,f-10-8,t+l)}o.fillStyle="black",o.font="60px serif",o.fillText("𝄞",10,t+a+54),o.font="36px serif",o.fillText("𝄢",10,t+a+114),o.font="18px serif",w.forEach((e=>{let n=32+t+6*d.indexOf(e);o.fillText("♯",l,n),o.fillText("♯",l,n+84),l+=16}))}if(0===c.length)return;let B=M+I,O=0,G=0,W=0,J=F[W];for(let e=0;e<=E;e++){let t=I;if(W<N-1&&(t=Math.floor(U/F[W])),e===E){o.fillStyle="black",o.fillRect(B-t/2,S+a+i,6,48),o.fillRect(B-t/2,S+a+84,6,48);continue}if(e>0&&e+G>J-1&&(W++,S+=144,B=M+I,J+=F[W]),e===E){o.fillStyle="black",o.fillRect(B,S+a+i,6,48),o.fillRect(B,S+a+84,6,48);continue}let l=[],n=[];for(let t=0;t<c.length;t++){let{startDelay:o,startIndex:a,doubler:i,repeat:s,melody:r}=c[t],u=(e-o+a)%r.length;r[u]&&(l.push(r[u]),n.push(r.slice(u-O,u+(P-O))))}if(l.every((e=>null===e[0]))){let e=!1;if(o.font="26px Noto",n.flatMap((e=>e)).every((e=>null===e[0]))&&0===tempCount&&(o.fillText("𝄻",B+t,S+132),e=!0),n.forEach((t=>{t.forEach(((t,l)=>{l<O&&l+P/parseInt(t[1])>O&&(e=!0)}))})),!e){let e=P/4*2,l=O%e,a=O>=e?1:0,i=n.map((t=>t.slice(e*a,e+e*a)));i.flatMap((e=>e)).every((e=>null===e[0]))?0===l&&o.fillText("𝄼",B+t,S+132):l%2==0?i.filter((e=>e[l+1])).every((e=>null===e[l+1][0]))?o.fillText("𝄽",B+t/2,S+138):o.fillText("𝄾",B,S+138):i.filter((e=>e[l-1])).every((e=>null!==e[l-1][0]))&&o.fillText("𝄾",B,S+138)}O++}else o.strokeStyle="black",l.forEach((e=>{let[l,i]=e;if(null===l)return;let c=a+S+72+6*b("C4",l),s=l.substring(0,l.length-1);if(x.includes(s)||(o.font="18px sans-serif",l.includes("#")?o.fillText("♯",B-t/2,c+8):o.fillText("♮",B-t/2,c+8),B+=t,G++),"1n"===i&&(o.beginPath(),o.ellipse(B,c,5,3,-Math.PI/6,0,2*Math.PI),o.stroke()),"2n"===i&&(o.beginPath(),o.ellipse(B,c,5,3,-Math.PI/6,0,2*Math.PI),o.stroke(),h(B+5,c-1,B+5,c-24)),"4n"===i&&(o.beginPath(),o.ellipse(B,c,6,4,-Math.PI/6,0,2*Math.PI),o.fill(),h(B+5,c-1,B+5,c-24)),"8n"===i){let e=P/4*2,a=O%e,i=O>=e?1:0,s=n.map((t=>t.slice(e*i,e+e*i))),r=72+6*b("C4",l),u=0;for(let l=0;l<e;l++){let e=s.filter((e=>e[l])).map((e=>e[l]));if(l>a&&(e.every((e=>null===e[0]))||e.every((e=>"8n"!==e[1]))))break;e.every((e=>null===e[0]))||(l>a&&(u+=t),e.forEach((e=>{if(null===e[0])return;let t=72+6*b("C4",e[0]);t<r&&(r=t)})))}let p=!1;u>0?o.fillRect(B+5,S+r-6,u,4):p=s.filter((e=>e[a-1])).every((e=>null===e[a-1][0])),h(B+5,c-1,B+5,S+r-6),o.beginPath(),o.ellipse(B,c,6,4,-Math.PI/6,0,2*Math.PI),o.fill(),p&&h(B+5,S+r-6,B+10,S+r+6)}S>80&&S<104&&h(B-12,S+a+72,B+12,S+a+72)})),O++;if(O===P){B+=t,G++;let e=B;o.strokeStyle="black",h(e+t/2,S+a+i,e+t/2,S+a+60),h(e+t/2,S+a+84,e+t/2,S+a+132),O=0}B+=t}}new FontFace("Noto","url(https://fonts.gstatic.com/s/notomusic/v14/pe0rMIiSN5pO63htf1sxEkW7I9tAcVwo.woff2)").load().then((e=>{document.fonts.add(e),console.log("Font loaded"),f=!0})),this.update=function(e){m(e)},this.init=function(){n=t.ui.panels.score,n.el.appendChild(l),m([])}}(b),b.ui=n(b,{useMain:!0}),b.ui.setup(),b.fio.connectUI(),b.composition.connectUI(),b.ui.settings=new o(b,{name:"doodoo",workspaceFields:["noteWidth"]}),b.ui.settings.load();const g=localStorage.getItem("comp");if(g&&"undefined"!==g){const e=JSON.parse(g);b.composition.load(e)}else b.composition.load({});b.ui.load("./interface/panels.json",(()=>{b.composition.init(),b.controls.init();const e=localStorage.getItem("comp");if(e&&"undefined"!==e){const t=JSON.parse(e);b.composition.load(t),b.controls.load(t.controls)}else b.composition.load({}),b.controls.load();b.score.init()})),console.log("app",b)}();
//# sourceMappingURL=src_maps/composer.min.js.map
