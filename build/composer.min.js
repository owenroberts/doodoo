const{Doodoo:Doodoo,MIDI_NOTES:MIDI_NOTES,defaults:defaults}=doodooLib;function Composition(t,e){const o=this;let a,n,i,s,l,{MIDI_NOTES:c}=t;Object.defineProperty;this.tonic=e.tonic,this.bpm=e.bpm,this.samples=e.samples,this.scale=e.scale,this.title=e.title,this.startDuration=e.startDuration,this.parts=[],this.useMetro=!1,this.noteWidth=60,this.uiScale=12,this.setUIScale=function(e){o.uiScale=e,t.ui.panels.melody&&t.ui.panels.melody.setProp("--ui-scale",o.uiScale)},this.setNoteWidth=function(t){o.noteWidth=t,n&&o.updateDisplay()},this.init=function(){i=o.panel.scaleRow,n=t.ui.panels.melody.melody,s=t.ui.panels.melody.melodyInput.noteInput,l=t.ui.panels.melody.melodyInput.durationInput,o.setUIScale(o.uiScale)},this.updateScale=function(){i.clear();for(let t=0;t<this.scale.length;t++){let e=new UINumberStep({value:o.scale[t],min:-11,max:11,callback:e=>{o.scale[t]=+e}});i.append(e,t)}},this.play=function(e){if(0===o.parts.length)return alert("Add notes to the melody.");o.update(),a&&(a.stop(),Tone.Transport.cancel());const n=o.get();a=new Doodoo({...n,withRecording:e,onMutate:e=>{t.ui.faces.mutationCount.text="Mutation: "+e},useMetro:o.useMetro,params:t.params.get()}),a.play(),t.fio.saveLocal(n)},this.stop=function(){a&&a.stop()},this.mutate=function(){a&&a.mutate()},this.update=function(){o.parts=[];let t=!1;const e=n.children,a=Array.from(e).map((e=>{let o,a=e.note.value,n=e.duration.value;return["null","rest"].includes(a)?o=null:(o=function(t){if(1===t.length||t.length>3)return!1;let e=t[0].toUpperCase(),o=t[t.length-1],a=t.includes("#")?"#":"";return!(isNaN(+o)||!"ABCDEFG".includes(e))&&e+a+o}(a),o||(t=!0)),n.length>3&&(t=!0),isNaN(+n[0])&&(t=!0),1===n.length&&(n+="n"),[o,n]}));if(t)return alert("use notes in MIDI format like C4 or C#4, durations like 1n, 2n, 4n, 8n, etc.");o.parts=a},this.addNote=function(t,e,a){let i=t||s.value,u=e||l.value,p=new UICollection({class:"note-collection"});p.addClass("d"+u.replace(/\./g,"dot"));let r=new UIListStep({value:i,class:"note-edit",list:[...c,"null","rest"]}),d=new UIListStep({value:u,class:"duration-edit",callback:t=>{t.includes("n")||(["1","2","4","8","16","32"].includes(t)?t+="n":t=o.startDuration,d.value=t),p.el.className="note-collection d"+t.replace(/\./g,"dot"),o.update(),o.updateDisplay()},list:["32n","16n","8n","8n.","4n","4n.","2n","2n.","1n","1n."]}),m=new UIButton({text:"X",class:"remove-btn",callback:()=>{n.remove(p),o.update(),o.updateDisplay()}});p.append(r,"note"),p.append(d,"duration"),p.append(m),n.append(p),a||o.update(),a||o.updateDisplay()},this.updateDisplay=function(){o.parts.length;const t=n.el.getBoundingClientRect().width,e=o.parts.map((t=>t[1])),a=Math.max(...e.map((t=>parseInt(t))));e.includes(a+"n.");let i=4;for(;t/i>o.noteWidth;)i+=4;n.setProp("--column-width",Math.floor(t/i)),n.setProp("--notes-per-row",i),n.setProp("--default-duration",a)},this.clear=function(){n.clear()},this.get=function(){return o.update(),{parts:o.parts,tonic:o.tonic,bpm:o.bpm,samples:o.samples,title:this.title,startDuration:this.startDuration,scale:this.scale}},this.load=function(e){var a;e.title&&t.ui.faces.title.update(e.title),e.bpm&&t.ui.faces.bpm.update(e.bpm),e.tonic&&t.ui.faces.tonic.update("string"==typeof e.tonic?e.tonic:(a=e.tonic,c[a])),e.startDuration&&t.ui.faces.startDuration.update(e.startDuration),e.scale&&(o.scale=e.scale.map((t=>+t))),o.updateScale(),e.parts&&(o.clear(),o.parts=[],e.parts.forEach((t=>{if(null===t)return o.addNote("rest",e.startDuration,!0);const a="string"==typeof t?t:t[0],n="string"==typeof t?e.startDuration:t[1];null===a?o.addNote("rest",n,!0):o.addNote(a,n,!0)}))),o.update(),o.updateDisplay()}}function FilesIO(t){this.load=function(e){t.composition.load(e)},this.saveLocal=function(e){e||(e=t.composition.get()),localStorage.setItem("comp",JSON.stringify(e))},this.clear=function(){t.composition.clear(),localStorage.setItem("comp","")},this.saveFile=function(){t.composition.update();const e=localStorage.getItem("comp"),o=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(o,prompt("Name composition",t.composition.title)+".json")}}function Params(t,e){this.get=function(){return{attackStart:this.attackStart,attackStep:this.attackStep}}}window.addEventListener("load",(function(){const t={};t.MIDI_NOTES=MIDI_NOTES;const e={title:"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"),tonic:"C4",scale:[0,2,4,5,7,9,11],startDuration:"4n",bpm:120,samples:"../samples/choir/"};t.params=new Params(t,defaults),t.composition=new Composition(t,e),t.ui=new Interface(t,{useMain:!0}),t.ui.settings=new Settings(t,"doodoo"),t.fio=new FilesIO(t),t.ui.load("./interface.json",(()=>{t.ui.settings.load(),t.composition.init();const e=localStorage.getItem("comp");e&&"undefined"!==e?t.composition.load(JSON.parse(e)):t.composition.load({})})),console.log(t)}));
//# sourceMappingURL=src_maps/composer.min.js.map
