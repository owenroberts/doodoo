!function(){"use strict";let e={bamboo:{B3:"b3.ogg",G4:"g4.ogg"},piano:{A4:"A4.mp3",C4:"C4.mp3"},flute:{C5:"C5.wav"},guitar:{C4:"C4.wav"},strings:{"A#2":"Ash2.ogg",A5:"A5.ogg",C4:"C4.ogg",C7:"C7.ogg","D#2":"Dsh2.ogg",D5:"D5.ogg",E3:"E3.ogg",E6:"E6.ogg",G4:"G4.ogg"},toms:{"A#3":"Tom606_EQ_FADE.ogg"},crow_bass:{C4:"C4.wav"},choirA:{A2:"CH-AA-A2.mp3",A3:"CH-AA-A3.mp3",A4:"CH-AA-A4.mp3",B2:"CH-AA-B2.mp3",B3:"CH-AA-B3.mp3",B4:"CH-AA-B4.mp3",C2:"CH-AA-C2.mp3",C3:"CH-AA-C3.mp3",C4:"CH-AA-C4.mp3",C5:"CH-AA-C5.mp3",D2:"CH-AA-D2.mp3",D3:"CH-AA-D3.mp3",D4:"CH-AA-D4.mp3",E2:"CH-AA-E2.mp3",E3:"CH-AA-E3.mp3",E4:"CH-AA-E4.mp3",F2:"CH-AA-F2.mp3",F3:"CH-AA-F3.mp3",F4:"CH-AA-F4.mp3",G2:"CH-AA-G2.mp3",G3:"CH-AA-G3.mp3",G4:"CH-AA-G4.mp3"},choirE:{A2:"CH-EE-A2.mp3",A3:"CH-EE-A3.mp3",A4:"CH-EE-A4.mp3",B2:"CH-EE-B2.mp3",B3:"CH-EE-B3.mp3",B4:"CH-EE-B4.mp3",C2:"CH-EE-C2.mp3",C3:"CH-EE-C3.mp3",C4:"CH-EE-C4.mp3",C5:"CH-EE-C5.mp3",D2:"CH-EE-D2.mp3",D3:"CH-EE-D3.mp3",D4:"CH-EE-D4.mp3",E2:"CH-EE-E2.mp3",E3:"CH-EE-E3.mp3",E4:"CH-EE-E4.mp3",F2:"CH-EE-F2.mp3",F3:"CH-EE-F3.mp3",F4:"CH-EE-F4.mp3",G2:"CH-EE-G2.mp3",G3:"CH-EE-G3.mp3",G4:"CH-EE-G4.mp3"},choirI:{A2:"CH-II-A2.mp3",A3:"CH-II-A3.mp3",A4:"CH-II-A4.mp3",B2:"CH-II-B2.mp3",B3:"CH-II-B3.mp3",B4:"CH-II-B4.mp3",C2:"CH-II-C2.mp3",C3:"CH-II-C3.mp3",C4:"CH-II-C4.mp3",C5:"CH-II-C5.mp3",D2:"CH-II-D2.mp3",D3:"CH-II-D3.mp3",D4:"CH-II-D4.mp3",E2:"CH-II-E2.mp3",E3:"CH-II-E3.mp3",E4:"CH-II-E4.mp3",F2:"CH-II-F2.mp3",F3:"CH-II-F3.mp3",F4:"CH-II-F4.mp3",G2:"CH-II-G2.mp3",G3:"CH-II-G3.mp3",G4:"CH-II-G4.mp3"},choirO:{A2:"CH-OO-A2.mp3",A3:"CH-OO-A3.mp3",A4:"CH-OO-A4.mp3",B2:"CH-OO-B2.mp3",B3:"CH-OO-B3.mp3",B4:"CH-OO-B4.mp3",C2:"CH-OO-C2.mp3",C3:"CH-OO-C3.mp3",C4:"CH-OO-C4.mp3",C5:"CH-OO-C5.mp3",D2:"CH-OO-D2.mp3",D3:"CH-OO-D3.mp3",D4:"CH-OO-D4.mp3",E2:"CH-OO-E2.mp3",E3:"CH-OO-E3.mp3",E4:"CH-OO-E4.mp3",F2:"CH-OO-F2.mp3",F3:"CH-OO-F3.mp3",F4:"CH-OO-F4.mp3",G2:"CH-OO-G2.mp3",G3:"CH-OO-G3.mp3",G4:"CH-OO-G4.mp3"},choirU:{A2:"CH-UU-A2.mp3",A3:"CH-UU-A3.mp3",A4:"CH-UU-A4.mp3",B2:"CH-UU-B2.mp3",B3:"CH-UU-B3.mp3",B4:"CH-UU-B4.mp3",C2:"CH-UU-C2.mp3",C3:"CH-UU-C3.mp3",C4:"CH-UU-C4.mp3",C5:"CH-UU-C5.mp3",D2:"CH-UU-D2.mp3",D3:"CH-UU-D3.mp3",D4:"CH-UU-D4.mp3",E2:"CH-UU-E2.mp3",E3:"CH-UU-E3.mp3",E4:"CH-UU-E4.mp3",F2:"CH-UU-F2.mp3",F3:"CH-UU-F3.mp3",F4:"CH-UU-F4.mp3",G2:"CH-UU-G2.mp3",G3:"CH-UU-G3.mp3",G4:"CH-UU-G4.mp3"}};function t(e={},t){let n={};for(const t in e)n[t]=new h(e[t],t);return{update:function(e){for(const t in n)n[t].update(e)},get:function(e){let t={};for(const a in n)"type"!==a&&(t[a]=n[a].get(e));return t}}}let n=[{key:"voiceAttack",type:"range",value:[.1,.5,0,0],range:[0,1],step:.1},{key:"voiceRelease",type:"range",value:[.1,.5,0,0],range:[0,1],step:.1},{key:"voiceCurve",type:"list",value:["linear","exponential","sine","cosine","bounce","ripple","step"]},{key:"voiceCurveIndex",type:"number",value:1},{key:"voiceCurveUpdateChance",type:"chance",value:.1},{key:"attackStart",type:"range",value:[.25,.7],range:[0,1],step:.05},{key:"attackStep",type:"walker",value:[.5,.01,.75,.1,1,0],step:.01},{key:"restChance",type:"range",value:[0,0,0,0],range:[0,1],step:.01},{key:"loopNums",type:"range",value:[1,1,.1,.2],range:[1,32],step:1},{key:"maxLoops",type:"number",value:5},{key:"harmonyChance",type:"walker",value:[.6,.01,.5,0,1,0],range:[0,1],step:.01},{key:"harmonyList",type:"list",value:[4,5,2,3,6,7]},{key:"harmonyIndex",type:"number",value:2},{key:"harmonyUpdateChance",type:"chance",value:.2},{key:"startIndexes",type:"range",value:[0,0,0,.3],range:[0,0],step:1},{key:"indexStep",type:"walker",value:[0,.1,.75,0,8,0],step:.1},{key:"durationList",type:"list",value:[2,4,1,8,16,32]},{key:"durationIndex",type:"number",value:2},{key:"durationChance",type:"chance",value:.3},{key:"startDelayList",type:"list",value:[0,1,2,4,.5,8,12,16,3,5,7,11]},{key:"startDelayIndex",type:"number",value:6},{key:"startDelayChance",type:"chance",value:.3},{key:"voiceList",type:"list",value:[]},{key:"voiceIndex",type:"number",value:0},{key:"voiceChance",type:"chance",value:.1},{key:"sliceChance",type:"chance",value:.1},{key:"sliceLength",type:"range",value:[1,3,0,0],range:[1,8]},{key:"shiftChance",type:"chance",value:.2},{key:"shiftLength",type:"number",value:16,range:[0,32]},{key:"doublerChance",type:"chance",value:.5},{key:"repeat",type:"list",value:[2,3,4]},{key:"startLoops",type:"loops",value:[[{}]]},{key:"fxLimit",type:"number",value:1,range:[0,16]},{key:"fxKickIn",type:"number",value:8,range:[0,64]},{key:"reverbChance",type:"chance",value:1},{key:"reverbDecay",type:"number",value:5,range:[.5,32],step:.1},{key:"distortionChance",type:"chance",value:.25},{key:"distortion",type:"range",value:[.05,.2],range:[.01,1],step:.01},{key:"bitCrushChance",type:"chance",value:.25},{key:"bitCrushBits",type:"list",value:[3,4,6,8,12,16]},{key:"autoFilterChance",type:"chance",value:.25},{key:"autoFilterFrequency",type:"list",value:["2n","4n","8n","16n","32n"]},{key:"autoPannerChance",type:"chance",value:.25},{key:"autoPannerFrequency",type:"list",value:["2n","4n","8n","16n","32n"]},{key:"chebyChance",type:"chance",value:.25},{key:"chebyOrder",type:"number",value:16,range:[1,100]},{key:"chorusChance",type:"chance",value:.25},{key:"chorusFrequency",type:"number",value:4,range:[1,12]},{key:"chorusDelayTime",type:"number",value:2.5,range:[.1,12],step:.1},{key:"chorusDepth",type:"number",value:.5,range:[0,1]},{key:"feedbackChance",type:"chance",value:.25},{key:"feedbackDelayTime",type:"list",value:["8n","4n","16n","32n"]},{key:"feedback",type:"number",value:.25,range:[.1,1],step:.01},{key:"phaserChance",type:"chance",value:.25},{key:"phaserFrequency",type:"number",value:15,range:[0,32]},{key:"phaserOctaves",type:"number",value:5,range:[1,16]},{key:"phaserBaseFrequency",type:"number",value:1e3,range:[1,1e4]},{key:"pingPongChance",type:"chance",value:.25},{key:"pingPongDelayTime",type:"list",value:["1n","2n","4n","8n","16n","32n","2t","4t","8t","16t","32t"]},{key:"pingPongFeedback",type:"number",value:.25,range:[0,1],step:.01},{key:"tremoloChance",type:"chance",value:.25},{key:"tremoloFrequency",type:"range",value:[9,9],range:[1,18],step:1},{key:"tremoloDepth",type:"range",value:[.1,.5],range:[0,1],step:.05},{key:"vibratoChance",type:"chance",value:.25},{key:"vibratoFrequency",type:"range",value:[9,9],range:[1,18],step:1},{key:"vibratoDepth",type:"range",value:[.1,.5],range:[0,1],step:.05}],a={};function o(e){const t={reverb:e=>new Tone.Reverb(e.decay),distortion:e=>new Tone.Distortion(e.distortion),bitCrush:e=>new Tone.BitCrusher(e.bits),autoFilter:e=>new Tone.AutoFilter(e.frequency).start(),autoPanner:e=>new Tone.AutoPanner(e.frequency).start(),cheby:e=>new Tone.Chebyshev(Math.round(e.order)),chorus:e=>{const t=Math.round(e.frequency),n=e.delay,a=e.depth;return new Tone.Chorus(t,n,a).start()},feedback:e=>new Tone.FeedbackDelay(e.delay,e.feedback),phaser:e=>{const t=Math.floor(e.frequency),n=Math.floor(e.octaves),a=Math.floor(e.base);return new Tone.Phaser(t,n,a)},pingPong:e=>new Tone.PingPongDelay(e.delay,e.feedback),tremolo:e=>{const t=Math.floor(e.frequency),n=e.depth;return new Tone.Tremolo(t,n).start()},vibrato:e=>{const t=Math.floor(e.frequency),n=e.depth;return new Tone.Vibrato(t,n)}};return{get:function(e,n){return t[e](n)}}}n.forEach((e=>{const{key:t,value:n,type:o}=e;switch(o){case"range":case"chance":case"number":case"loops":case"walker":a[t]=n;break;case"list":a[t]=e.shuffle?function(e){let t,n,a=e.length;for(;0!==a;)n=Math.floor(Math.random()*a),a-=1,t=e[a],e[a]=e[n],e[n]=t;return e}(n):n}})),window.DoodooControls={defaults:a,controls:n},window.Doodoo=function(t,n){let l,u,p=t.debug,i=!1,v=t.duration??"4n",h=t.scale??[0,2,4,5,7,9,11],g=t.autoStart??!0,f=t.autoLoad??!0,C=t.useOctave??!1,A=t.sequence??[[!0]],b=t.onLoop,E=t.volume??0,w=t.useMeter,H=t.voices??[t.samples],D=t.stacking??[];if(t.controls){t.controls.voiceList&&t.controls.voiceList.filter((e=>!H.includes(e))).forEach((e=>{e&&H.push(e)}));let e=t.controls.startLoops.flatMap((e=>e.flatMap((e=>e.voice)))).filter((e=>!H.includes(e)));e.length>0&&e.forEach((e=>{e&&H.push(e)}))}0===H.length&&H.push("FMSynth");let x,I=t.withRecording,T=t.withCount;I&&(x=new Tone.Recorder,T||(T=+prompt("Record number of mutations?",10)));let M="string"==typeof t.tonic?t.tonic:r[t.tonic];t.transform||(t.transform=t.tonic);let F="string"==typeof t.transform?t.transform:r[t.transform],O={...a,...t.controls},U=new o(O),L=[];if("string"==typeof t.parts[0]){const e=t.parts.map((e=>[e,v]));L.push(new m(e,O,v,p))}else if("number"==typeof t.parts[0]){const e=t.parts.map((e=>[r[e],v]));L.push(new m(e,O,v,p))}else if(Array.isArray(t.parts[0]))if(Array.isArray(t.parts[0][0]))for(let e=0;e<t.parts.length;e++){const n=t.parts[e],a=t.parts[e].map((e=>parseInt(e[1])));v=Math.max(...a)+"n",L.push(new m(n,O,v,p))}else{const e=t.parts;L.push(new m(e,O,v,p));const n=t.parts.map((e=>parseInt(e[1])));v=Math.max(...n)+"n"}let G,B=0,R=0,S=[],$=[],P=0,q=0;const _=t.useMetro;let j,N=[...H,...D.flatMap((e=>e))].some((e=>!e.includes("Synth"))),K=!1,Q=!1;async function V(){try{await Tone.start(),N?function(n){let a=function(){let t={};return new Set([...H,...D.flatMap((e=>e))]).forEach((n=>{if("choir"===n)"AEIOU".split("").forEach((a=>{const o=e["choir"+a];for(const e in o)t[`${n}-${a}-${e}`]=`${n}/${a}/${o[e]}`}));else for(const a in e[n])t[`${n}-${a}`]=`${n}/${e[n][a]}`})),t}();console.time(`load ${H.join(", ")}`),u=new Tone.ToneAudioBuffers({urls:a,baseUrl:t.samplesURL||"../samples/",onload:()=>{console.timeEnd(`load ${H.join(", ")}`),n&&n(),K=!0}})}(z):z()}catch(e){console.error("load tone error",e)}}function z(){n&&n(),G=new Tone.Loop(W,v),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),G.start(Tone.Transport.seconds),w&&(l=new Tone.Meter({channels:2}),Tone.Destination.connect(l),t.setMeter(l)),(g||Q)&&J(),_&&(j=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),i=!0,I&&x.start()}function J(){q=0;const e=[];for(let t=0;t<S.length;t++)e.push(S[t].voice);for(let t=0;t<$.length;t++)e.push($[t]);S=[],$=[];for(let t=0;t<e.length;t++){e[t];setTimeout((()=>{e[t].dispose()}),1e3)}let n=L.filter(((e,t)=>A[t][B]));for(let e=0;e<n.length;e++){const t=n[e].getLoops();for(let e=0;e<t.length;e++){const n=t[e];let a=n.voice??y(H);D[e]&&D[e].length>0&&(a=y(D[e]));const o={...n,melody:0===n.harmony?c(n.melody,M,F):s(n.melody,M,F,n.harmony,h,C),voice:X(a,{...n,volume:E})};S.push(o)}}P=Math.max(0,Math.max(...S.map((e=>e.melody.length))));const a=Math.max(...S.flatMap((e=>e.melody.map((e=>e[1].slice(0,-1))))));G.interval=a+"n";let o=n.map((e=>e.update()))[0];t.onMutate&&t.onMutate(o),B++,B>=A[0].length&&(B=0),R++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),T&&R>T*A[0].length&&(Tone.Transport.stop(),i=!1,x&&Y()),b&&b(R,o)}function W(e){_&&j.triggerAttackRelease("C4","4n",e,.1);for(let t=0;t<S.length;t++){const n=S[t],a=new k(...O.attackStep);if(a.set(n.attack),!(n.count>n.countEnd)){for(let t=0;t<n.beatCount;t++){if(n.count<n.startDelay)continue;if(n.count%1!=0&&!n.doubler)continue;if(d(n.restChance))continue;const o=n.melody[Math.floor(n.count-n.startDelay+n.startIndex)%n.melody.length];if(null!==o[0]){const[r,l]=o;let u=t*Tone.Time(2*+l.slice(0,-1)+"n").toSeconds();n.voice.triggerAttackRelease(r,l,e+u,a.get())}}n.count+=1,a.update()}}q++,q===P&&J()}function X(t,n){const a=t.includes("Synth")?function(e){return new Tone.FMSynth({volume:e.volume||-6,envelope:{attack:e.voiceAttack,attackCurve:e.voiceCurve,release:e.voiceRelease,releaseCurve:e.voiceCurve}})}(n):function(t,n){const a=function(t){const n={};if("choir"===t){const a=R<3?"U":y("AEIOU".split(""));for(const o in e[t+a])n[o]=u.get(`${t}-${a}-${o}`)}else for(const a in e[t])n[a]=u.get(`${t}-${a}`);return n}(t),o=["toms"].includes(t)?n.voiceAttack/4:n.voiceAttack;return new Tone.Sampler({urls:a,volume:n.volume||0,attack:o,release:n.voiceRelease,curve:n.voiceCurve})}(t,n);return I?a.chain(Tone.Destination,x):a.toDestination(),U.get(R,t).forEach((e=>{I?e.chain(Tone.Destination,x):e.toDestination(),a.connect(e),$.push(e)})),a}async function Y(){const e=await x.stop(),n=URL.createObjectURL(e),a=document.createElement("a"),o=prompt("Name clip",t.title||"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));a.download=o+".webm",a.href=n,a.click()}return f&&V(),{play:function(){if(!f)return V();!N||K?(J(),G.start(Tone.Transport.seconds),i=!0,I&&x.start()):Q=!0},stop:function(){Tone.Transport.stop(),G.stop(),i=!1,I&&"started"===x.state&&Y()},mutate:function(){L.forEach((e=>{e.update()}))},moveTonic:function(e){let t=r.indexOf(transpose)+e;transpose=r[t]},setTonic:function(e){transpose=e},moveBPM:function(e){let t=Tone.Transport.bpm.value;Tone.Transport.bpm.value=t+e},setBPM:function(e){Tone.Transport.bpm.value=e},getIsPlaying:function(){return i},isRecording:function(){return!!x&&("started"===x.state||"paused"===x.state)},printLoops:function(){console.log("loops",S)},getLoops:function(){return S},printParams:function(){console.log(L.map((e=>e.getParams())))}}};const r=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"],l=[12,83];function u(e){for(false;e<l[0];)e+=12;for(;e>l[1];)e-=12;return e}function c(e,t,n,a){return e.map((e=>{if(null===e[0])return e;{const a=e[0],o=r.indexOf(t)-r.indexOf(n),l=r.indexOf(a)-o;return e[0]=r[u(l)],e}}))}function s(e,t,n,a,o,l=!1){return e.map((e=>{if(null===e[0])return e;{const c=e[0],s=r.indexOf(c),p=r.indexOf(t),i=p-r.indexOf(n),m=12*(Math.floor(s/12)-Math.floor(p)/12),v=s-p,h=v<0?o.indexOf(12-Math.abs(v)%12):o.indexOf(v%12);let y=o[(h+a-1)%o.length];l&&(y+=12*Math.floor((h+a-1)/o.length)),-1===h&&(console.log("not in scale"),y=0);let g=12*Math.floor(Math.abs(v)/12)*Math.sign(v),d=r.indexOf(t)+y+g-i+m;return e[0]=r[u(d)],e}}))}function p(e,t,n){let a=new h(t.min??{value:0}),o=new h(t.max??{value:1}),r=new h(t.step??{value:1}),l=new h(t.kick??{value:0}),u=new h(t.chance??{value:.5}),c=new h(t.type??{value:"value"}),s=!(l.get()>0);function p(){e<a.get()&&(e=a.get()),e>o.get()&&(e=o.get())}return{update:function(t){if(!s){if(t<l.get())return;t>=l.get()&&(s=!0)}d(u.get())&&(a.update(t),o.update(t),"walk"===c.get()&&(e+=d(.5)?r.get():-r.get()),"walkUp"===c.get()&&(e+=r.get()),"walkDown"===c.get()&&(e-=r.get()),p())},get:function(){return"range"===c.get()&&s?y(a.get(),o.get()):(p(),e)},set:function(t){e=t,p()}}}function i(e,n,a,o){let r={};for(const e in n)"bundle"===n[e]?.type?r[e]=new t(n[e],e):r[e]=new h(n[e],e);function l(t){return e.flatMap((e=>{let[n,o]=e,l=t/4*parseInt(o),u=parseInt(a)/l,c=[[d(r.rest.get())?null:n,l+"n",r.velocityStep.get()]];r.velocityStep.update();for(let e=1;e<u;e++)c.push([null,a,r.velocityStep.get()]),r.velocityStep.update();return c}))}return{get:function(){const e=[],t=r.loopNum.getInt(),o=[...Array(t)].map((()=>r.beatList.get())),u=Math.min(...o);for(let c=0;c<t;c++){r.velocityStep.set(r.velocityStart.get());let t=l(o[c]);const s=[...t];for(let e=1;e<o[c]/u;e++)t=t.concat([...s]);let p=r.startIndex.getInt();if(p>0){for(;null===t[p][0];)p++,p>=t.length&&(p=0);t=t.slice(p).concat(t.slice(0,p))}const i=c>0?r.startDelay.getInt():0;for(let e=0;e<i;e++)t.unshift([null,a]);const m={};let v=0;for(;Object.keys(m).length<r.fxLimit.get()&&v<n.fxList.list.length;){const e=r.fxList.get();r[e]&&d(r[e].get().chance)&&(m[e]=r[e].get()),v++}d(r.reverb.get().chance)&&(m.reverb=r.reverb.get()),console.log("fx",m),e.push({melody:t,count:0,countEnd:t.length-1,beatCount:1,harmony:d(r.harmonyChance.get())?r.harmonyList.get():0,instrument:r.instruments.get(c),attack:r.attack.get(),curve:r.curve.get(),release:r.release.get(),double:d(r.doubleChance.get()),fx:m})}return e},update:function(t){for(const e in r)r[e].update(t);if(d(r.sliceChance.get())){let t=g(e.length),n=e.slice(t,t+r.sliceLength.getInt());e.push(...n)}d(r.shiftChance.get())&&e.length>r.shiftLength.get()&&e.shift()}}}function m(e,t,n,a){let o=0;const r=+n.slice(0,-1),l=new C(...t.attackStart),u=new C(...t.restChance),c=new C(...t.loopNums),s=new f(t.harmonyList,t.harmonyIndex,t.harmonyUpdateChance),p=new C(...t.startIndexes),i=new f(t.durationList,t.durationIndex,t.durationChance),m=new f(t.startDelayList,t.startDelayIndex,t.startDelayChance),v=new k(...t.harmonyChance),h=new C(...t.sliceLength),A=new f(t.voiceList,t.voiceIndex,t.voiceChance),b=new C(...t.voiceAttack),E=new C(...t.voiceRelease),w=new f(t.voiceCurve,t.voiceCurveIndex,t.voiceCurveUpdateChance),H=I(e,r),D={noteDuration:4,count:0,counter:1,repeat:1,startIndex:0,startDelay:0,harmony:0,melody:H,countEnd:H.length-1,beatCount:1,attack:.5,restChance:0,voiceAttack:.1,voiceRelease:1,voiceCurve:"linear"},x=t.startLoops.map((e=>e.map((e=>({...D,...e})))));function I(e,t,n){return e.flatMap((e=>{let[a,o]=e;o=+o.slice(0,-1);let r=t/o;n&&n<t&&(r=t/n,o=t/o*(o/n));let l=[[a,o+"n"]];for(let e=1;e<r;e++)l.push([null,t+"n"]);return l}))}return{update:function(){return function(){if(c.update(),s.update(),p.update(),i.update(),m.update(),v.update(),A.update(),w.update(),d(t.sliceChance)){let t=g(e.length),n=e.slice(t,t+h.getRandInt());e.push(...n)}d(t.shiftChance)&&e.length>t.shiftLength&&e.shift(),o++,a&&console.log(`${o} mutations`)}(),o},getLoops:function(n,a){if(x[o])return x[o];const h=[],g=Math.min(t.maxLoops,c.getRandInt()),f=new k(...t.indexStep);f.set(p.getRandInt());let C=0;for(let n=0;n<g;n++){const n=i.getRandom();let a=I(e,r,n);const o=n>9?y(t.repeat):1;h.push({noteDuration:n,count:0,beatCount:n<32&&d(t.doublerChance)?2:1,countEnd:(a.length-1)*o+C,repeat:o,startIndex:f.get(),startDelay:C,melody:a,harmony:d(v.get())?s.getRandom():0,attack:l.getRandom(),restChance:u.getRandom(),voice:A.getRandom(),voiceAttack:b.getRandom(),voiceRelease:E.getRandom(),voiceCurve:w.getRandom()}),f.update(),C=m.getRandom()}return h},getParams:function(){return{loopNums:c.getRange(),durationList:i.getSlice(),startIndexes:p.getRange(),startDelayList:m.getSlice(),harmonyList:s.getSlice(),harmonyChance:v.get(),attackStart:l.getRange(),restChance:u.getRange(),voiceList:A.getSlice(),voiceAttack:b.getRange(),voiceCurve:w.getSlice()}}}}window.DoodooMidi={MIDI_NOTES:r},window.NewDoo=function(t,n){console.log("new doo params",t);let a="4n",l="string"==typeof t.tonic?t.tonic:r[t.tonic],u=t.transpose??l,p=t.useOctave??!1,m=t.scale??[0,2,4,5,7,9,11],v=t.sequence??[[!0]],h=t.volume??0,g=t.autoLoad??!0,d=t.autoStart??!0,f=!1,C=t.startLoops??[],k=t.useMeter??!1,A=(t.setMeter,t.useMetro??!1),b=t.withRecording??!1,E=t.withCount??!1,w=t.onLoop??!1,H=t.useDefaultProps??!0;const D=t.props?structuredClone(t.props):{};for(const e in DoodooProps.props)D.hasOwnProperty(e)||(D[e]=H?structuredClone(DoodooProps.props[e]):{});let x;console.log("new doo props",H,D);let I,T,M,F=[...new Set([...D.instruments.stack.flatMap((e=>e.list)).filter((e=>!e.includes("Synth"))),...C.flatMap((e=>e)).flatMap((e=>e)).filter((e=>e.instrument)).map((e=>e.instrument))])],O=0,U=0,L=!1,G=[],B=[],R=0,S=0,$=new o({}),P=[];t.parts.forEach((e=>{e.forEach((e=>{parseInt(e[1])>parseInt(a)&&(a=beat)}))})),D.beatList.list.forEach((e=>{e>parseInt(a)&&(a=e)}));for(let e=0;e<t.parts.length;e++)G.push(new i(t.parts[e],D,a,false));async function q(){try{await Tone.start(),F.length>0?function(n){const a={};for(let t=0;t<F.length;t++){const n=F[t];if("choir"===n)"AEIOU".split("").forEach((t=>{const o=e["choir"+t];for(const e in o)a[`${n}-${t}-${e}`]=`${n}/${t}/${o[e]}`}));else for(const t in e[n])a[`${n}-${t}`]=`${n}/${e[n][t]}`}console.time(`load ${F.join(", ")}`),x=new Tone.ToneAudioBuffers({urls:a,baseUrl:t.samplesURL||"../samples/",onload:()=>{console.timeEnd(`load ${F.join(", ")}`),n&&n(),samplesLoaded=!0}})}(_):_()}catch(e){console.error("load tone error",e)}}function _(){n&&n(),I=new Tone.Loop(j,a),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),I.start(Tone.Transport.seconds);var e=new Tone.Compressor({threshold:-30,ratio:3,attack:.5,release:.1});const o=new Tone.Limiter(-20);Tone.Master.chain(e,o),k&&(T=new Tone.Meter({channels:2}),Tone.Destination.connect(T),t.setMeter(T)),(d||f)&&N(),A&&(metro=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),L=!0,b&&M.start()}function j(e){A&&metro.triggerAttackRelease("C4","4n",e,.1);for(let t=0;t<B.length;t++){const n=B[t];if(!(n.count>n.countEnd)){for(let t=0;t<n.beatCount;t++){if(n.count%1!=0)continue;const t=Math.floor(n.count)%n.melody.length,a=n.melody[t];if(null!==a[0]){let[t,o,r]=a;if(r||(r=1),n.double){o=2*parseInt(o)+"n";let a=Tone.Time(o).toSeconds();n.instrument.triggerAttackRelease(t,o,e,r),n.instrument.triggerAttackRelease(t,o,e+a,r)}else n.instrument.triggerAttackRelease(t,o,e,r)}}n.count+=1}}S++,S===R&&N()}function N(){S=0,function(){const e=[];for(let t=0;t<B.length;t++)e.push(B[t].instrument);for(let t=0;t<P.length;t++)e.push(P[t]);for(let t=0;t<e.length;t++){e[t];setTimeout((()=>{e[t].dispose()}),1e3)}B=[],P=[]}(),B=[];let e=G.filter(((e,t)=>v[t][O]));for(let t=0;t<e.length;t++){const n=e[t].get();for(let e=0;e<n.length;e++){const a=n[e];if(C[U]&&C[U][e])for(const n in C[U][e])a[n]=C[t][e][n];const o={...a,melody:0===a.harmony?c(a.melody,l,u):s(a.melody,l,u,a.harmony,m,p),instrument:K(a.instrument,{...a,volume:h})};B.push(o)}}R=Math.max(0,Math.max(...B.map((e=>e.melody.length))));const n=Math.max(...B.flatMap((e=>e.melody.map((e=>parseInt(e[1]))))));I.interval=n+"n",e.forEach((e=>{e.update(U)})),t.onMutate&&t.onMutate(U),O++,O>=v[0].length&&(O=0),U++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),E&&U>E*v[0].length&&(Tone.Transport.stop(),L=!1,M&&saveRecording()),w&&w(U,0)}function K(t,n){const a=t.includes("Synth")?function(e){return new Tone.FMSynth({volume:e.volume??-6,envelope:{attack:e.attack,attackCurve:e.curve,release:e.release,releaseCurve:e.curve}})}(n):function(t,n){const a=function(t){const n={};if("choir"===t){const a=U<3?"U":y("AEIOU".split(""));for(const o in e[t+a])n[o]=x.get(`${t}-${a}-${o}`)}else for(const a in e[t])n[a]=x.get(`${t}-${a}`);return n}(t);return new Tone.Sampler({urls:a,volume:n.volume??0,attack:n.attack,release:n.release,curve:n.curve})}(t,n);b?a.chain(Tone.Destination,M):a.toDestination();for(const e in n.fx){const t=$.get(e,n.fx[e]);b?t.chain(Tone.Destination,M):t.toDestination(),a.connect(t),P.push(t)}return a}return b&&(M=new Tone.Recorder,E||(E=+prompt("Record number of mutations?",10))),g&&q(),{play:function(){if(!g)return q();!usesSamples||samplesLoaded?(N(),I.start(Tone.Transport.seconds),L=!0,b&&M.start()):f=!0},stop:function(){Tone.Transport.stop(),I.stop(),L=!1,b&&"started"===M.state&&saveRecording()},getLoops:()=>B,printLoops:()=>{console.log("loops",B)}}};const v={instruments:{stack:[{list:["choir"]}],options:["choir","fmSynth",...Object.keys(e)]},loopNum:{value:1,step:1,mod:{type:{value:"range"},min:{value:1,chance:1,mod:{min:{value:1},max:{value:3},type:{value:"walkUp"},chance:{value:.5}}},max:{value:1,mod:{min:{value:1},max:{value:5},type:{value:"walkUp"},chance:{value:.5}}}}},harmonyChance:{value:0,step:.01,mod:{min:{value:.5},max:{value:.5},kick:{value:1},chance:{value:1}}},harmonyList:{list:[4,5,3,7,2,6],index:0,mod:{type:{value:"range"},min:{value:0},max:{value:0,mod:{min:{value:0},max:{value:5},step:{value:1},type:{value:"walkUp"}}}}},beatList:{list:[4,2,1,8,16],index:0,mod:{type:{value:"range"},chance:{value:1},min:{value:0},max:{value:0,mod:{max:{value:6},chance:{value:.3},type:{value:"walkUp"}}}}},startIndex:{value:0,mod:{max:{value:0,mod:{min:{value:0},max:{value:8},chance:{value:.3},type:{value:"walkUp"}}},type:{value:"range"},chance:{value:1}}},startDelay:{list:[0,1,2,4,8,3,5,7],index:6,mod:{min:{value:0},type:{value:"range"},chance:{value:1},max:{value:6,mod:{max:{value:12},chance:{value:.3},type:{value:"walkUp"}}}}},sliceChance:{value:.1,step:.05},sliceLength:{value:1,mod:{type:{value:"range"},min:{value:1},max:{value:3,mod:{max:{value:8},type:{type:"walkUp"}}}}},shiftChance:{value:.2,step:.05},shiftLength:{value:16,mod:{min:{value:16,mod:{min:{value:8},max:{value:16},type:{value:"walkDown"}}},max:{value:32},type:{value:"range"}}},doubleChance:{value:.1,step:.05},velocityStart:{value:.75,step:.05,mod:{min:{value:.25},max:{value:.85},type:{value:"range"}}},velocityStep:{value:.5,step:.01,mod:{min:{value:.1},max:{value:1},chance:{value:.66},type:{value:"walk"},step:{value:.01,mod:{min:{value:.01},max:{value:.1},type:{value:"range"},chance:{value:.2}}}}},attack:{value:.1,step:.05,mod:{type:{value:"range"},min:{value:.1},max:{value:.5}}},curve:{list:["linear","exponential","sine","cosine","bounce","ripple","step"],index:0,mod:{chance:{value:.1},min:{value:0},max:{value:6},type:{value:"range"}}},release:{value:.5,step:.05,mod:{type:{value:"range"},min:{value:.1},max:{value:.5}}},rest:{value:0,step:.05,type:"chance",mod:{min:{value:0,type:"chance",step:.05},max:{value:.25,type:"chance",step:.05},type:{value:"range"},kick:{value:2}}},fxLimit:{value:1},fxList:{list:["distortion","bitCrush","autoFilter","autoPanner","cheby","chorus","feedback","phaser","pingPong","tremolo","vibrato"],index:0,mod:{type:{value:"range"},min:{value:0},max:{value:10}}},reverb:{type:"bundle",chance:{value:1},decay:{value:5,step:.1,range:[.5,32]}},distortion:{type:"bundle",chance:{value:.25,type:"chance"},distortion:{value:.1,step:.01,mod:{min:{value:.05},max:{value:.2},type:{value:"range"}}}},bitCrush:{type:"bundle",chance:{value:.25,type:"chance"},bits:{list:[3,4,6,8,12,16],mod:{min:{value:0},max:{value:5},type:{value:"range"},chance:{value:1}}}},autoFilter:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{list:["2n","4n","8n","16n","32n"],mod:{min:{value:0},max:{value:4},type:{value:"range"},chance:{value:1}}}},autoPanner:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{list:["2n","4n","8n","16n","32n"],mod:{min:{value:0},max:{value:4},type:{value:"range"},chance:{value:1}}}},cheby:{type:"bundle",chance:{value:.25,type:"chance"},order:{value:16,mod:{min:{value:0},max:{value:100},type:{value:"range"},chance:{value:1}}}},chorus:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{value:4,mod:{min:{value:1},max:{value:12},type:{value:"range"},chance:{value:1}}},delay:{value:2.5,mod:{min:{value:.1},max:{value:12},step:{value:.1},type:{value:"range"},chance:{value:1}}},depth:{value:.5,mod:{min:{value:0},max:{value:1},type:{value:"range"},chance:{value:1}}}},feedback:{type:"bundle",chance:{value:.25,type:"chance"},feedback:{value:.25,mod:{min:{value:.1},max:{value:1},step:{value:.01},type:{value:"range"},chance:{value:1}}},delay:{list:["8n","4n","16n","32n"],mod:{min:{value:0},max:{value:3},type:{value:"range"},chance:{value:1}}}},phaser:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{value:15,mod:{min:{value:0},max:{value:32},type:{value:"range"},chance:{value:1}}},octaves:{value:5,mod:{min:{value:1},max:{value:16},type:{value:"range"},chance:{value:1}}},base:{value:1e3,mod:{min:{value:0},max:{value:1e4},type:{value:"range"},chance:{value:1}}}},pingPong:{type:"bundle",chance:{value:.25,type:"chance"},feedback:{value:.25,mod:{min:{value:.1},max:{value:1},step:{value:.01},type:{value:"range"},chance:{value:1}}},delay:{list:["1n","2n","4n","8n","16n","32n","2t","4t","8t","16t","32t"],mod:{min:{value:0},max:{value:10},type:{value:"range"},chance:{value:1}}}},tremolo:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{value:9,mod:{min:{value:1},max:{value:18},type:{value:"range"},chance:{value:1}}},depth:{value:.25,mod:{min:{value:.1},max:{value:1},step:{value:.05},type:{value:"range"},chance:{value:1}}}},vibrato:{type:"bundle",chance:{value:.25,type:"chance"},frequency:{value:9,mod:{min:{value:1},max:{value:18},type:{value:"range"},chance:{value:1}}},depth:{value:.25,mod:{min:{value:.1},max:{value:1},step:{value:.05},type:{value:"range"},chance:{value:1}}}}};function h(e={},t){let n=e.hasOwnProperty("list")?"list":"value";e.hasOwnProperty("stack")&&(n="stack");let a,o=e.value??0,r=e.index??0,l=e.list??[],u=e.stack??[],c=!1;function s(e){if("stack"===n){let t;return t=e<u.length?y(u[e].list):y(u.flatMap((e=>e.list))),t}if("list"===n){let e=c?Math.round(a.get()):r;return l[Math.min(l.length-1,e)]}return c?a.get():o}return e.mod&&(c=!0,a=new p("value"===n?o:r,e.mod,t)),{update:function(e){c&&a.update(e)},get:s,set:function(e){o=e,a&&a.set(o)},getInt:function(){return Math.floor(s())}}}function y(e,t){return t?Math.random()*(t-e)+e:"number"==typeof e?Math.random()*e:Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:"object"==typeof e?e[y(Object.keys(e))]:void 0}function g(e,t){return t||(t=e,e=0),Math.round(Math.random()*(t-e)+e)}function d(e){return y(1)<e}function f(e,t,n){return void 0===n&&(n=.5),{update:()=>{t!==e.length&&d(n)&&t++},getRandom:()=>y(e.slice(0,t)),getSlice:()=>e.slice(0,t),get:()=>e}}function C(e,t,n,a){return{update:function(){d(Math.abs(n))&&e+Math.sign(n)<t&&(e+=Math.sign(n)),d(Math.abs(a))&&t+Math.sign(a)>e&&(t+=Math.sign(a))},getRange:()=>[e,t],getRandom:()=>y(e,t),getRandInt:()=>g(e,t),getMin:()=>e,getMax:()=>t}}function k(e,t=.1,n=1,a=0,o=1,r=0,l=!1){function u(t){(e=t)<a&&(e=a),e>o&&(e=o)}return o<e&&(o=e),{update:function(){d(n)&&u(e+(d(.5+r/2)?t:-t))},set:u,get:()=>e,setMin:e=>{a=e},setMax:e=>{o=e}}}window.DoodooProps={props:v}}();
//# sourceMappingURL=src_maps/doodoo.min.js.map
