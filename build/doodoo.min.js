(()=>{"use strict";var e={d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};function n(e,t){return t?Math.random()*(t-e)+e:"number"==typeof e?Math.random()*e:Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:"object"==typeof e?e[n(Object.keys(e))]:void 0}function a(e,t){return t||(t=e,e=0),Math.round(Math.random()*(t-e)+e)}function o(e){return n(1)<e}e.d(t,{default:()=>m});class r{constructor(e,t,n,a){this.min=e,this.max=void 0===t?e:t,n&&(this.ch1=n||.5),a&&(this.ch2=a||.5)}update(){o(Math.abs(this.ch1))&&this.min<this.max&&(this.min+=Math.sign(this.ch1)),o(Math.abs(this.ch2))&&(this.max+=Math.sign(this.ch2))}get range(){return[this.min,this.max]}get random(){return n(...this.range)}get randInt(){return a(...this.range)}}class s{constructor(e,t,n){this.values=e,this.addValues=t||[],this.chance=n||.5}add(e){this.values.push(e)}update(){o(this.chance)&&this.addValues.length>0&&this.values.push(this.addValues.pop())}get random(){return n(this.values)}}const l=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"];function c(e,t,n,a){return e.map((e=>{if(null===e[0])return e;{const[a,o]=e,r=l.indexOf(t)-l.indexOf(n),s=l.indexOf(a)-r;return[l[s],o]}}))}function u(e,t,n,a,o){return e.map((e=>{if(null===e[0])return e;{const[r,s]=e,c=l.indexOf(r),u=l.indexOf(t),i=u-l.indexOf(n),p=c-u,h=p<0?o.indexOf(12-Math.abs(p)%12):o.indexOf(p%12);-1===h&&console.log("note note in scale ... ");let y=o[(h+a-1)%o.length],f=12*Math.floor(Math.abs(p)/12)*Math.sign(p),d=l.indexOf(t)+y+f-i;return[l[d],s]}}))}function i(e,t,l,c){let u=0;const i=new r(...t.loopNums),p=new s(t.harmonyStart,t.harmonyAdd,t.harmonyChance),h=new r(...t.startIndexes),y=new r(...t.indexStep),f=new s(t.durationStart,t.durationAdd,t.durationsChance),d=new s(t.startDelaysStart,t.startDelaysAdd,t.startDelaysChance),m={noteDuration:l,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0,melody:e},g=t.startLoops.map((e=>e.map((e=>({...m,...e})))));this.getTestLoops=function(){return[{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:e,harmony:0},{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:e,harmony:4}]},this.getLoops=function(){if(g[u])return g[u];const t=[],a=i.randInt;let r=h.randInt,s=0;for(let l=0;l<a;l++){let a=f.random;t.push({noteDuration:a,count:0,counter:a<4?a/4:1,doubler:a>4&&a<32&&o(.5),doublerCounter:a>4&&o(.4),repeat:a>9?n([2,3,4]):1,startIndex:r,startDelay:s,melody:e,harmony:o(.6)?p.random:0}),r=Math.max(0,n([r,r+y.min,r+y.max])),s=d.random}return t},this.update=function(){return function(){if(i.update(),p.update(),h.update(),y.update(),f.update(),d.update(),o(t.sliceChance)){let n=a(e.length),o=e.slice(n,n+a(1,t.sliceLength));e.push(...o)}o(t.shiftChance)&&e.length>t.shiftLength&&e.shift(),u++,c&&console.log(`${u} mutations`)}(),u}}let p=[{key:"attackStart",type:"range",value:[.25,.7],range:[0,1],step:.05,panel:"attack"},{key:"attackStep",type:"range",value:[-.2,.2],range:[-1,1],step:.05,panel:"attack"},{key:"loopNums",type:"range",value:[1,1,.1,.2],range:[1,32],step:1,panel:"loop"},{key:"harmonyStart",type:"list",value:[4,5],panel:"harmony"},{key:"harmonyAdd",type:"list",value:[2,3,6,7],shuffle:!0,panel:"harmony"},{key:"harmonyChance",type:"chance",value:.2,panel:"harmony"},{key:"startIndexes",type:"range",value:[0,0,0,.3],range:[0,0],step:1,panel:"index"},{key:"indexStep",type:"range",value:[0,0,-.2,.2],range:[0,8,-1,1],step:1,panel:"index"},{key:"durationStart",type:"list",value:[2,4],panel:"loop"},{key:"durationAdd",type:"list",value:[1,8,16,32],shuffle:!0,panel:"loop"},{key:"durationChance",type:"chance",value:.3,panel:"loop"},{key:"startDelaysStart",type:"list",value:[0,1,2,4,.5,8],panel:"index"},{key:"startDelaysAdd",type:"list",value:[12,16,3,5,7,11],shuffle:!0,panel:"index"},{key:"startDelaysChance",type:"chance",value:.3,panel:"index"},{key:"sliceChance",type:"chance",value:.1,panel:"slice"},{key:"sliceLength",type:"number",value:3,range:[1,8],panel:"slice"},{key:"shiftChance",type:"chance",value:.2,panel:"slice"},{key:"shiftLength",type:"number",value:16,range:[0,32],panel:"slice"},{key:"startLoops",type:"loops",value:[],panel:"loops"},{key:"fxLimit",type:"number",value:4,range:[0,16],panel:"effects"},{key:"reverbChance",type:"chance",value:1,panel:"effects"},{key:"reberbDelay",type:"number",value:0,range:[0,16],panel:"effects"},{key:"reverbDecay",type:"number",value:5,range:[.5,32],step:.1,panel:"effects"},{key:"distortionChance",type:"chance",value:.25,panel:"effects"},{key:"distortionDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"distortion",type:"range",value:[.05,.2],range:[.01,1],step:.01,panel:"effects"},{key:"bitCrushChance",type:"chance",value:.25,panel:"effects"},{key:"bitCrushDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"bitCrushBits",type:"list",value:[3,4,6,8,12,16],panel:"effects"},{key:"autoFilterChance",type:"chance",value:.25,panel:"effects"},{key:"autoFilterDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"autoFilterFrequency",type:"list",value:["2n","4n","8n","16n","32n"],panel:"effects"},{key:"autoPannerChance",type:"chance",value:.25,panel:"effects"},{key:"autoPannerDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"autoPannerFrequency",type:"list",value:["2n","4n","8n","16n","32n"],panel:"effects"},{key:"chebyChance",type:"chance",value:.25,panel:"effects"},{key:"chebyDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"chebyOrder",type:"number",value:16,range:[1,100],panel:"effects"},{key:"chorusChance",type:"chance",value:.25,panel:"effects"},{key:"chorusDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"chorusFrequency",type:"number",value:4,range:[1,12],panel:"effects"},{key:"chorusDelayTime",type:"number",value:2.5,range:[.1,12],step:.1,panel:"effects"},{key:"chorusDepth",type:"number",value:.5,range:[0,1],panel:"effects"},{key:"feedbackChance",type:"chance",value:.25,panel:"effects"},{key:"feedbackDelay",type:"number",value:8,range:[0,16],panel:"effects"},{key:"feedbackDelayTime",type:"list",value:["8n","4n","16n","32n"],panel:"effects"},{key:"feedback",type:"number",value:.5,range:[.1,1],step:.01,panel:"effects"}],h={};p.forEach((e=>{const{key:t,value:n,type:a}=e;switch(a){case"range":case"chance":case"number":case"loops":h[t]=e.value;break;case"list":h[t]=e.shuffle?function(e){let t,n,a=e.length;for(;0!==a;)n=Math.floor(Math.random()*a),a-=1,t=e[a],e[a]=e[n],e[n]=t;return e}(n):n}}));const y={params:p,defaults:h},f=y.defaults,d=y.params;Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)};const m={Doodoo:function(e,t){let s,p,h,y=!1,d=[],m=e.debug,g=e.samples||"synth",D=e.startDuration||"4n",b=e.withRecording;b&&(p=new Tone.Recorder,h=+prompt("Record number of mutations?",10));const v=e.scale||[0,2,4,5,7,9,11];let k="string"==typeof e.tonic?e.tonic:l[e.tonic];e.transform||(e.transform=e.tonic);let C="string"==typeof e.transform?e.transform:l[e.transform],T=e.params,x={...f,...T},A=[];if("string"===e.parts[0]){const t=e.parts.map((e=>[e,D]));A.push(new i(t,x,D,m))}else if("number"==typeof e.parts[0]){const t=e.parts.map((e=>[l[e],D]));A.push(new i(t,x,D,m))}else if(Array.isArray(e.parts[0]))if(Array.isArray(e.parts[0][0]))for(let t=0;t<e.parts.length;t++){const n=e.parts[t];A.push(new i(n,x,D,m));const a=e.parts[t].map((e=>parseInt(e[1])));D=Math.max(...a)+"n"}else{const t=e.parts;A.push(new i(t,x,D,m));const n=e.parts.map((e=>parseInt(e[1])));D=Math.max(...n)+"n"}let F=0,w=0;const M=new r(...x.attackStart),E=new r(...x.attackStep);let L,G=[],O=0,I=0;const S=e.useMetro;let B;async function _(){await Tone.start(),"synth"!==g?function(t){d=[2,3,4].flatMap((e=>"ABCDEFG".split("").map((t=>`${t}${e}`))));let n={};for(let e=0;e<d.length;e++)"AEIOU".split("").forEach((t=>{const a=d[e];n[`${t}-${a}`]=`${t}/CH-${t}${t}-${a}.mp3`}));console.time("load choir samples"),s=new Tone.ToneAudioBuffers({urls:n,baseUrl:e.samples||"./doodoo/samples/choir/",onload:()=>{console.timeEnd("load choir samples"),t()}})}(P):P()}function P(){t&&t(),L=new Tone.Loop(R,D),Tone.Transport.start(),e.bpm&&(Tone.Transport.bpm.value=e.bpm),L.start(0),$(),S&&(B=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),y=!0,b&&p.start()}function $(){I=0,G=[],A[F].getLoops().forEach((e=>{const t={...e,melody:0===e.harmony?c(e.melody,k,C):u(e.melody,k,C,e.harmony,v),sampler:"synth"!==g?N():q()};G.push(t)})),G.forEach((e=>{let t=[];e.melody.forEach((e=>{const[n,a]=e;let o=+D[0]/+a[0];a.includes(".")&&(o*=1.5),t.push(e);for(let e=1;e<o;e++)t.push([null,D])})),e.melody=t,e.countNum=e.doubler?e.counter*e.noteDuration/4:1,e.countEnd=(e.melody.length-1)*e.repeat+e.startDelay,e.len=e.melody.length})),O=Math.max(0,Math.max(...G.map((e=>e.melody.length))));let t=A[F].update();e.onMutate&&e.onMutate(t),F++,F>=A.length&&(F=0),w++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),t>h&&(Tone.Transport.stop(),y=!1,j())}function R(e){S&&B.triggerAttackRelease("c4","4n",e,.1);let t=M.random;for(let n=0;n<G.length;n++){const a=G[n];if(!(a.count>a.countEnd)){for(let n=0;n<a.countNum;n++){if(a.count<a.startDelay)continue;if(a.count%1!=0&&!a.doubler)continue;const o=a.melody[Math.floor(a.count-a.startDelay+a.startIndex)%a.len];if(null!==o[0]){const[r,s]=o;let l=n?Tone.Time(`${a.noteDuration}n`).toSeconds()*n:0;a.sampler.triggerAttackRelease(r,s,e+l,t)}a.doublerCounter&&(a.count+=a.counter)}(!a.doublerCounter||a.count<a.startDelay)&&(a.count+=a.counter)}}t+=E.random,t.clamp(.1,1),I++,I===O&&$()}function q(){const e=(new Tone.FMSynth).toDestination();return U(e),b&&e.connect(p),e}function N(){const t=w<3?"U":n("AEIOU".split("")),a={};for(let e=0;e<d.length;e++){const n=d[e];a[n]=s.get(`${t}-${n}`)}const o=new Tone.Sampler({urls:a,volume:e.volume||0,release:1}).toDestination();return U(o),b&&o.connect(p),o}function U(e){let t=[];if(o(x.reverbChance)&&w>x.reverbDelay&&t.length<=x.fxLimit){const e=new Tone.Reverb({decay:x.reverbDecay}).toDestination();t.push(e)}if(o(x.distortionChance)&&w>x.distortionDelay&&t.length<=x.fxLimit){const e=n(...x.distortion),a=new Tone.Distortion(e).toDestination();t.push(a)}if(o(x.bitCrushChance)&&w>x.bitCrushDelay&&t.length<=x.fxLimit){const e=n(x.bitCrushBits),a=new Tone.BitCrusher(e).toDestination();t.push(a)}if(o(x.autoFilterChance)&&w>x.autoFilterDelay&&t.length<=x.fxLimit){const e=n(x.autoFilterFrequency),a=new Tone.AutoFilter(e).toDestination().start();t.push(a)}if(o(x.autoPannerChance)&&w>x.autoPannerDelay&&t.length<=x.fxLimit){const e=n(x.autoPannerFrequency),a=new Tone.AutoPanner(e).toDestination().start();t.push(a)}if(o(x.chebyChance)&&w>x.chebyDelay&&t.length<=x.fxLimit){const e=a(x.chebyOrder),n=new Tone.Chebyshev(e).toDestination();t.push(n)}if(o(x.chorusChance)&&w>x.chorusDelay&&t.length<=x.fxLimit){const e=a(x.chorusFrequency),o=n(x.chorusDelayTime),r=n(x.chorusDepth),s=new Tone.Chorus(e,o,r).toDestination().start();t.push(s)}if(o(x.feedbackChance)&&w>x.feedbackDelay&&t.length<=x.fxLimit){const e=n(x.feedback),a=n(x.feedbackDelayTime),o=new Tone.FeedbackDelay(a,e).toDestination();t.push(o)}t.forEach((t=>e.connect(t)))}async function j(){const e=await p.stop(),t=URL.createObjectURL(e),n=document.createElement("a"),a=prompt("Name clip","Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));n.download=a+".webm",n.href=t,n.click()}console.log(A),e.autoLoad&&_(),this.moveTonic=function(e){let t=l.indexOf(C)+e;C=l[t]},this.setTonic=function(e){C=e},this.printLoops=function(){console.log("loops",G)},this.moveBPM=function(e){let t=Tone.Transport.bpm.value;Tone.Transport.bpm.value=t+e},this.setBPM=function(e){Tone.Transport.bpm.value=e},this.getIsPlaying=function(){return y},this.play=function(){if(!e.autoLoad)return _();"stopped"===Tone.Transport.state&&$(),y=!0,b&&p.start()},this.stop=function(){Tone.Transport.stop(),y=!1,b&&j()},this.mutate=function(){A.forEach((e=>{e.update()}))}},MIDI_NOTES:l,doodooDefaults:f,doodooDefaultParams:d};window.doodooLib=t.default})();
//# sourceMappingURL=doodoo.min.js.map