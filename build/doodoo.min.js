(()=>{"use strict";var t={d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function n(t,e){return e?Math.random()*(e-t)+t:"number"==typeof t?Math.random()*t:Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:"object"==typeof t?t[n(Object.keys(t))]:void 0}function a(t){let e,n,a=t.length;for(;0!==a;)n=Math.floor(Math.random()*a),a-=1,e=t[a],t[a]=t[n],t[n]=e;return t}function o(t){return n(1)<t}t.d(e,{default:()=>y});class s{constructor(t,e,n,a){this.min=t,this.max=void 0===e?t:e,n&&(this.ch1=n||.5),a&&(this.ch2=a||.5)}update(){o(Math.abs(this.ch1))&&this.min<this.max&&(this.min+=Math.sign(this.ch1)),o(Math.abs(this.ch2))&&(this.max+=Math.sign(this.ch2))}get range(){return[this.min,this.max]}get random(){return n(...this.range)}get randInt(){return function(t,e){return e||(e=t,t=0),Math.round(Math.random()*(e-t)+t)}(...this.range)}}class r{constructor(t,e,n){this.values=t,this.addValues=e||[],this.chance=n||.5}add(t){this.values.push(t)}update(){o(this.chance)&&this.addValues.length>0&&this.values.push(this.addValues.pop())}get random(){return n(this.values)}}const l=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"];function c(t,e,n,a){return t.map((t=>{if(null===t[0])return t;{const[a,o]=t,s=l.indexOf(e)-l.indexOf(n),r=l.indexOf(a)-s;return[l[r],o]}}))}function i(t,e,n,a,o){return t.map((t=>{if(null===t[0])return t;{const[s,r]=t,c=l.indexOf(s),i=l.indexOf(e),u=i-l.indexOf(n),p=c-i,h=p<0?o.indexOf(12-Math.abs(p)%12):o.indexOf(p%12);-1===h&&console.log("note note in scale ... ");let d=o[(h+a-1)%o.length],f=12*Math.floor(Math.abs(p)/12)*Math.sign(p),m=l.indexOf(e)+d+f-u;return[l[m],r]}}))}function u(t,e,a,l){let c=0;const i=new s(...e.loopNums),u=new r(e.harmonies.start,e.harmonies.add,e.harmonies.chance),p=new s(...e.startIndexes),h=new s(...e.indexStep),d=new r(e.durations.start,e.durations.add,e.durations.chance),f=new r(e.startDelays.start,e.startDelays.add,e.startDelays.chance),m={noteDuration:a,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,harmony:0,melody:t},y=e.startLoops.map((t=>t.map((t=>({...m,...t})))));this.getTestLoops=function(){return[{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:0},{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:4}]},this.getLoops=function(){if(y[c])return y[c];const e=[],a=i.randInt;let s=p.randInt,r=0;for(let l=0;l<a;l++){let a=d.random;e.push({noteDuration:a,count:0,counter:a<4?a/4:1,doubler:a>4&&a<32&&o(.5),doublerCounter:a>4&&o(.4),repeat:a>9?n([2,3,4]):1,startIndex:s,startDelay:r,melody:t,harmony:o(.6)?u.random:0}),s=Math.max(0,n([s,s+h.min,s+h.max])),r=f.random}return e},this.update=function(){return function(){if(i.update(),u.update(),p.update(),h.update(),d.update(),f.update(),o(e.sliceChance)){let a=n(t.length),o=t.slice(a,a+n(e.sliceLength));t.push(...o)}o(e.shiftChance)&&t.length>e.shiftLength&&t.shift(),c++,l&&console.log(`${c} mutations`)}(),c}}let p=[{key:"attackStart",type:"range",value:[.25,.7],range:[0,1],step:[.05],panel:"attack"},{key:"attackStep",type:"range",value:[-.2,.2],range:[-1,1],step:[.05],panel:"attack"},{key:"loopNums",type:"range",value:[1,1,.1,.2],range:[1,32,0,1],step:[1,.01],panel:"loop"},{key:"harmonies",type:"list",start:[4,5],add:[2,3,6,7],chance:.2,shuffle:!0,panel:"loop"},{key:"startIndexes",type:"range",value:[0,0,0,.3],range:[0,0,0,1],step:[1,.01],panel:"index"},{key:"indexStep",type:"range",value:[0,0,-.2,.2],range:[0,8,-1,1],step:[1,.01],panel:"index"},{key:"durations",type:"list",start:[2,4],add:[1,8,16,32],chance:.3,panel:"loop"},{key:"startDelays",type:"list",start:[0,1,2,4,.5,8],add:[12,16,3,5,7,11],chance:.3,panel:"index"},{key:"sliceChance",type:"chance",value:.1,panel:"slice"},{key:"sliceLength",type:"int",value:3,range:[1,8],panel:"slice"},{key:"shiftChance",type:"chance",value:.2,panel:"slice"},{key:"shiftLength",type:"int",value:16,range:[0,32],panel:"slice"},{key:"startLoops",type:"loops",value:[],panel:"loops"},{key:"fxDelay",type:"int",value:8,range:[0,16],panel:"effects"},{key:"reverbChance",type:"chance",value:1,panel:"effects"},{key:"reverbDecay",type:"int",value:5,range:[.5,32],step:.1,panel:"effects"},{key:"distortionChance",type:"chance",value:.25,panel:"effects"},{key:"distortion",type:"range",value:[.05,.2],range:[.01,1],step:[.01],panel:"effects"},{key:"bitCrushChance",type:"chance",value:.25,panel:"effects"},{key:"bitCrushBits",type:"list",start:[4,8,12],add:[],panel:"effects"}],h={};p.forEach((t=>{const{key:e,type:n}=t;switch(n){case"range":case"chance":case"int":case"loops":h[e]=t.value;break;case"list":h[e]={start:t.start,add:t.shuffle?a(t.add):t.add,chance:t.chance}}}));const d={params:p,defaults:h},f=d.defaults,m=d.params;Number.prototype.clamp=function(t,e){return Math.min(Math.max(this,t),e)};const y={Doodoo:function(t,e){let a,r,p,h=!1,d=[],m=t.debug,y=t.samples||"synth",g=t.startDuration||"4n",D=t.withRecording;D&&(r=new Tone.Recorder,p=+prompt("Record number of mutations?",10));const b=t.scale||[0,2,4,5,7,9,11];let C="string"==typeof t.tonic?t.tonic:l[t.tonic];t.transform||(t.transform=t.tonic);let v="string"==typeof t.transform?t.transform:l[t.transform],x=t.params,T={...f,...x},k=[];if("string"===t.parts[0]){const e=t.parts.map((t=>[t,g]));k.push(new u(e,T,g,m))}else if("number"==typeof t.parts[0]){const e=t.parts.map((t=>[l[t],g]));k.push(new u(e,T,g,m))}else if(Array.isArray(t.parts[0])){const e=t.parts;k.push(new u(e,T,g,m));const n=t.parts.map((t=>parseInt(t[1])));g=Math.max(...n)+"n"}let M=0,w=0;const A=new s(...T.attackStart),E=new s(...T.attackStep);let F,G=[],O=0,B=0;const I=t.useMetro;let L;async function _(){await Tone.start(),"synth"!==y?function(e){d=[2,3,4].flatMap((t=>"ABCDEFG".split("").map((e=>`${e}${t}`))));let n={};for(let t=0;t<d.length;t++)"AEIOU".split("").forEach((e=>{const a=d[t];n[`${e}-${a}`]=`${e}/CH-${e}${e}-${a}.mp3`}));console.time("load choir samples"),a=new Tone.ToneAudioBuffers({urls:n,baseUrl:t.samples||"./doodoo/samples/choir/",onload:()=>{console.timeEnd("load choir samples"),e()}})}(S):S()}function S(){e&&e(),F=new Tone.Loop(R,g),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),F.start(0),$(),I&&(L=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),h=!0,D&&r.start()}function $(){B=0,G=[],k[M].getLoops().forEach((t=>{const e={...t,melody:0===t.harmony?c(t.melody,C,v):i(t.melody,C,v,t.harmony,b),sampler:"synth"!==y?P():N()};G.push(e)})),G.forEach((t=>{let e=[];t.melody.forEach((t=>{const[n,a]=t;let o=+g[0]/+a[0];a.includes(".")&&(o*=1.5),e.push(t);for(let t=1;t<o;t++)e.push([null,g])})),t.melody=e,t.countNum=t.doubler?t.counter*t.noteDuration/4:1,t.countEnd=(t.melody.length-1)*t.repeat+t.startDelay,t.len=t.melody.length,t.indexDelay=t.startDelay+t.startIndex})),O=Math.max(0,Math.max(...G.map((t=>t.melody.length))));let e=k[M].update();t.onMutate&&t.onMutate(e),M++,M>=k.length&&(M=0),w++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),e>p&&(Tone.Transport.stop(),h=!1,j())}function R(t){I&&L.triggerAttackRelease("c4","4n",t,.1);let e=A.random;for(let n=0;n<G.length;n++){const a=G[n];if(!(a.count>a.countEnd)){for(let n=0;n<a.countNum;n++){if(a.count<a.startDelay)continue;if(a.count%1!=0&&!a.doubler)continue;const o=a.melody[Math.floor(a.count-a.indexDelay)%a.len];if(o){if(null!==o[0]){const[s,r]=o;let l=n?Tone.Time(`${a.noteDuration}n`).toSeconds()*n:0;a.sampler.triggerAttackRelease(s,r,t+l,e)}a.doublerCounter&&(a.count+=a.counter)}else console.log(o),console.log(a.melody,a.count,a.indexDelay,a.len),console.log("no beat loop",a)}(!a.doublerCounter||a.count<a.startDelay)&&(a.count+=a.counter)}}e+=E.random,e.clamp(.1,1),B++,B===O&&$()}function N(){const t=(new Tone.FMSynth).toDestination();return U(t),D&&t.connect(r),t}function P(){const e=w<3?"U":n("AEIOU".split("")),o={};for(let t=0;t<d.length;t++){const n=d[t];o[n]=a.get(`${e}-${n}`)}const s=new Tone.Sampler({urls:o,volume:t.volume||0,release:1}).toDestination();return U(s),D&&s.connect(r),s}function U(t){if(o(T.reverbChance)){const e=new Tone.Reverb({decay:T.reverbDecay}).toDestination();t.connect(e)}if(w>=T.fxDelay){let e;if(o(T.distortionChance)){const t=n(...T.distortion);e=new Tone.Distortion(t).toDestination()}else if(o(T.bitCrushChance)){const t=n(T.bitCrushBits.start);e=new Tone.BitCrusher(t).toDestination()}e&&t.connect(e)}}async function j(){const t=await r.stop(),e=URL.createObjectURL(t),n=document.createElement("a"),a=prompt("Name clip","Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));n.download=a+".webm",n.href=e,n.click()}t.autoLoad&&_(),this.moveTonic=function(t){let e=l.indexOf(v)+t;v=l[e]},this.setTonic=function(t){v=t},this.printLoops=function(){console.log("loops",G)},this.moveBPM=function(t){let e=Tone.Transport.bpm.value;Tone.Transport.bpm.value=e+t},this.setBPM=function(t){Tone.Transport.bpm.value=t},this.getIsPlaying=function(){return h},this.play=function(){if(!t.autoLoad)return _();"stopped"===Tone.Transport.state&&$(),h=!0,D&&r.start()},this.stop=function(){Tone.Transport.stop(),h=!1,D&&j()},this.mutate=function(){k.forEach((t=>{t.update()}))}},MIDI_NOTES:l,doodooDefaults:f,doodooDefaultParams:m};window.doodooLib=e.default})();
//# sourceMappingURL=doodoo.min.js.map