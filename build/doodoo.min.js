(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function n(t,e){return e?Math.random()*(e-t)+t:"number"==typeof t?Math.random()*t:Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:"object"==typeof t?t[n(Object.keys(t))]:void 0}function o(t){let e,n,o=t.length;for(;0!==o;)n=Math.floor(Math.random()*o),o-=1,e=t[o],t[o]=t[n],t[n]=e;return t}function a(t){return n(1)<t}t.d(e,{default:()=>g});class s{constructor(t,e,n,o){this.min=t,this.max=void 0===e?t:e,n&&(this.ch1=n||.5),o&&(this.ch2=o||.5)}update(){a(Math.abs(this.ch1))&&this.min<this.max&&(this.min+=Math.sign(this.ch1)),a(Math.abs(this.ch2))&&(this.max+=Math.sign(this.ch2))}get range(){return[this.min,this.max]}get random(){return n(...this.range)}get randInt(){return function(t,e){return e||(e=t,t=0),Math.round(Math.random()*(e-t)+t)}(...this.range)}}class r{constructor(t,e,n){this.values=t,this.addValues=e||[],this.chance=n||.5}add(t){this.values.push(t)}update(){a(this.chance)&&this.addValues.length>0&&this.values.push(this.addValues.pop())}get random(){return n(this.values)}}const c=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"],i=[12,83];function l(t){for(;t<i[0];)t+=12;for(;t>i[1];)t-=12;return t}function u(t,e,n,o){return t.map((a=>{const[s,r]=a;if(null===s)return a;{const a=c.indexOf(s)-c.indexOf(t[0][0]);let i=12*Math.floor(Math.abs(a)/12)*(a<0?-1:1),u=a<0?o.indexOf(12-Math.abs(a)%12):o.indexOf(a%12),h=o[(u+n-1)%o.length],d=c.indexOf(e)+h+i;return[c[l(d)],r]}}))}function h(t,e,o){let c=0;const i=new s(...e.loopNums),l=new r(e.harmonies.start,e.harmonies.add,e.harmonies.chance),u=new s(...e.startIndexes),h=new s(...e.indexStep),d=new r(e.durations.start,e.durations.add,e.durations.chance),p=new r(e.startDelays.start,e.startDelays.add,e.startDelays.chance);this.getTestLoops=function(){return[{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:0},{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:4}]},this.getLoops=function(){const e=[],o=i.randInt;let s=u.randInt,r=0;for(let c=0;c<o;c++){let o=d.random;e.push({noteDuration:o,count:0,counter:o<4?o/4:1,doubler:o>4&&o<32&&a(.5),doublerCounter:o>4&&a(.4),repeat:o>9?n([2,3,4]):1,startIndex:s,startDelay:r,melody:t,harmony:a(.6)?l.random:0}),s=Math.max(0,n([s,s+h.min,s+h.max])),r=p.random}return e},this.update=function(){return function(){if(i.update(),l.update(),u.update(),h.update(),d.update(),p.update(),a(e.sliceChance)){let o=n(t.length),a=t.slice(o,o+n(e.sliceLength));t.push(...a)}a(e.shiftChance)&&t.length>e.shiftLength&&t.shift(),c++,o&&console.log(`${c} mutations`)}(),c}}let d=[{key:"attackStart",value:[.25,.7],type:"range",range:[0,1],step:[.05]},{key:"attackStep",value:[-.2,.2],type:"range",range:[-1,1],step:[.05]},{key:"loopNums",type:"range",value:[1,1,.1,.2],range:[1,32,0,1],step:[1,.01]},{key:"harmonies",type:"list",start:[4,5],add:[2,3,6,7],chance:.2,shuffle:!0},{key:"startIndexes",type:"range",value:[0,0,0,.3],range:[0,0,0,1],step:[1,.01]},{key:"indexStep",type:"range",value:[0,0,-.2,.2],range:[0,8,-1,1],step:[1,.01]},{key:"durations",type:"list",start:[2,4],add:[1,8,16,32],chance:.3},{key:"startDelays",type:"list",start:[0,1,2,4,.5,8],add:[12,16,3,5,7,11],chance:.3},{key:"sliceChance",type:"chance",value:.1},{key:"sliceLength",type:"int",value:3,range:[1,8]},{key:"shiftChance",type:"chance",value:.2},{key:"shiftLength",type:"int",value:16,range:[0,32]}],p={};d.forEach((t=>{const{key:e,type:n}=t;switch(n){case"range":case"chance":case"int":p[e]=t.value;break;case"list":p[e]={start:t.start,add:t.shuffle?o(t.add):t.add,chance:t.chance}}}));const f={params:d,defaults:p},m=f.defaults,y=f.params;Number.prototype.clamp=function(t,e){return Math.min(Math.max(this,t),e)};const g={Doodoo:function(t,e){let o,r,i,d=!1,p=[],f=t.debug,y=t.samples||"synth",g=t.startDuration||"4n",D=t.withRecording;D&&(r=new Tone.Recorder,i=+prompt("Record number of mutations?",10));const T=t.scale||[0,2,4,5,7,9,11];let b="string"==typeof t.tonic?t.tonic:c[t.tonic],C=t.params,w={...m,...C};console.log("defaults",w);let v=[];if("string"===t.parts[0]){const e=t.parts.map((t=>[t,g]));v.push(new h(e,w,f))}else if("number"==typeof t.parts[0]){const e=t.parts.map((t=>[c[t],g]));v.push(new h(e,w,f))}else if(Array.isArray(t.parts[0])){const e=t.parts;v.push(new h(e,w,f));const n=t.parts.map((t=>parseInt(t[1])));g=Math.max(...n)+"n"}let A=0,M=0;const x=new s(...w.attackStart),k=new s(...w.attackStep);let F,E=[];const G=t.useMetro;let O;async function I(){await Tone.start(),"synth"!==y?function(e){p=[2,3,4].flatMap((t=>"ABCDEFG".split("").map((e=>`${e}${t}`))));let n={};for(let t=0;t<p.length;t++)"AEIOU".split("").forEach((e=>{const o=p[t];n[`${e}-${o}`]=`${e}/CH-${e}${e}-${o}.mp3`}));console.time("load choir samples"),o=new Tone.ToneAudioBuffers({urls:n,baseUrl:t.samples||"./doodoo/samples/choir/",onload:()=>{console.timeEnd("load choir samples"),e()}})}(B):B()}function B(){e&&e(),F=new Tone.Loop(_,g),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),F.start(0),L(),G&&(O=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),d=!0,D&&r.start()}function L(){E=[],v[A].getLoops().forEach((t=>{const e={...t,melody:0===t.harmony?(n=t.melody,o=b,n.map((t=>{const[e,a]=t;if(null===e)return t;{let t=c.indexOf(o)+(c.indexOf(e)-c.indexOf(n[0][0]));return[c[l(t)],a]}}))):u(t.melody,b,t.harmony,T),sampler:"synth"!==y?$():S(),attack:x.random,ended:!1};var n,o;E.push(e)})),E.forEach((t=>{let e=[];t.melody.forEach((t=>{const[n,o]=t;let a=+g[0]/+o[0];e.push(t);for(let t=1;t<a;t++)e.push([null,g])})),t.melody=e})),console.log("loops",E);let e=v[A].update();t.onMutate&&t.onMutate(e),A++,A>=v.length&&(A=0),M++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),e>i&&(Tone.Transport.stop(),d=!1,R())}function _(t){G&&O.triggerAttackRelease("c4","4n",t,.3);let e=x.random;for(let n=0;n<E.length;n++){const o=E[n],{melody:a,noteDuration:s,sampler:r,counter:c,doubler:i,doublerCounter:l,repeat:u,startIndex:h,startDelay:d}=E[n];if(o.count>(a.length-1)*u+d&&(o.ended=!0),!o.ended){let u=i?c*s/4:1;for(let p=0;p<u;p++)if(o.count>=d&&(o.count%1==0||i)){const i=a[Math.floor(o.count-d+h)%a.length];if(!i){console.log("beat",i,h),console.log("loop",n,o);continue}if(null!==i[0]){const[n,o]=i;let a=p?Tone.Time(`${s}n`).toSeconds()*p:0;r.triggerAttackRelease(n,o,t+a,e)}l&&(o.count+=c)}(!l||o.count<d)&&(o.count+=c)}}E.every((t=>t.ended))?L():(e+=k.random,e.clamp(.1,1))}function S(){const t=(new Tone.FMSynth).toDestination();return D&&t.connect(r),t}function $(){const t=M<3?"U":n("AEIOU".split("")),e={};for(let n=0;n<p.length;n++){const a=p[n];e[a]=o.get(`${t}-${a}`)}const s=new Tone.Sampler({urls:e,volume:-6,release:1}).toDestination(),c=new Tone.Reverb({decay:5}).toDestination();if(s.connect(c),M>8){let t;if(a(.25)){const e=n(.05,.2);t=new Tone.Distortion(e).toDestination()}else if(a(.25))t=new Tone.Chorus(6,2.5,.5);else if(a(.25)){const e=n([4,8,12]);t=new Tone.BitCrusher(e).toDestination()}else if(a(.25)){const e=n(.5,1),o=n(.1,1);t=new Tone.Tremolo(e,o).toDestination()}t&&s.connect(t)}return D&&s.connect(r),s}async function R(){const t=await r.stop(),e=URL.createObjectURL(t),n=document.createElement("a"),o=prompt("Name clip","Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));n.download=o+".webm",n.href=e,n.click()}t.autoLoad&&I(),this.moveTonic=function(t){let e=c.indexOf(b)+t;b=c[e],b=c[e]},this.setTonic=function(t){b=t},this.printLoops=function(){console.log("loops",E)},this.moveBPM=function(t){let e=Tone.Transport.bpm.value;Tone.Transport.bpm.value=e+t},this.setBPM=function(t){Tone.Transport.bpm.value=t},this.getIsPlaying=function(){return d},this.play=function(){if(!t.autoLoad)return I();"stopped"===Tone.Transport.state&&L(),d=!0,D&&r.start()},this.stop=function(){Tone.Transport.stop(),d=!1,D&&R()},this.mutate=function(){v.forEach((t=>{t.update()}))}},MIDI_NOTES:c,doodooDefaults:m,doodooParams:y};window.doodooLib=e.default})();
//# sourceMappingURL=doodoo.min.js.map