(()=>{"use strict";var t={d:(n,o)=>{for(var e in o)t.o(o,e)&&!t.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:o[e]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n)},n={};function o(t,n){return n?Math.random()*(n-t)+t:"number"==typeof t?Math.random()*t:Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:"object"==typeof t?t[o(Object.keys(t))]:void 0}function e(t){return o(1)<t}t.d(n,{default:()=>h});class r{constructor(t,n){this.min=t,this.max=void 0===n?t:n}update(t,n){e(Math.abs(t))&&this.min<this.max&&(this.min+=Math.sign(t)),e(Math.abs(n))&&(this.max+=Math.sign(n))}get range(){return[this.min,this.max]}get random(){return o(...this.range)}get randInt(){return function(t,n){return n||(n=t,t=0),Math.round(Math.random()*(n-t)+t)}(...this.range)}}class a{constructor(t,n){this.values=t,this.addValues=n||[]}add(t){this.values.push(t)}update(t){e(t)&&this.addValues.length>0&&this.values.push(this.addValues.pop())}get random(){return o(this.values)}}const s=["C_1","C#_1","D_1","D#_1","E_1","F_1","F#_1","G_1","G#_1","A_1","A#_1","B_1","C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8","C#8","D8","D#8","E8","F8","F#8","G8","G#8","A8","A#8","B8","C9","C#9","D9","D#9","E9","F9","F#9","G9"],l=[12,83];function i(t){for(;t<l[0];)t+=12;for(;t>l[1];)t-=12;return t}function u(t,n){console.log("get",t);const o=t.map((o=>{const[e,r]=o;if(null===e)return o;{console.log(e,s.indexOf(e));let o=s.indexOf(n)+(s.indexOf(e)-s.indexOf(t[0][0]));return[s[i(o)],r]}}));return console.log("got",o),o}function c(t,n,o,e){return t.map((r=>{const[a,l]=r;if(null===a)return r;{const r=s.indexOf(a)-s.indexOf(t[0][0]);let u=12*Math.floor(Math.abs(r)/12)*(r<0?-1:1),c=r<0?e.indexOf(12-Math.abs(r)%12):e.indexOf(r%12),d=e[(c+o-1)%e.length],h=s.indexOf(n)+d+u;return[s[i(h)],l]}}))}function d(t,n){let s=0;const l=new r(1),i=new a([4,5],function(t){let n,o,e=t.length;for(;0!==e;)o=Math.floor(Math.random()*e),e-=1,n=t[e],t[e]=t[o],t[o]=n;return t}([2,3,6,7])),u=new r(0),c=new r(0),d=new a([2,4],[1,8,16,32]),h=new a([0,1,2,4,.5,8],[12,16,3,5,7,11]),p=[[{noteDuration:8,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:0}],[{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:0},{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:4}]];this.getTestLoops=function(){return[{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:0},{noteDuration:4,count:0,counter:1,doubler:!1,doublerCounter:!1,repeat:1,startIndex:0,startDelay:0,melody:t,harmony:4}]},this.getLoops=function(){if(p[s])return p[s];const n=[],r=1==s?2:l.randInt;let a=u.randInt,f=0;for(let s=0;s<r;s++){let r=d.random;n.push({noteDuration:r,count:0,counter:r<4?r/4:1,doubler:r>4&&r<32&&e(.5),doublerCounter:r>4&&e(.4),repeat:r>9?o([2,3,4]):1,startIndex:a,startDelay:f,melody:t,harmony:e(.6)?i.random:0}),a=Math.max(0,o([a,a+c.min,a+c.max])),f=h.random}return n},this.update=function(){!function(){if(l.update(.1,.2),i.update(.2),u.update(0,.3),c.update(-.2,.2),d.update(.3),h.update(.3),e(.1)){let n=o(t.length),e=t.slice(n,n+o(3));t.push(...e)}e(.2)&&t.length>16&&t.shift(),s++,n&&console.log(`${s} mutations`)}()}}Number.prototype.clamp=function(t,n){return Math.min(Math.max(this,t),n)};const h={Doodoo:function(t,n){this.isPlaying=!1;let a,l=[];const i=t.samples;let h=t.startDuration||"4n";const p=t.scale||[0,2,4,5,7,9,11];let f="string"==typeof t.tonic?t.tonic:s[t.tonic];const m=("string"==typeof t.parts[0]?[t.parts]:t.parts).map((t=>{let n;return"string"==typeof t[0]&&(n=t.map((t=>[t,h]))),"number"==typeof t[0]&&(n=t.map((t=>[s[t],h]))),"object"==typeof t[0]&&(n=t),console.log(n),new d(n,!1)}));let y=0,g=0;const D=new r(.25,.7),b=new r(-.2,.2);let C,T=[];function A(){n&&n(),C=new Tone.Loop(F,h),Tone.Transport.start(),C.start(0),x(),console.log(this),this.isPlaying=!0}function x(){T=[],m[y].getLoops().forEach((t=>{const n={...t,melody:0===t.harmony?u(t.melody,f):c(t.melody,f,t.harmony,p),sampler:i?M():(new Tone.FMSynth).toDestination(),attack:D.random,ended:!1};T.push(n)})),T.forEach((t=>{let n=[];t.melody.forEach((t=>{const[o,e]=t;let r=+h[0]/+e[0];n.push(t);for(let t=1;t<r;t++)n.push([null,h])})),t.melody=n})),m[y].update(),y++,y>=m.length&&(y=0),g++,"stopped"===Tone.Transport.state&&Tone.Transport.start()}function F(t){let n=D.random;for(let o=0;o<T.length;o++){const e=T[o],{melody:r,noteDuration:a,sampler:s,counter:l,doubler:i,doublerCounter:u,repeat:c,startIndex:d,startDelay:h}=T[o];if(e.count>(r.length-1)*c+h&&(e.ended=!0),!e.ended){let c=i?l*a/4:1;for(let p=0;p<c;p++)if(e.count>=h&&(e.count%1==0||i)){const i=r[Math.floor(e.count-h+d)%r.length];if(!i){console.log("beat",i,d),console.log("loop",o,e);continue}if(null!==i[0]){const[o,e]=i;let r=p?Tone.Time(`${a}n`).toSeconds()*p:0;s.triggerAttackRelease(o,e,t+r,n)}u&&(e.count+=l)}(!u||e.count<h)&&(e.count+=l)}}T.every((t=>t.ended))?x():(n+=b.random,n.clamp(.1,1))}function M(){const t=g<3?"U":o("AEIOU".split("")),n={};for(let o=0;o<l.length;o++){const e=l[o];n[e]=a.get(`${t}-${e}`)}const r=new Tone.Sampler({urls:n,volume:-6,release:1}).toDestination(),s=new Tone.Reverb({decay:5}).toDestination();if(r.connect(s),g>8){let t;if(e(.25)){const n=o(.05,.2);t=new Tone.Distortion(n).toDestination()}else if(e(.25))t=new Tone.Chorus(6,2.5,.5);else if(e(.25)){const n=o([4,8,12]);t=new Tone.BitCrusher(n).toDestination()}else if(e(.25)){const n=o(.5,1),e=o(.1,1);t=new Tone.Tremolo(n,e).toDestination()}t&&r.connect(t)}return r}console.log("tonic",f),(async()=>{await Tone.start(),console.log("async",this),i?function(n){l=[2,3,4].flatMap((t=>"ABCDEFG".split("").map((n=>`${n}${t}`))));let o={};for(let t=0;t<l.length;t++)"AEIOU".split("").forEach((n=>{const e=l[t];o[`${n}-${e}`]=`${n}/CH-${n}${n}-${e}.mp3`}));console.time("load choir samples"),a=new Tone.ToneAudioBuffers({urls:o,baseUrl:t.samples||"./doodoo/samples/choir/",onload:()=>{console.timeEnd("load choir samples"),n()}})}(A):A()})(),this.moveTonic=function(t){let n=s.indexOf(f)+t;f=s[n]},this.setTonic=function(t){f=t},this.printLoops=function(){console.log("loops",T)},this.moveBPM=function(t){let n=Tone.Transport.bpm.value;Tone.Transport.bpm.value=n+t},this.setBPM=function(t){Tone.Transport.bpm.value=t},this.play=function(){"stopped"===Tone.Transport.state&&x(),this.isPlaying=!0},this.stop=function(){Tone.Transport.stop(),this.isPlaying=!1},this.mutate=function(){m.forEach((t=>{t.update()}))}}};window.doodooLib=n.default})();
//# sourceMappingURL=doodoo.min.js.map