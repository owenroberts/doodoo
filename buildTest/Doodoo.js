!function(){"use strict";window.Doodoo=function(t,n){let e,o=t.debug,a=!1,r=t.duration||"4n",s=t.scale||[0,2,4,5,7,9,11],c=void 0===t.autoStart||t.autoStart,i=void 0===t.autoLoad||t.autoStart,l=t.voices||[t.samples];0===l.length&&l.push("FMSynth");let u,p=t.withRecording,m=t.withCount;p&&(u=new Tone.Recorder,m||(m=+prompt("Record number of mutations?",10)));let f="string"==typeof t.tonic?t.tonic:MIDI_NOTES[t.tonic];t.transform||(t.transform=t.tonic);let d="string"==typeof t.transform?t.transform:MIDI_NOTES[t.transform],h={...defaults,...t.controls},T=new Effects(h),y=[];if("string"==typeof t.parts[0]){const n=t.parts.map((t=>[t,r]));y.push(new Part(n,h,r,o))}else if("number"==typeof t.parts[0]){const n=t.parts.map((t=>[MIDI_NOTES[t],r]));y.push(new Part(n,h,r,o))}else if(Array.isArray(t.parts[0]))if(Array.isArray(t.parts[0][0]))for(let n=0;n<t.parts.length;n++){const e=t.parts[n];y.push(new Part(e,h,r,o));const a=t.parts[n].map((t=>parseInt(t[1])));r=Math.max(...a)+"n"}else{const n=t.parts;y.push(new Part(n,h,r,o));const e=t.parts.map((t=>parseInt(t[1])));r=Math.max(...e)+"n"}let g=0,D=0,w=t.simultaneous||!1;const S=new ValueRange(...h.attackStart),E=new ValueRange(...h.attackStep),M=new ValueRange(...h.restChance);let v,$=[],I=0,b=0;const R=t.useMetro;let P;async function A(){try{await Tone.start(),O?function(n){let o=function(){let t={};return l.forEach((n=>{if("choir"===n)"AEIOU".split("").forEach((e=>{const o=SamplePaths["choir"+e];for(const a in o)t[`${n}-${e}-${a}`]=`${n}/${e}/${o[a]}`}));else for(const e in SamplePaths[n])t[`${n}-${e}`]=`${n}/${SamplePaths[n][e]}`})),t}();console.time(`load ${l.join(", ")}`),e=new Tone.ToneAudioBuffers({urls:o,baseUrl:t.samplesURL||"../samples/",onload:()=>{console.timeEnd(`load ${l.join(", ")}`),n&&n(),x=!0}})}(N):N()}catch(t){console.error("load tone error",t)}}let O=l.some((t=>!t.includes("Synth"))),x=!1,L=!1;function N(){n&&n(),v=new Tone.Loop(k,r),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),v.start(Tone.Transport.seconds),(c||L)&&U(),R&&(P=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),a=!0,p&&u.start()}function U(){b=0,$=[];let n=w?y:[y[g]];n.forEach((t=>{t.getLoops().forEach((t=>{const n={...t,melody:0===t.harmony?getMelody(t.melody,f,d):getHarmony(t.melody,f,d,t.harmony,s),voice:_(t.voice||random(l))};$.push(n)}))})),$.forEach((t=>{let n=[];t.melody.forEach((t=>{const[e,o]=t;let a=+r.slice(0,-1)/+o.slice(0,-1);o.includes(".")&&(a*=1.5),n.push(t);for(let t=1;t<a;t++)n.push([null,r])})),t.melody=n,t.countNum=t.doubler?t.counter*t.noteDuration/4:1,t.countEnd=(t.melody.length-1)*t.repeat+t.startDelay,t.len=t.melody.length})),I=Math.max(0,Math.max(...$.map((t=>t.melody.length))));let e=n.map((t=>t.update()))[0];t.onMutate&&t.onMutate(e),w||(g++,g>=y.length&&(g=0)),D++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),m&&e>m&&(Tone.Transport.stop(),a=!1,u&&C())}function k(t){R&&P.triggerAttackRelease("C4","4n",t,.1);let n=S.getRandom();for(let e=0;e<$.length;e++){const o=$[e];if(!(o.count>o.countEnd)){for(let e=0;e<o.countNum;e++){if(o.count<o.startDelay)continue;if(o.count%1!=0&&!o.doubler)continue;if(chance(M.getRandom()))continue;const a=o.melody[Math.floor(o.count-o.startDelay+o.startIndex)%o.len];if(null!==a[0]){const[r,s]=a;let c=e?Tone.Time(`${o.noteDuration}n`).toSeconds()*e:0;o.voice.triggerAttackRelease(r,s,t+c,n)}o.doublerCounter&&(o.count+=o.counter)}(!o.doublerCounter||o.count<o.startDelay)&&(o.count+=o.counter)}}var e,o,a;n+=E.getRandom(),e=n,o=.1,a=1,n=Math.min(Math.max(e,o),a),b++,b===I&&U()}function _(n){return n.includes("Synth")?function(){const n=new Tone.FMSynth({volume:t.volume||0});p?n.chain(Tone.Destination,u):n.toDestination();return T.get(D).forEach((t=>{p?t.chain(Tone.Destination,u):t.toDestination(),n.connect(t)})),n}():function(n){const o=function(t){const n={};if("choir"===t){const o=D<3?"U":random("AEIOU".split(""));for(const a in SamplePaths[t+o])n[a]=e.get(`${t}-${o}-${a}`)}else for(const o in SamplePaths[t])n[o]=e.get(`${t}-${o}`);return n}(n),a=new Tone.Sampler({urls:o,volume:t.volume||0,release:1});p?a.chain(Tone.Destination,u):a.toDestination();return T.get(D,n).forEach((t=>{p?t.chain(Tone.Destination,u):t.toDestination(),a.connect(t)})),a}(n)}async function C(){const n=await u.stop(),e=URL.createObjectURL(n),o=document.createElement("a"),a=prompt("Name clip",t.title||"Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));o.download=a+".webm",o.href=e,o.click()}return i&&A(),{play:function(){if(!i)return A();!O||x?(U(),v.start(Tone.Transport.seconds),a=!0,p&&u.start()):L=!0},stop:function(){Tone.Transport.stop(),v.stop(),a=!1,p&&"started"===u.state&&C()},mutate:function(){y.forEach((t=>{t.update()}))},moveTonic:function(t){let n=MIDI_NOTES.indexOf(d)+t;d=MIDI_NOTES[n]},setTonic:function(t){d=t},moveBPM:function(t){let n=Tone.Transport.bpm.value;Tone.Transport.bpm.value=n+t},setBPM:function(t){Tone.Transport.bpm.value=t},getIsPlaying:function(){return a},isRecording:function(){return!!u&&("started"===u.state||"paused"===u.state)},printLoops:function(){console.log("loops",$)},getLoops:function(){return $}}}}();
//# sourceMappingURL=src_maps/Doodoo.js.map
